{"version":3,"sources":["lib.js"],"names":["SFAbstractCrypto","bits","CryptoJS","lib","WordArray","random","toString","crypto","window","msCrypto","buf","Uint32Array","getRandomValues","idx","replace","c","r","v","d","Date","getTime","performance","now","uuid","Math","floor","ciphertextToAuth","contentCiphertext","encryptionKey","iv","authHash","authKey","requiresAuth","console","error","localAuthHash","SFJS","hmac256","keyData","enc","Hex","parse","ivData","decrypted","AES","decrypt","mode","CBC","padding","pad","Pkcs7","Utf8","text","key","encrypted","encrypt","salt","generateRandomKey","passphrase","PBKDF2","keySize","substring","length","btoa","base64String","atob","SHA256","SHA1","message","messageData","result","HmacSHA256","password","pw_salt","pw_cost","callback","generateSymmetricKeyPair","keys","pw","mk","ak","bind","cost","join","email","defaultPasswordGenerationCost","pw_nonce","sha1","pw_auth","calculateVerificationTag","SFCryptoJS","output","hasher","algo","SHA512","iterations","outputLength","splitLength","firstThird","slice","secondThird","thirdThird","subtleCrypto","subtle","SFCryptoWeb","stretchPassword","webCryptoImportKey","log","webCryptoDeriveBits","input","importKey","stringToArrayBuffer","name","then","catch","err","deriveBits","hash","arrayBufferToHexString","Uint8Array","string","TextEncoder","encoder","encode","unescape","encodeURIComponent","ArrayBuffer","bufView","i","strLen","charCodeAt","arrayBuffer","byteArray","hexString","nextHexByte","byteLength","SFItemTransformer","version","fullCiphertext","encryptText","item","params","item_key","generateRandomEncryptionKey","enc_item_key","_private_encryptString","ek","firstHalfOfKey","secondHalfOfKey","ciphertext","JSON","stringify","createContentJSONFromProperties","auth_hash","content","encryptionVersion","components","split","startsWith","base64Decode","encryptedItemKey","keyParams","encryptionComponentsFromString","errorDecrypting","decryptText","itemParams","items","throws","deleted","isString","String","decryptItem","e","Item","json_obj","updateFromJSON","observers","generateUUID","json","_","merge","created_at","updated_at","mapContentToLocalProperties","contentObject","dirty","notifyObserversOfChange","allReferencedObjects","forEach","reference","setDirty","observer","find","push","remove","contentObj","structureParams","references","referenceParams","omit","oldUUID","newUUID","newItem","sort","a","b","StandardFile","IEOrEdge","document","documentMode","test","navigator","userAgent"],"mappings":"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","file":"transpiled.js","sourcesContent":["/* Abstract class. Instantiate an instance of either SFCryptoJS (uses cryptojs) or SFCryptoWeb (uses web crypto) */\n\nclass SFAbstractCrypto {\n\n  generateRandomKey(bits) {\n    return CryptoJS.lib.WordArray.random(bits/8).toString();\n  }\n\n  generateUUID() {\n    var crypto = window.crypto || window.msCrypto;\n    if(crypto) {\n      var buf = new Uint32Array(4);\n      crypto.getRandomValues(buf);\n      var idx = -1;\n      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n          idx++;\n          var r = (buf[idx>>3] >> ((idx%8)*4))&15;\n          var v = c == 'x' ? r : (r&0x3|0x8);\n          return v.toString(16);\n      });\n    } else {\n      var d = new Date().getTime();\n      if(window.performance && typeof window.performance.now === \"function\"){\n        d += performance.now(); //use high-precision timer if available\n      }\n      var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n        var r = (d + Math.random()*16)%16 | 0;\n        d = Math.floor(d/16);\n        return (c=='x' ? r : (r&0x3|0x8)).toString(16);\n      });\n      return uuid;\n    }\n  }\n\n  decryptText({ciphertextToAuth, contentCiphertext, encryptionKey, iv, authHash, authKey} = {}, requiresAuth) {\n    if(requiresAuth && !authHash) {\n      console.error(\"Auth hash is required.\");\n      return;\n    }\n\n    if(authHash) {\n      var localAuthHash = SFJS.crypto.hmac256(ciphertextToAuth, authKey);\n      if(authHash !== localAuthHash) {\n        console.error(\"Auth hash does not match, returning null.\");\n        return null;\n      }\n    }\n    var keyData = CryptoJS.enc.Hex.parse(encryptionKey);\n    var ivData  = CryptoJS.enc.Hex.parse(iv || \"\");\n    var decrypted = CryptoJS.AES.decrypt(contentCiphertext, keyData, { iv: ivData,  mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });\n    return decrypted.toString(CryptoJS.enc.Utf8);\n  }\n\n  encryptText(text, key, iv) {\n    var keyData = CryptoJS.enc.Hex.parse(key);\n    var ivData  = CryptoJS.enc.Hex.parse(iv || \"\");\n    var encrypted = CryptoJS.AES.encrypt(text, keyData, { iv: ivData,  mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });\n    return encrypted.toString();\n  }\n\n  generateRandomEncryptionKey() {\n    var salt = SFJS.crypto.generateRandomKey(512);\n    var passphrase = SFJS.crypto.generateRandomKey(512);\n    return CryptoJS.PBKDF2(passphrase, salt, { keySize: 512/32 }).toString();\n  }\n\n  firstHalfOfKey(key) {\n    return key.substring(0, key.length/2);\n  }\n\n  secondHalfOfKey(key) {\n    return key.substring(key.length/2, key.length);\n  }\n\n  base64(text) {\n    return window.btoa(text);\n  }\n\n  base64Decode(base64String) {\n    return window.atob(base64String);\n  }\n\n  sha256(text) {\n    return CryptoJS.SHA256(text).toString();\n  }\n\n  sha1(text) {\n    return CryptoJS.SHA1(text).toString();\n  }\n\n  hmac256(message, key) {\n    var keyData = CryptoJS.enc.Hex.parse(key);\n    var messageData = CryptoJS.enc.Utf8.parse(message);\n    var result = CryptoJS.HmacSHA256(messageData, keyData).toString();\n    return result;\n  }\n\n  computeEncryptionKeysForUser({password, pw_salt, pw_cost} = {}, callback) {\n     this.generateSymmetricKeyPair({password: password, pw_salt: pw_salt, pw_cost: pw_cost}, function(keys){\n         callback({pw: keys[0], mk: keys[1], ak: keys[2]});\n       }.bind(this));\n   }\n\n  calculateVerificationTag(cost, salt, ak) {\n    return SFJS.crypto.hmac256([cost, salt].join(\":\"), ak);\n  }\n\n  generateInitialEncryptionKeysForUser({email, password} = {}, callback) {\n    var pw_cost = this.defaultPasswordGenerationCost();\n    var pw_nonce = this.generateRandomKey(512);\n    var pw_salt = this.sha1([email, pw_nonce].join(\":\"));\n    this.generateSymmetricKeyPair({email: email, password: password, pw_salt: pw_salt, pw_cost: pw_cost}, function(keys){\n      var ak = keys[2];\n      var pw_auth = this.calculateVerificationTag(pw_cost, pw_salt, ak);\n      callback({pw: keys[0], mk: keys[1], ak: ak}, {pw_auth: pw_auth, pw_salt: pw_salt, pw_cost: pw_cost});\n    }.bind(this));\n  }\n  \n}\n\nexport { SFAbstractCrypto }\n;class SFCryptoJS extends SFAbstractCrypto {\n\n  /** Generates two deterministic keys based on one input */\n  generateSymmetricKeyPair({password, pw_salt, pw_cost} = {}, callback) {\n    var output = CryptoJS.PBKDF2(password, pw_salt, { keySize: 768/32, hasher: CryptoJS.algo.SHA512, iterations: pw_cost }).toString();\n\n    var outputLength = output.length;\n    var splitLength = outputLength/3;\n    var firstThird = output.slice(0, splitLength);\n    var secondThird = output.slice(splitLength, splitLength * 2);\n    var thirdThird = output.slice(splitLength * 2, splitLength * 3);\n    callback([firstThird, secondThird, thirdThird])\n  }\n\n  defaultPasswordGenerationCost() {\n    return 3000;\n  }\n  \n }\n\n\nexport { SFCryptoJS }\n;var subtleCrypto = window.crypto ? window.crypto.subtle : null;\n\nclass SFCryptoWeb extends SFAbstractCrypto {\n\n  /**\n  Overrides\n  */\n  defaultPasswordGenerationCost() {\n    return 10000;\n  }\n\n  /** Generates two deterministic keys based on one input */\n  generateSymmetricKeyPair({password, pw_salt, pw_cost} = {}, callback) {\n   this.stretchPassword({password: password, pw_salt: pw_salt, pw_cost: pw_cost}, function(output){\n     var outputLength = output.length;\n     var splitLength = outputLength/3;\n     var firstThird = output.slice(0, splitLength);\n     var secondThird = output.slice(splitLength, splitLength * 2);\n     var thirdThird = output.slice(splitLength * 2, splitLength * 3);\n     callback([firstThird, secondThird, thirdThird])\n   })\n  }\n\n  /**\n  Internal\n  */\n\n  stretchPassword({password, pw_salt, pw_cost} = {}, callback) {\n\n   this.webCryptoImportKey(password, function(key){\n\n     if(!key) {\n       console.log(\"Key is null, unable to continue\");\n       callback(null);\n       return;\n     }\n\n     this.webCryptoDeriveBits({key: key, pw_salt: pw_salt, pw_cost: pw_cost}, function(key){\n       if(!key) {\n         callback(null);\n         return;\n       }\n\n       callback(key);\n\n     }.bind(this))\n   }.bind(this))\n  }\n\n  webCryptoImportKey(input, callback) {\n     subtleCrypto.importKey(\n      \"raw\",\n      this.stringToArrayBuffer(input),\n      {name: \"PBKDF2\"},\n      false,\n      [\"deriveBits\"]\n    )\n    .then(function(key){\n      callback(key);\n    })\n    .catch(function(err){\n      console.error(err);\n      callback(null);\n    });\n  }\n\n  webCryptoDeriveBits({key, pw_salt, pw_cost} = {}, callback) {\n     subtleCrypto.deriveBits(\n      {\n        \"name\": \"PBKDF2\",\n        salt: this.stringToArrayBuffer(pw_salt),\n        iterations: pw_cost,\n        hash: {name: \"SHA-512\"},\n      },\n      key,\n      768\n    )\n    .then(function(bits){\n      var key = this.arrayBufferToHexString(new Uint8Array(bits));\n      callback(key);\n    }.bind(this))\n    .catch(function(err){\n      console.error(err);\n      callback(null);\n    });\n  }\n\n  stringToArrayBuffer(string) {\n    // not available on Edge/IE\n\n    if(window.TextEncoder) {\n      var encoder = new TextEncoder(\"utf-8\");\n      var result = encoder.encode(string);\n      return result;\n    } else {\n      string = unescape(encodeURIComponent(string));\n      var buf = new ArrayBuffer(string.length);\n      var bufView = new Uint8Array(buf);\n      for (var i=0, strLen=string.length; i<strLen; i++) {\n        bufView[i] = string.charCodeAt(i);\n      }\n      return buf;\n    }\n  }\n\n  arrayBufferToHexString(arrayBuffer) {\n      var byteArray = new Uint8Array(arrayBuffer);\n      var hexString = \"\";\n      var nextHexByte;\n\n      for (var i=0; i<byteArray.byteLength; i++) {\n          nextHexByte = byteArray[i].toString(16);\n          if (nextHexByte.length < 2) {\n              nextHexByte = \"0\" + nextHexByte;\n          }\n          hexString += nextHexByte;\n      }\n      return hexString;\n  }\n}\n\nexport { SFCryptoWeb }\n;class SFItemTransformer {\n\n  static _private_encryptString(string, encryptionKey, authKey, uuid, version) {\n    var fullCiphertext, contentCiphertext;\n    if(version === \"001\") {\n      contentCiphertext = SFJS.crypto.encryptText(string, encryptionKey, null);\n      fullCiphertext = version + contentCiphertext;\n    } else {\n      var iv = SFJS.crypto.generateRandomKey(128);\n      contentCiphertext = SFJS.crypto.encryptText(string, encryptionKey, iv);\n      var ciphertextToAuth = [version, uuid, iv, contentCiphertext].join(\":\");\n      var authHash = SFJS.crypto.hmac256(ciphertextToAuth, authKey);\n      fullCiphertext = [version, authHash, uuid, iv, contentCiphertext].join(\":\");\n    }\n\n    return fullCiphertext;\n  }\n\n  static encryptItem(item, keys, version) {\n    var params = {};\n    // encrypt item key\n    var item_key = SFJS.crypto.generateRandomEncryptionKey();\n    if(version === \"001\") {\n      // legacy\n      params.enc_item_key = SFJS.crypto.encryptText(item_key, keys.mk, null);\n    } else {\n      params.enc_item_key = this._private_encryptString(item_key, keys.mk, keys.ak, item.uuid, version);\n    }\n\n    // encrypt content\n    var ek = SFJS.crypto.firstHalfOfKey(item_key);\n    var ak = SFJS.crypto.secondHalfOfKey(item_key);\n    var ciphertext = this._private_encryptString(JSON.stringify(item.createContentJSONFromProperties()), ek, ak, item.uuid, version);\n    if(version === \"001\") {\n      var authHash = SFJS.crypto.hmac256(ciphertext, ak);\n      params.auth_hash = authHash;\n    }\n\n    params.content = ciphertext;\n    return params;\n  }\n\n  static encryptionComponentsFromString(string, encryptionKey, authKey) {\n    var encryptionVersion = string.substring(0, 3);\n    if(encryptionVersion === \"001\") {\n      return {\n        contentCiphertext: string.substring(3, string.length),\n        encryptionVersion: encryptionVersion,\n        ciphertextToAuth: string,\n        iv: null,\n        authHash: null,\n        encryptionKey: encryptionKey,\n        authKey: authKey\n      }\n    } else {\n      let components = string.split(\":\");\n      return {\n        encryptionVersion: components[0],\n        authHash: components[1],\n        uuid: components[2],\n        iv: components[3],\n        contentCiphertext: components[4],\n        ciphertextToAuth: [components[0], components[2], components[3], components[4]].join(\":\"),\n        encryptionKey: encryptionKey,\n        authKey: authKey\n      }\n    }\n  }\n\n  static decryptItem(item, keys) {\n\n    if((item.content.startsWith(\"001\") || item.content.startsWith(\"002\")) && item.enc_item_key) {\n      // is encrypted, continue to below\n    } else {\n      // is base64 encoded\n      item.content = SFJS.crypto.base64Decode(item.content.substring(3, item.content.length))\n      return;\n    }\n\n    // decrypt encrypted key\n    var encryptedItemKey = item.enc_item_key;\n    var requiresAuth = true;\n    if(encryptedItemKey.startsWith(\"002\") === false) {\n      // legacy encryption type, has no prefix\n      encryptedItemKey = \"001\" + encryptedItemKey;\n      requiresAuth = false;\n    }\n    var keyParams = this.encryptionComponentsFromString(encryptedItemKey, keys.mk, keys.ak);\n\n    // return if uuid in auth hash does not match item uuid. Signs of tampering.\n    if(keyParams.uuid && keyParams.uuid !== item.uuid) {\n      item.errorDecrypting = true;\n      return;\n    }\n\n    var item_key = SFJS.crypto.decryptText(keyParams, requiresAuth);\n\n    if(!item_key) {\n      item.errorDecrypting = true;\n      return;\n    }\n\n    // decrypt content\n    var ek = SFJS.crypto.firstHalfOfKey(item_key);\n    var ak = SFJS.crypto.secondHalfOfKey(item_key);\n    var itemParams = this.encryptionComponentsFromString(item.content, ek, ak);\n\n    // return if uuid in auth hash does not match item uuid. Signs of tampering.\n    if(itemParams.uuid && itemParams.uuid !== item.uuid) {\n      item.errorDecrypting = true;\n      return;\n    }\n\n    if(!itemParams.authHash) {\n      // legacy 001\n      itemParams.authHash = item.auth_hash;\n    }\n\n    var content = SFJS.crypto.decryptText(itemParams, true);\n    if(!content) {\n      item.errorDecrypting = true;\n    }\n    item.content = content;\n  }\n\n  static decryptMultipleItems(items, keys, throws) {\n    for (var item of items) {\n     if(item.deleted == true) {\n       continue;\n     }\n\n     var isString = typeof item.content === 'string' || item.content instanceof String;\n     if(isString) {\n       try {\n         this.decryptItem(item, keys);\n       } catch (e) {\n         item.errorDecrypting = true;\n         if(throws) {\n           throw e;\n         }\n         console.log(\"Error decrypting item\", item, e);\n         continue;\n       }\n     }\n   }\n  }\n}\n\nwindow.SFItemTransformer = SFItemTransformer;\nexport { SFItemTransformer }\n;class Item {\n\n  constructor(json_obj) {\n\n    this.updateFromJSON(json_obj);\n\n    this.observers = [];\n\n    if(!this.uuid) {\n      this.uuid = SFJS.crypto.generateUUID();\n    }\n  }\n\n  static sortItemsByDate(items) {\n    items.sort(function(a,b){\n      return new Date(b.created_at) - new Date(a.created_at);\n    });\n  }\n\n  get contentObject() {\n    if(!this.content) {\n      return {};\n    }\n\n    if(this.content !== null && typeof this.content === 'object') {\n      // this is the case when mapping localStorage content, in which case the content is already parsed\n      return this.content;\n    }\n\n    try {\n      return JSON.parse(this.content);\n    } catch (e) {\n      console.log(\"Error parsing json\", e);\n      return {};\n    }\n  }\n\n  updateFromJSON(json) {\n    _.merge(this, json);\n\n    this.created_at = this.created_at ? new Date(this.created_at) : new Date();\n    this.updated_at = this.updated_at ? new Date(this.updated_at) : new Date();\n\n    if(json.content) {\n      this.mapContentToLocalProperties(this.contentObject);\n    }\n  }\n\n  setDirty(dirty) {\n    this.dirty = dirty;\n\n    if(dirty) {\n      this.notifyObserversOfChange();\n    }\n  }\n\n  markAllReferencesDirty() {\n    this.allReferencedObjects().forEach(function(reference){\n      reference.setDirty(true);\n    })\n  }\n  addObserver(observer, callback) {\n    if(!_.find(this.observers, observer)) {\n      this.observers.push({observer: observer, callback: callback});\n    }\n  }\n\n  removeObserver(observer) {\n    _.remove(this.observers, {observer: observer})\n  }\n\n  notifyObserversOfChange() {\n    for(var observer of this.observers) {\n      observer.callback(this);\n    }\n  }\n\n  mapContentToLocalProperties(contentObj) {\n\n  }\n\n  createContentJSONFromProperties() {\n    return this.structureParams();\n  }\n\n  referenceParams() {\n    // must override\n  }\n\n  structureParams() {\n    return {references: this.referenceParams()}\n  }\n\n  addItemAsRelationship(item) {\n    // must override\n  }\n\n  removeItemAsRelationship(item) {\n    // must override\n  }\n\n  isBeingRemovedLocally() {\n\n  }\n\n  removeAllRelationships() {\n    // must override\n    this.setDirty(true);\n  }\n\n  locallyClearAllReferences() {\n\n  }\n\n  mergeMetadataFromItem(item) {\n    _.merge(this, _.omit(item, [\"content\"]));\n  }\n\n  informReferencesOfUUIDChange(oldUUID, newUUID) {\n    // optional override\n  }\n\n  potentialItemOfInterestHasChangedItsUUID(newItem, oldUUID, newUUID) {\n    // optional override\n  }\n\n  allReferencedObjects() {\n    // must override\n    return [];\n  }\n\n  doNotEncrypt() {\n    return false;\n  }\n}\n\nwindow.Item = Item;\nexport { Item }\n;class StandardFile {\n  constructor() {\n    // detect IE8 and above, and edge.\n    // IE and Edge do not support pbkdf2 in WebCrypto, therefore we need to use CryptoJS\n    var IEOrEdge = document.documentMode || /Edge/.test(navigator.userAgent);\n\n    if(!IEOrEdge && (window.crypto && window.crypto.subtle)) {\n      this.crypto = new SFCryptoWeb();\n    } else {\n      this.crypto = new SFCryptoJS();\n    }\n  }\n}\n\nwindow.StandardFile = StandardFile;\nwindow.SFJS = new StandardFile()\n"]}