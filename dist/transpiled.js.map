{"version":3,"sources":["lib.js"],"names":["SFAlertManager","params","Promise","resolve","reject","window","alert","text","confirm","SFAuthManager","storageManager","httpManager","alertManager","timeout","DidSignOutEvent","WillSignInEvent","DidSignInEvent","$timeout","setTimeout","bind","eventHandlers","handler","push","_","pull","event","data","keys","_keys","setItem","mk","ak","clearAllData","_authParams","then","notifyEvent","getItem","JSON","parse","version","defaultProtocolVersion","getAuthParams","authParams","url","email","extraParams","requestUrl","getAbsolute","merge","response","console","error","message","locked","param","unlock","password","strictSignin","existingKeys","isLocked","lock","getAuthParamsForEmail","identifier","unlockAndResolve","pw_cost","SFJS","supportedVersions","includes","isVersionNewerThanLibraryVersion","isProtocolVersionOutdated","abort","title","confirmButtonText","catch","supportsPasswordDerivationCost","minimum","costMinimumForVersion","latestVersion","crypto","computeEncryptionKeysForUser","pw","postAbsolute","handleAuthResponse","generateInitialKeysAndAuthParamsForUser","results","current_server_pw","newKeys","newAuthParams","newServerPw","new_password","current_password","stringify","token","saveKeys","globalScope","global","SFHttpManager","jwtRequestHandler","request","setRequestHeader","onsuccess","onerror","httpRequest","verb","xmlhttp","XMLHttpRequest","onreadystatechange","readyState","responseText","e","status","Object","length","formatParams","open","setAuthHeadersForRequest","send","map","key","encodeURIComponent","join","SFMigrationManager","modelManager","syncManager","loadMigrations","addEventHandler","dataLoadedEvent","syncCompleteEvent","receivedLocalDataEvent","receivedSyncCompletedEvent","initialSync","clearCompletedMigrations","runPendingMigrations","getCompletedMigrations","completed","migrations","registeredMigrations","getPendingMigrations","pending","migration","items","allItems","item","content_type","runMigration","markMigrationCompleted","btoa","atob","_completed","rawCompleted","filter","indexOf","encode","name","log","SFModelManager","MappingSourceRemoteRetrieved","MappingSourceRemoteSaved","MappingSourceLocalSaved","MappingSourceLocalRetrieved","MappingSourceComponentRetrieved","MappingSourceDesktopInstalled","MappingSourceRemoteActionRetrieved","MappingSourceFileImport","isMappingSourceRetrieved","source","itemSyncObservers","itemsPendingRemoval","itemsHash","missedReferences","uuidChangeObservers","id","callback","oldItem","newItem","observer","createItem","generateUUID","uuid","informReferencesOfUUIDChange","informModelsOfUUIDChangeForItem","deleted","content","references","setDirty","mapResponseItemsToLocalModels","addItem","resolveReferencesForItem","notifyObserversOfUuidChange","oldUUID","newUUID","model","potentialItemOfInterestHasChangedItsUUID","notifySyncObserversOfModels","sourceKey","mapResponseItemsToLocalModelsOmittingFields","omitFields","models","processedObjects","modelsToNotifyObserversOf","json_obj","errorDecrypting","Array","isArray","findItem","updateFromJSON","dummy","contentType","unknownContentType","acceptableContentTypes","isDirtyItemPendingDelete","dirty","removeItemLocally","entries","index","missedRefs","popMissedReferenceStructsForObject","ref","for_item","didFinishSyncing","referenceId","objectId","object","toDelete","candidateKey","matches","split","markReferencesDirty","contentObject","updateLocalRelationships","slice","referencesIds","includeBlanks","referencesObjectResults","findItems","referencedItem","addItemAsRelationship","missingRefId","mappingKey","missedReferenceBuildKey","missedRef","reference_uuid","allRelevantItems","types","validItems","deletedItems","_callSyncObserverCallbackWithTimeout","dontNotifyObservers","itemClass","ContentTypeClassMapping","SFItem","itemResponse","dup","original","referencingObjects","referencingObject","conflict_of","copy","constructor","globalOnly","addItems","forEach","remove","find","removeAndDirtyAllRelationshipsForItem","reference","relationship","removeItemAsRelationship","hasRelationshipWithItem","dontUpdateClientDates","relevantItems","isBeingRemovedLocally","contentTypes","itemId","ids","predicate","itemsMatchingPredicates","predicates","filterItemsWithPredicates","satisfiesPredicate","externalItems","itemsToBeMapped","itemData","existing","createConflictedItem","isItemContentEqualWith","addConflictedItem","returnNullIfEmpty","getJSONDataForItems","all","itemParams","SFItemParams","paramsForExportFile","SessionHistoryPersistKey","SessionHistoryRevisionsKey","SessionHistoryAutoOptimizeKey","SFSessionHistoryManager","keyRequestHandler","loadFromDisk","addItemSyncObserver","addHistoryEntryForItem","persistableItemParams","updated_at","entry","historySession","addEntryForItem","autoOptimize","optimizeHistoryForItem","diskEnabled","diskTimeout","hasOwnProperty","cancel","clearTimeout","saveToDisk","historyForItem","clearItemHistory","clearAllHistory","removeItem","encryptionParams","auth_params","paramsForSync","syncParams","diskValue","historyValue","itemTransformer","decryptItem","SFHistorySession","autoOptimizeValue","SFStorageManager","value","saveModels","clear","clearAllModels","SFSyncManager","interval","KeyRequestLoadLocal","KeyRequestSaveLocal","KeyRequestLoadSaveAccount","$interval","setInterval","syncStatus","syncStatusObservers","_default_sf_server","getServerURL","Date","syncEvent","_initialDataLoaded","incrementalCallback","batchSize","getAllModels","total","current","processed","decryptNext","subitems","handleItemsResponse","processedSubitems","innerResolve","innerReject","offlineOnly","getActiveKeyInfo","info","paramsForLocalStorage","localError","syncStatusDidChange","writeItemsToLocalStorage","responseItems","didSyncModelsOffline","saved_items","alternateUUIDs","originalItems","alternateUUIDForItem","_syncToken","_cursorToken","_queuedCallbacks","allCallbacks","queuedCallbacks","eachCallback","clearQueuedCallbacks","checker","stopCheckingIfSyncIsTakingTooLong","secondsPassed","syncStart","warningThreshold","clearInterval","syncLocked","options","allDirtyItems","getDirtyItems","syncOpInProgress","force","repeatOnCompletion","offline","syncOffline","clearDirtyItems","isContinuationSync","needsMoreSync","beginCheckingIfSyncIsTakingTooLong","submitLimit","subItems","allRetreivedItems","allSavedItems","limit","additionalFields","itemsParams","dirtyCount","getSyncToken","sync_token","getCursorToken","cursor_token","getSyncURL","handleSyncSuccess","handleSyncError","errorResponse","statusCode","syncedItems","itemsToClearAsDirty","allSavedUUIDs","retrieved_items","candidate","retrieved","concat","retrievedCount","saved","unsaved","handleUnsavedItemsResponse","isInitialSync","setSyncToken","setCursorToken","sync","majorDataChangeThreshold","callQueuedCallbacks","retrievedItems","savedItems","unsavedItems","keyRequest","decryptMultipleItems","itemsWithErrorStatusChange","valueChanged","errorDecryptingValueChanged","erroredItems","mapping","tag","dateFormatter","appData","generateUUIDSync","json","created_at","enc_item_key","auth_hash","clientKeys","undefined","parsedContent","deepMerge","_client_updated_at","mapContentToLocalProperties","handleDeletedContent","contentObj","structureParams","dontUpdateClientDate","client_updated_at","hasRawClientUpdatedAtValue","setIsBeingReferencedBy","setIsNoLongerBeingReferencedBy","removeReferenceWithUuid","r","target","domain","setDomainDataItem","AppDomain","getDomainDataItem","getAppDataItem","otherItem","omit","obj","left","appDataKeysToIgnoreWhenCheckingContentEquality","keysToIgnoreWhenCheckingContentEquality","right","SFPredicate","ItemSatisfiesPredicate","dateToLocalizedString","date","Intl","DateTimeFormat","locale","navigator","languages","language","year","month","day","weekday","hour","minute","format","toDateString","toLocaleTimeString","setAppDataItem","a","b","mergeCopyArrays","objValue","srcValue","mergeWith","includeDeleted","forExportFile","__params","result","doNotEncrypt","encryptItem","encryptedParams","createContentJSONFromProperties","base64","pick","keypath","operator","array","pred","valueAtKeyPath","reduce","previous","predicateValue","DateFromString","falseyValues","NaN","startsWith","resolveIncludesPredicate","regex","RegExp","test","innerPredicate","fromArray","ObjectSatisfiesPredicate","string","comps","unit","offset","parseInt","setDate","getDate","setHours","getHours","itemUUIDToItemHistoryMapping","uuids","itemUUID","itemHistory","SFItemHistory","history","LargeItemEntryAmountThreshold","optimize","entryParams","createEntryForItem","setPreviousEntry","getLastEntry","historyItemClass","HistoryEntryClassMapping","SFItemHistoryEntry","prospectiveEntry","previousEntry","isSameAsEntry","keepEntries","isEntrySignificant","deltaSize","LargeEntryDeltaThreshold","processEntry","keep","splice","operationVector","significant","defaultContentKeyToDiffOn","textCharDiffLength","hasPreviousEntry","Math","abs","lhs","rhs","SFAbstractCrypto","DefaultPBKDF2Length","msCrypto","buf","Uint32Array","getRandomValues","idx","replace","c","v","toString","d","getTime","performance","now","random","floor","ciphertextToAuth","contentCiphertext","encryptionKey","iv","authHash","authKey","requiresAuth","hmac256","localAuthHash","keyData","CryptoJS","enc","Hex","ivData","decrypted","AES","decrypt","mode","CBC","padding","pad","Pkcs7","Utf8","encrypted","encrypt","bits","lib","WordArray","cost","generateRandomKey","salt","passphrase","pbkdf2","substring","toSolidBytes","match","p1","String","fromCharCode","base64String","SHA256","messageData","HmacSHA256","nonce","sha256","pw_salt","output","outputLength","splitLength","firstThird","secondThird","thirdThird","generateSalt","pw_nonce","generateSymmetricKeyPair","userKeys","defaultPasswordGenerationCost","SFCryptoJS","keySize","hasher","algo","SHA512","iterations","PBKDF2","subtleCrypto","subtle","SFCryptoWeb","webCryptoImportKey","webCryptoDeriveBits","extractable","generateKey","keyObject","exportKey","arrayBufferToHexString","Uint8Array","err","values","hexStringToArrayBuffer","ArrayBuffer","alg","keyBuffer","stringToArrayBuffer","textData","arrayBufferToBase64","cipher","base64ToArrayBuffer","arrayBufferToString","decoded","input","actions","hash","importKey","deriveBits","blob","Blob","f","FileReader","onload","readAsArrayBuffer","arrayBuffer","readAsText","byteArray","hexString","i","byteLength","nextHexByte","hex","bytes","substr","base64Decode","binary_string","len","charCodeAt","buffer","type","reader","evt","dataurl","readAsDataURL","keyHexData","sign","signature","SFItemTransformer","encryptText","fullCiphertext","authParamsString","generateItemEncryptionKey","item_key","_private_encryptString","firstHalfOfKey","ek","secondHalfOfKey","ciphertext","encryptionVersion","components","encryptedItemKey","keyParams","encryptionComponentsFromString","decryptText","throws","isString","StandardFile","cryptoInstance","IEOrEdge","document","documentMode","userAgent","libraryVersion","expirationDates","expired"],"mappings":";;;;;;;;;;;;;;;;;;;;IAAaA,c,WAAAA,c;;;;;;;;0FAECC,M;;;;;iDACH,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtCC,yBAAOC,KAAP,CAAaL,OAAOM,IAApB;AACAJ;AACD,iBAHM,C;;;;;;;;;;;;;;;;;;;4FAMKF,M;;;;;kDACL,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,sBAAGC,OAAOG,OAAP,CAAeP,OAAOM,IAAtB,CAAH,EAAgC;AAC9BJ;AACD,mBAFD,MAEO;AACLC;AACD;AACF,iBANM,C;;;;;;;;;;;;;;;;;;;;;AAUX;IAAcK,a,WAAAA,a;AAEZ,yBAAYC,cAAZ,EAA4BC,WAA5B,EAAyCC,YAAzC,EAAuDC,OAAvD,EAAgE;AAAA;;AAC9DJ,kBAAcK,eAAd,GAAgC,iBAAhC;AACAL,kBAAcM,eAAd,GAAgC,iBAAhC;AACAN,kBAAcO,cAAd,GAA+B,gBAA/B;;AAEA,SAAKL,WAAL,GAAmBA,WAAnB;AACA,SAAKD,cAAL,GAAsBA,cAAtB;AACA,SAAKE,YAAL,GAAoBA,gBAAgB,IAAIZ,cAAJ,EAApC;AACA,SAAKiB,QAAL,GAAgBJ,WAAWK,WAAWC,IAAX,CAAgBd,MAAhB,CAA3B;;AAEA,SAAKe,aAAL,GAAqB,EAArB;AACD;;;;oCAEeC,O,EAAS;AACvB,WAAKD,aAAL,CAAmBE,IAAnB,CAAwBD,OAAxB;AACA,aAAOA,OAAP;AACD;;;uCAEkBA,O,EAAS;AAC1BE,QAAEC,IAAF,CAAO,KAAKJ,aAAZ,EAA2BC,OAA3B;AACD;;;gCAEWI,K,EAAOC,I,EAAM;AAAA;AAAA;AAAA;;AAAA;AACvB,6BAAmB,KAAKN,aAAxB,8HAAuC;AAAA,cAA/BC,OAA+B;;AACrCA,kBAAQI,KAAR,EAAeC,QAAQ,EAAvB;AACD;AAHsB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAIxB;;;;4FAEcC,I;;;;;AACb,qBAAKC,KAAL,GAAaD,IAAb;;uBACM,KAAKjB,cAAL,CAAoBmB,OAApB,CAA4B,IAA5B,EAAkCF,KAAKG,EAAvC,C;;;;uBACA,KAAKpB,cAAL,CAAoBmB,OAApB,CAA4B,IAA5B,EAAkCF,KAAKI,EAAvC,C;;;;;;;;;;;;;;;;;;;4FAGMC,Y;;;;;;;AACZ,qBAAKJ,KAAL,GAAa,IAAb;AACA,qBAAKK,WAAL,GAAmB,IAAnB;;qBACGD,Y;;;;;kDACM,KAAKtB,cAAL,CAAoBsB,YAApB,GAAmCE,IAAnC,CAAwC,YAAM;AACnD,wBAAKC,WAAL,CAAiB1B,cAAcK,eAA/B;AACD,iBAFM,C;;;AAIP,qBAAKqB,WAAL,CAAiB1B,cAAcK,eAA/B;;;;;;;;;;;;;;;;;;;;;;;;;oBAKE,KAAKc,K;;;;;;uBACQ,KAAKlB,cAAL,CAAoB0B,OAApB,CAA4B,IAA5B,C;;;AAAXN,kB;;oBACAA,E;;;;;kDACK,I;;;+BAESA,E;;uBAAc,KAAKpB,cAAL,CAAoB0B,OAApB,CAA4B,IAA5B,C;;;;AAAhC,qBAAKR,K;AAASE,oB;AAAQC,oB;;;;kDAEjB,KAAKH,K;;;;;;;;;;;;;;;;;;;;;;;;;oBAIR,KAAKK,W;;;;;;uBACU,KAAKvB,cAAL,CAAoB0B,OAApB,CAA4B,aAA5B,C;;;AAAbV,oB;;AACJ,qBAAKO,WAAL,GAAmBI,KAAKC,KAAL,CAAWZ,IAAX,CAAnB;;;sBAGC,KAAKO,WAAL,IAAoB,CAAC,KAAKA,WAAL,CAAiBM,O;;;;;;uBACN,KAAKC,sBAAL,E;;;AAAjC,qBAAKP,WAAL,CAAiBM,O;;;kDAGZ,KAAKN,W;;;;;;;;;;;;;;;;;;;;;;;;;;uBAIK,KAAKN,IAAL,E;;;AAAbA,oB;;sBACDA,QAAQA,KAAKI,E;;;;;kDAEP,K;;;kDAEA,K;;;;;;;;;;;;;;;;;;;;;;;;;;uBAKc,KAAKU,aAAL,E;;;AAAnBC,0B;;sBACDA,cAAcA,WAAWH,O;;;;;kDACnBG,WAAWH,O;;;kDAGb,KAAKC,sBAAL,E;;;;;;;;;;;;;;;;;;;4FAGmBG,G,EAAKC,K,EAAOC,W;;;;;;;kDAC/B,IAAI3C,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,sBAAI0C,aAAaH,MAAM,cAAvB;AACA,yBAAKhC,WAAL,CAAiBoC,WAAjB,CAA6BD,UAA7B,EAAyCvB,EAAEyB,KAAF,CAAQ,EAACJ,OAAOA,KAAR,EAAR,EAAwBC,WAAxB,CAAzC,EAA+E,UAACI,QAAD,EAAc;AAC3F9C,4BAAQ8C,QAAR;AACD,mBAFD,EAEG,UAACA,QAAD,EAAc;AACfC,4BAAQC,KAAR,CAAc,2BAAd,EAA2CF,QAA3C;AACA,wBAAG,QAAOA,QAAP,yCAAOA,QAAP,OAAoB,QAAvB,EAAiC;AAC/BA,iCAAW,EAACE,OAAO,EAACC,SAAS,oEAAV,EAAR,EAAX;AACD;AACDjD,4BAAQ8C,QAAR;AACD,mBARD;AASD,iBAXM,C;;;;;;;;;;;;;;;;;;2BAcF;AACL,WAAKI,MAAL,GAAc,IAAd;AACD;;;6BAEQ;AACP,WAAKA,MAAL,GAAc,KAAd;AACD;;;+BAEU;AACT,aAAO,KAAKA,MAAL,IAAe,IAAtB;AACD;;;qCAEgBlD,O,EAASmD,K,EAAO;AAC/B,WAAKC,MAAL;AACApD,cAAQmD,KAAR;AACD;;;;8FAEWX,G,EAAKC,K,EAAOY,Q,EAAUC,Y,EAAcZ,W;;;;;;;mDACvC,IAAI3C,OAAJ;AAAA,uFAAY,mBAAOC,OAAP,EAAgBC,MAAhB;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mCAEQ,OAAKuB,IAAL,EAFR;;AAAA;AAEb+B,wCAFa;;AAAA,kCAGdA,gBAAgB,IAHF;AAAA;AAAA;AAAA;;AAIfvD,oCAAQ,EAACgD,OAAQ,EAACC,SAAS,0CAAV,EAAT,EAAR;AAJe;;AAAA;AAAA,iCAQd,OAAKO,QAAL,EARc;AAAA;AAAA;AAAA;;AASfxD,oCAAQ,EAACgD,OAAQ,EAACC,SAAS,4BAAV,EAAT,EAAR;AATe;;AAAA;;AAajB,mCAAKQ,IAAL;;AAEA,mCAAKzB,WAAL,CAAiB1B,cAAcM,eAA/B;;AAfiB;AAAA,mCAiBM,OAAK8C,qBAAL,CAA2BlB,GAA3B,EAAgCC,KAAhC,EAAuCC,WAAvC,CAjBN;;AAAA;AAiBbH,sCAjBa;;;AAmBjB;AACAA,uCAAWoB,UAAX,GAAwBlB,KAAxB;;AApBiB,iCAsBdF,WAAWS,KAtBG;AAAA;AAAA;AAAA;;AAuBf,mCAAKY,gBAAL,CAAsB5D,OAAtB,EAA+BuC,UAA/B;AAvBe;;AAAA;AAAA,kCA2Bd,CAACA,UAAD,IAAe,CAACA,WAAWsB,OA3Bb;AAAA;AAAA;AAAA;;AA4Bf,mCAAKD,gBAAL,CAAsB5D,OAAtB,EAA+B,EAACgD,OAAQ,EAACC,SAAS,4BAAV,EAAT,EAA/B;AA5Be;;AAAA;AAAA,gCAgCba,KAAKC,iBAAL,GAAyBC,QAAzB,CAAkCzB,WAAWH,OAA7C,CAhCa;AAAA;AAAA;AAAA;;AAkCf,gCAAG0B,KAAKG,gCAAL,CAAsC1B,WAAWH,OAAjD,CAAH,EAA8D;AAC5D;AACAa,wCAAU,8IAAV;AACD,6BAHD,MAGO;AACL;AACAA,wCAAU,+KAAV;AACD;AACD,mCAAKW,gBAAL,CAAsB5D,OAAtB,EAA+B,EAACgD,OAAO,EAACC,SAASA,OAAV,EAAR,EAA/B;AAzCe;;AAAA;AAAA,iCA6Cda,KAAKI,yBAAL,CAA+B3B,WAAWH,OAA1C,CA7Cc;AAAA;AAAA;AAAA;;AA8CXa,oCA9CW,iDA8C2CV,WAAWH,OA9CtD;AA+CX+B,iCA/CW,GA+CH,KA/CG;AAAA;AAAA,mCAgDT,OAAK1D,YAAL,CAAkBJ,OAAlB,CAA0B;AAC9B+D,qCAAO,eADuB;AAE9BhE,oCAAM6C,QAFwB;AAG9BoB,iDAAmB;AAHW,6BAA1B,EAIHC,KAJG,CAIG,YAAM;AACb,qCAAKV,gBAAL,CAAsB5D,OAAtB,EAA+B,EAACgD,OAAO,EAAR,EAA/B;AACAmB,sCAAQ,IAAR;AACD,6BAPK,CAhDS;;AAAA;AAAA,iCAwDZA,KAxDY;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA,gCA6DbL,KAAKS,8BAAL,CAAoChC,WAAWsB,OAA/C,CA7Da;AAAA;AAAA;AAAA;;AA8DXZ,qCA9DW,GA8DD,0GACd,yEADc,GAEd,4GAhEe;;AAiEf,mCAAKW,gBAAL,CAAsB5D,OAAtB,EAA+B,EAACgD,OAAO,EAACC,SAASA,SAAV,EAAR,EAA/B;AAjEe;;AAAA;AAqEbuB,mCArEa,GAqEHV,KAAKW,qBAAL,CAA2BlC,WAAWH,OAAtC,CArEG;;AAAA,kCAsEdG,WAAWsB,OAAX,GAAqBW,OAtEP;AAAA;AAAA;AAAA;;AAuEXvB,qCAvEW,GAuED,yHAvEC;;AAwEf,mCAAKW,gBAAL,CAAsB5D,OAAtB,EAA+B,EAACgD,OAAO,EAACC,SAASA,SAAV,EAAR,EAA/B;AAxEe;;AAAA;AAAA,iCA4EdK,YA5Ec;AAAA;AAAA;AAAA;;AA6Ef;AACIoB,yCA9EW,GA8EKZ,KAAK1B,OAAL,EA9EL;;AAAA,kCA+EZG,WAAWH,OAAX,KAAuBsC,aA/EX;AAAA;AAAA;AAAA;;AAgFTzB,qCAhFS,yFAgFqFyB,aAhFrF,uDAgFoJnC,WAAWH,OAhF/J;;AAiFb,mCAAKwB,gBAAL,CAAsB5D,OAAtB,EAA+B,EAACgD,OAAO,EAACC,SAASA,SAAV,EAAR,EAA/B;AAjFa;;AAAA;AAAA;AAAA,mCAsFAa,KAAKa,MAAL,CAAYC,4BAAZ,CAAyCvB,QAAzC,EAAmDd,UAAnD,CAtFA;;AAAA;AAsFbf,gCAtFa;AAwFbmB,sCAxFa,GAwFAH,MAAM,eAxFN;AAyFb1C,kCAzFa,GAyFJsB,EAAEyB,KAAF,CAAQ,EAACQ,UAAU7B,KAAKqD,EAAhB,EAAoBpC,OAAOA,KAA3B,EAAR,EAA2CC,WAA3C,CAzFI;;;AA2FjB,mCAAKlC,WAAL,CAAiBsE,YAAjB,CAA8BnC,UAA9B,EAA0C7C,MAA1C;AAAA,mGAAkD,mBAAOgD,QAAP;AAAA;AAAA;AAAA;AAAA;AAChD,+CAAKd,WAAL,CAAiB1B,cAAcO,cAA/B;AADgD;AAAA,+CAE1C,OAAKkE,kBAAL,CAAwBjC,QAAxB,EAAkCL,KAAlC,EAAyCD,GAAzC,EAA8CD,UAA9C,EAA0Df,IAA1D,CAF0C;;AAAA;AAGhD,+CAAKV,QAAL,CAAc;AAAA,iDAAM,OAAK8C,gBAAL,CAAsB5D,OAAtB,EAA+B8C,QAA/B,CAAN;AAAA,yCAAd;;AAHgD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+BAAlD;;AAAA;AAAA;AAAA;AAAA,iCAIG,UAACA,QAAD,EAAc;AACfC,sCAAQC,KAAR,CAAc,kBAAd,EAAkCF,QAAlC;AACA,kCAAG,QAAOA,QAAP,yCAAOA,QAAP,OAAoB,QAAvB,EAAiC;AAC/BA,2CAAW,EAACE,OAAO,EAACC,SAAS,oEAAV,EAAR,EAAX;AACD;AACD,qCAAKnC,QAAL,CAAc;AAAA,uCAAM,OAAK8C,gBAAL,CAAsB5D,OAAtB,EAA+B8C,QAA/B,CAAN;AAAA,+BAAd;AACD,6BAVD;;AA3FiB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAAZ;;AAAA;AAAA;AAAA;AAAA,oB;;;;;;;;;;;;;;;;;;6BAyGAN,G,EAAKC,K,EAAOY,Q,EAAU;AAAA;;AAC7B,aAAO,IAAItD,OAAJ;AAAA,6EAAY,mBAAOC,OAAP,EAAgBC,MAAhB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,uBAEd,OAAKuD,QAAL,EAFc;AAAA;AAAA;AAAA;;AAGfxD,0BAAQ,EAACgD,OAAQ,EAACC,SAAS,+BAAV,EAAT,EAAR;AAHe;;AAAA;;AAOjB,yBAAKQ,IAAL;;AAPiB;AAAA,yBASGK,KAAKa,MAAL,CAAYK,uCAAZ,CAAoDvC,KAApD,EAA2DY,QAA3D,CATH;;AAAA;AASb4B,yBATa;AAUbzD,sBAVa,GAUNyD,QAAQzD,IAVF;AAWbe,4BAXa,GAWA0C,QAAQ1C,UAXR;AAabI,4BAba,GAaAH,MAAM,OAbN;AAcb1C,wBAda,GAcJsB,EAAEyB,KAAF,CAAQ,EAACQ,UAAU7B,KAAKqD,EAAhB,EAAoBpC,OAAOA,KAA3B,EAAR,EAA2CF,UAA3C,CAdI;;;AAgBjB,yBAAK/B,WAAL,CAAiBsE,YAAjB,CAA8BnC,UAA9B,EAA0C7C,MAA1C;AAAA,yFAAkD,mBAAOgD,QAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qCAC1C,OAAKiC,kBAAL,CAAwBjC,QAAxB,EAAkCL,KAAlC,EAAyCD,GAAzC,EAA8CD,UAA9C,EAA0Df,IAA1D,CAD0C;;AAAA;AAEhD,qCAAKoC,gBAAL,CAAsB5D,OAAtB,EAA+B8C,QAA/B;;AAFgD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qBAAlD;;AAAA;AAAA;AAAA;AAAA,uBAGG,UAACA,QAAD,EAAc;AACfC,4BAAQC,KAAR,CAAc,oBAAd,EAAoCF,QAApC;AACA,wBAAG,QAAOA,QAAP,yCAAOA,QAAP,OAAoB,QAAvB,EAAiC;AAC/BA,iCAAW,EAACE,OAAO,EAACC,SAAS,qEAAV,EAAR,EAAX;AACD;AACD,2BAAKW,gBAAL,CAAsB5D,OAAtB,EAA+B8C,QAA/B;AACD,mBATD;;AAhBiB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAAZ;;AAAA;AAAA;AAAA;AAAA,UAAP;AA2BD;;;;8FAEoBN,G,EAAKC,K,EAAOyC,iB,EAAmBC,O,EAASC,a;;;;;;;mDACpD,IAAIrF,OAAJ;AAAA,uFAAY,mBAAOC,OAAP,EAAgBC,MAAhB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,iCAEd,OAAKuD,QAAL,EAFc;AAAA;AAAA;AAAA;;AAGfxD,oCAAQ,EAACgD,OAAQ,EAACC,SAAS,sCAAV,EAAT,EAAR;AAHe;;AAAA;;AAOjB,mCAAKQ,IAAL;;AAEI4B,uCATa,GASCF,QAAQN,EATT;AAWblC,sCAXa,GAWAH,MAAM,iBAXN;AAYb1C,kCAZa,GAYJsB,EAAEyB,KAAF,CAAQ,EAACyC,cAAcD,WAAf,EAA4BE,kBAAkBL,iBAA9C,EAAR,EAA0EE,aAA1E,CAZI;;;AAcjB,mCAAK5E,WAAL,CAAiBsE,YAAjB,CAA8BnC,UAA9B,EAA0C7C,MAA1C;AAAA,mGAAkD,mBAAOgD,QAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+CAC1C,OAAKiC,kBAAL,CAAwBjC,QAAxB,EAAkCL,KAAlC,EAAyC,IAAzC,EAA+C2C,aAA/C,EAA8DD,OAA9D,CAD0C;;AAAA;AAEhD,+CAAKvB,gBAAL,CAAsB5D,OAAtB,EAA+B8C,QAA/B;;AAFgD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+BAAlD;;AAAA;AAAA;AAAA;AAAA,iCAGG,UAACA,QAAD,EAAc;AACf,kCAAG,QAAOA,QAAP,yCAAOA,QAAP,OAAoB,QAAvB,EAAiC;AAC/BA,2CAAW,EAACE,OAAO,EAACC,SAAS,qGAAV,EAAR,EAAX;AACD;AACD,qCAAKW,gBAAL,CAAsB5D,OAAtB,EAA+B8C,QAA/B;AACD,6BARD;;AAdiB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAAZ;;AAAA;AAAA;AAAA;AAAA,oB;;;;;;;;;;;;;;;;;;;8FA0BgBA,Q,EAAUL,K,EAAOD,G,EAAKD,U,EAAYf,I;;;;;qBACtDgB,G;;;;;;uBAAa,KAAKjC,cAAL,CAAoBmB,OAApB,CAA4B,QAA5B,EAAsCc,GAAtC,C;;;AAChB,qBAAKV,WAAL,GAAmBS,UAAnB;;uBACM,KAAKhC,cAAL,CAAoBmB,OAApB,CAA4B,aAA5B,EAA2CQ,KAAKsD,SAAL,CAAejD,UAAf,CAA3C,C;;;;uBACA,KAAKhC,cAAL,CAAoBmB,OAApB,CAA4B,KAA5B,EAAmCoB,SAAS2C,KAA5C,C;;;mDACC,KAAKC,QAAL,CAAclE,IAAd,C;;;;;;;;;;;;;;;;;;;;;AAGX,CAAC,IAAImE,cAAc,OAAOzF,MAAP,KAAkB,WAAlB,GAAgCA,MAAhC,GAA0C,OAAO0F,MAAP,KAAkB,WAAlB,GAAgCA,MAAhC,GAAyC,IAArG;;IAEYC,a,WAAAA,a;AAEX,yBAAYnF,OAAZ,EAAqB;AAAA;;AACnB;AACA,SAAKI,QAAL,GAAgBJ,WAAWK,WAAWC,IAAX,CAAgB2E,WAAhB,CAA3B;AACD;;;;yCAEoBzE,O,EAAS;AAC5B,WAAK4E,iBAAL,GAAyB5E,OAAzB;AACD;;;;8FAE8B6E,O;;;;;;;uBACX,KAAKD,iBAAL,E;;;AAAdL,qB;;AACJ,oBAAGA,KAAH,EAAU;AACRM,0BAAQC,gBAAR,CAAyB,eAAzB,EAA0C,YAAYP,KAAtD;AACD;;;;;;;;;;;;;;;;;;iCAGUjD,G,EAAK1C,M,EAAQmG,S,EAAWC,O,EAAS;AAC5C,WAAKC,WAAL,CAAiB,MAAjB,EAAyB3D,GAAzB,EAA8B1C,MAA9B,EAAsCmG,SAAtC,EAAiDC,OAAjD;AACD;;;kCAEa1D,G,EAAK1C,M,EAAQmG,S,EAAWC,O,EAAS;AAC7C,WAAKC,WAAL,CAAiB,OAAjB,EAA0B3D,GAA1B,EAA+B1C,MAA/B,EAAuCmG,SAAvC,EAAkDC,OAAlD;AACD;;;gCAEW1D,G,EAAK1C,M,EAAQmG,S,EAAWC,O,EAAS;AAC3C,WAAKC,WAAL,CAAiB,KAAjB,EAAwB3D,GAAxB,EAA6B1C,MAA7B,EAAqCmG,SAArC,EAAgDC,OAAhD;AACD;;;;8FAEiBE,I,EAAM5D,G,EAAK1C,M,EAAQmG,S,EAAWC,O;;;;;;AAE1CG,uB,GAAU,IAAIC,cAAJ,E;;;AAEdD,wBAAQE,kBAAR,GAA6B,YAAW;AACtC,sBAAIF,QAAQG,UAAR,IAAsB,CAA1B,EAA6B;AAC3B,wBAAI1D,WAAWuD,QAAQI,YAAvB;AACA,wBAAG3D,QAAH,EAAa;AACX,0BAAI;AACFA,mCAAWZ,KAAKC,KAAL,CAAWW,QAAX,CAAX;AACD,uBAFD,CAEE,OAAM4D,CAAN,EAAS,CAAE;AACd;;AAEF,wBAAGL,QAAQM,MAAR,IAAkB,GAAlB,IAAyBN,QAAQM,MAAR,IAAkB,GAA9C,EAAkD;AAChD,2BAAK7F,QAAL,CAAc,YAAU;AACtBmF,kCAAUnD,QAAV;AACD,uBAFD;AAGD,qBAJD,MAIO;AACLC,8BAAQC,KAAR,CAAc,gBAAd,EAAgCF,QAAhC;AACA,2BAAKhC,QAAL,CAAc,YAAU;AACtBoF,gCAAQpD,QAAR,EAAkBuD,QAAQM,MAA1B;AACD,uBAFD;AAGD;AACF;AACF,iBApB6B,CAoB5B3F,IApB4B,CAoBvB,IApBuB,CAA7B;;AAsBA,oBAAGoF,QAAQ,KAAR,IAAiBQ,OAAOpF,IAAP,CAAY1B,MAAZ,EAAoB+G,MAApB,GAA6B,CAAjD,EAAoD;AAClDrE,wBAAMA,MAAM,KAAKsE,YAAL,CAAkBhH,MAAlB,CAAZ;AACD;;AAEDuG,wBAAQU,IAAR,CAAaX,IAAb,EAAmB5D,GAAnB,EAAwB,IAAxB;;uBACM,KAAKwE,wBAAL,CAA8BX,OAA9B,C;;;AACNA,wBAAQL,gBAAR,CAAyB,cAAzB,EAAyC,kBAAzC;;AAEA,oBAAGI,QAAQ,MAAR,IAAkBA,QAAQ,OAA7B,EAAsC;AACpCC,0BAAQY,IAAR,CAAa/E,KAAKsD,SAAL,CAAe1F,MAAf,CAAb;AACD,iBAFD,MAEO;AACLuG,0BAAQY,IAAR;AACD;;;;;;;;;;;;;;;;;;iCAGUnH,M,EAAQ;AACnB,aAAO,MAAM8G,OACNpF,IADM,CACD1B,MADC,EAENoH,GAFM,CAEF,UAASC,GAAT,EAAa;AAChB,eAAOA,MAAI,GAAJ,GAAQC,mBAAmBtH,OAAOqH,GAAP,CAAnB,CAAf;AACD,OAJM,EAKNE,IALM,CAKD,GALC,CAAb;AAMD;;;;;;AAGH;IAAcC,kB,WAAAA,kB;AAEZ,8BAAYC,YAAZ,EAA0BC,WAA1B,EAAuCjH,cAAvC,EAAuD;AAAA;;AAAA;;AACrD,SAAKgH,YAAL,GAAoBA,YAApB;AACA,SAAKC,WAAL,GAAmBA,WAAnB;AACA,SAAKjH,cAAL,GAAsBA,cAAtB;;AAEA,SAAKkH,cAAL;;AAEA,SAAKD,WAAL,CAAiBE,eAAjB;AAAA,2EAAiC,mBAAOpG,KAAP,EAAcC,IAAd;AAAA;AAAA;AAAA;AAAA;AAAA;AAC3BoG,+BAD2B,GACTrG,SAAS,mBADA;AAE3BsG,iCAF2B,GAEPtG,SAAS,gBAFF;;AAAA,sBAI5BqG,mBAAmBC,iBAJS;AAAA;AAAA;AAAA;;AAK7B,oBAAGD,eAAH,EAAoB;AAClB,yBAAKE,sBAAL,GAA8B,IAA9B;AACD,iBAFD,MAEO,IAAGD,iBAAH,EAAsB;AAC3B,yBAAKE,0BAAL,GAAkC,IAAlC;AACD;;AAED;;AAX6B,sBAY1B,OAAKD,sBAAL,IAA+B,OAAKC,0BAZV;AAAA;AAAA;AAAA;;AAAA,sBAaxBvG,QAAQA,KAAKwG,WAbW;AAAA;AAAA;AAAA;;AAAA;AAAA,uBAgBnB,OAAKC,wBAAL,EAhBmB;;AAAA;AAkB3B,uBAAKC,oBAAL;;AAlB2B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAAjC;;AAAA;AAAA;AAAA;AAAA;AAsBD;;;;;;;;;;;;uBAGuB,KAAKC,sBAAL,E;;;AAAlBC,yB;;AACJA,0BAAUtB,MAAV,GAAmB,CAAnB;;;;;;;;;;;;;;;;;;qCAGe;AACf,WAAKuB,UAAL,GAAkB,KAAKC,oBAAL,EAAlB;AACD;;;2CAEsB;AACrB;AACA;AACA;AACD;;;;;;;;;;;;uBAGqB,KAAKC,oBAAL,E;;;AAAhBC,uB;;;AAEJ;AACA;;;;;AACA,kCAAqBA,OAArB,2HAA8B;AAAtBC,2BAAsB;;AAC5BA,4BAAUC,KAAV,GAAkB,EAAlB;AACD;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;6BACe,KAAKlB,YAAL,CAAkBmB,Q;;;;;;;;AAA1BC,oB;;;;;;AACN,kCAAqBJ,OAArB,2HAA8B;AAAtBC,2BAAsB;;AAC5B,sBAAGG,KAAKC,YAAL,IAAqBJ,UAAUI,YAAlC,EAAgD;AAC9CJ,8BAAUC,KAAV,CAAgBtH,IAAhB,CAAqBwH,IAArB;AACD;AACF;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGH,kCAAqBJ,OAArB,2HAA8B;AAAtBC,2BAAsB;;AAC5B,sBAAGA,UAAUC,KAAV,IAAmBD,UAAUC,KAAV,CAAgB5B,MAAhB,GAAyB,CAA/C,EAAkD;AAChD,yBAAKgC,YAAL,CAAkBL,SAAlB,EAA6BA,UAAUC,KAAvC;AACD,mBAFD,MAEO;AACL,yBAAKK,sBAAL,CAA4BN,SAA5B;AACD;AACF;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;2BAGIpI,I,EAAM;AACX,aAAOF,OAAO6I,IAAP,CAAY3I,IAAZ,CAAP;AACD;;;2BAEMA,I,EAAM;AACX,aAAOF,OAAO8I,IAAP,CAAY5I,IAAZ,CAAP;AACD;;;;;;;;;;oBAGK,KAAK6I,U;;;;;;uBACkB,KAAK1I,cAAL,CAAoB0B,OAApB,CAA4B,YAA5B,C;;;AAArBiH,4B;;AACJ,oBAAGA,YAAH,EAAiB;AACf,uBAAKD,UAAL,GAAkB/G,KAAKC,KAAL,CAAW+G,YAAX,CAAlB;AACD,iBAFD,MAEO;AACL,uBAAKD,UAAL,GAAkB,EAAlB;AACD;;;mDAEI,KAAKA,U;;;;;;;;;;;;;;;;;;;;;;;;;;;;uBAIU,KAAKf,sBAAL,E;;;AAAlBC,yB;mDACG,KAAKC,UAAL,CAAgBe,MAAhB,CAAuB,UAACX,SAAD,EAAe;AAC3C;AACA,yBAAOL,UAAUiB,OAAV,CAAkB,OAAKC,MAAL,CAAYb,UAAUc,IAAtB,CAAlB,KAAkD,CAAC,CAA1D;AACD,iBAHM,C;;;;;;;;;;;;;;;;;;;8FAMoBd,S;;;;;;;uBACL,KAAKN,sBAAL,E;;;AAAlBC,yB;;AACJA,0BAAUhH,IAAV,CAAe,KAAKkI,MAAL,CAAYb,UAAUc,IAAtB,CAAf;AACA,qBAAK/I,cAAL,CAAoBmB,OAApB,CAA4B,YAA5B,EAA0CQ,KAAKsD,SAAL,CAAe2C,SAAf,CAA1C;;;;;;;;;;;;;;;;;;;8FAGiBK,S,EAAWC,K;;;;;AAC5B1F,wBAAQwG,GAAR,CAAY,oBAAZ,EAAkCf,UAAUc,IAA5C;AACAd,0BAAUtH,OAAV,CAAkBuH,KAAlB;AACA,qBAAKK,sBAAL,CAA4BN,SAA5B;;;;;;;;;;;;;;;;;;;;;AAGJ;IAAcgB,c,WAAAA,c;AAEZ,0BAAY9I,OAAZ,EAAqB;AAAA;;AACnB8I,mBAAeC,4BAAf,GAA8C,8BAA9C;AACAD,mBAAeE,wBAAf,GAA0C,0BAA1C;AACAF,mBAAeG,uBAAf,GAAyC,yBAAzC;AACAH,mBAAeI,2BAAf,GAA6C,6BAA7C;AACAJ,mBAAeK,+BAAf,GAAiD,iCAAjD;AACAL,mBAAeM,6BAAf,GAA+C,+BAA/C,CANmB,CAM6D;AAChFN,mBAAeO,kCAAf,GAAoD,oCAApD,CAPmB,CAOuE;AAC1FP,mBAAeQ,uBAAf,GAAyC,yBAAzC;;AAEAR,mBAAeS,wBAAf,GAA0C,UAACC,MAAD,EAAY;AACpD,aAAO,CACLV,eAAeC,4BADV,EAELD,eAAeK,+BAFV,EAGLL,eAAeO,kCAHV,EAIL/F,QAJK,CAIIkG,MAJJ,CAAP;AAKD,KAND;;AAQA,SAAKpJ,QAAL,GAAgBJ,WAAWK,WAAWC,IAAX,CAAgBd,MAAhB,CAA3B;;AAEA,SAAKiK,iBAAL,GAAyB,EAAzB;AACA,SAAKC,mBAAL,GAA2B,EAA3B;AACA,SAAK3B,KAAL,GAAa,EAAb;AACA,SAAK4B,SAAL,GAAiB,EAAjB;AACA,SAAKC,gBAAL,GAAwB,EAAxB;AACA,SAAKC,mBAAL,GAA2B,EAA3B;AACD;;;;oCAEe;AACd,WAAK9B,KAAL,CAAW5B,MAAX,GAAoB,CAApB;AACA,WAAKwD,SAAL,GAAiB,EAAjB;AACA,WAAKD,mBAAL,CAAyBvD,MAAzB,GAAkC,CAAlC;AACA,WAAKyD,gBAAL,GAAwB,EAAxB;AACD;;;+CAE0BE,E,EAAIC,Q,EAAU;AACvC,WAAKF,mBAAL,CAAyBpJ,IAAzB,CAA8B,EAACqJ,IAAIA,EAAL,EAASC,UAAUA,QAAnB,EAA9B;AACD;;;gDAE2BC,O,EAASC,O,EAAS;AAAA;AAAA;AAAA;;AAAA;AAC5C,8BAAoB,KAAKJ,mBAAzB,mIAA8C;AAAA,cAAtCK,QAAsC;;AAC5CA,mBAASH,QAAT,CAAkBC,OAAlB,EAA2BC,OAA3B;AACD;AAH2C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAI7C;;;;8FAE0BhC,I;;;;;;AACzB;AACIgC,uB,GAAU,KAAKE,UAAL,CAAgBlC,IAAhB,C;;uBACO7E,KAAKa,MAAL,CAAYmG,YAAZ,E;;;AAArBH,wBAAQI,I;;;AAER;AACAJ,wBAAQK,4BAAR,CAAqCrC,KAAKoC,IAA1C,EAAgDJ,QAAQI,IAAxD;AACA,qBAAKE,+BAAL,CAAqCN,OAArC,EAA8ChC,KAAKoC,IAAnD,EAAyDJ,QAAQI,IAAjE;;AAEAhI,wBAAQwG,GAAR,CAAYZ,KAAKoC,IAAjB,EAAuB,KAAvB,EAA8BJ,QAAQI,IAAtC;;AAEA;AACApC,qBAAKuC,OAAL,GAAe,IAAf;AACAvC,qBAAKwC,OAAL,CAAaC,UAAb,GAA0B,EAA1B;AACA;AACA;AACA;AACA;AACA;AACAzC,qBAAK0C,QAAL,CAAc,KAAd;AACA,qBAAKC,6BAAL,CAAmC,CAAC3C,IAAD,CAAnC,EAA2Ca,eAAeG,uBAA1D;;AAEA;AACA,qBAAK4B,OAAL,CAAaZ,OAAb;AACAA,wBAAQU,QAAR,CAAiB,IAAjB;AACA,qBAAKG,wBAAL,CAA8Bb,OAA9B;;AAEA,qBAAKc,2BAAL,CAAiC9C,IAAjC,EAAuCgC,OAAvC;;mDAEOA,O;;;;;;;;;;;;;;;;;;oDAGuBA,O,EAASe,O,EAASC,O,EAAS;AACzD;AACA;AACA;;AAHyD;AAAA;AAAA;;AAAA;AAKzD,8BAAiB,KAAKlD,KAAtB,mIAA6B;AAAA,cAArBmD,KAAqB;;AAC3BA,gBAAMC,wCAAN,CAA+ClB,OAA/C,EAAwDe,OAAxD,EAAiEC,OAAjE;AACD;AAPwD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAQ1D;;;yCAEoBlD,K,EAAO;AAC1B,WAAKqD,2BAAL,CAAiCrD,KAAjC,EAAwCe,eAAeG,uBAAvD;AACD;;;kDAE6BlB,K,EAAOyB,M,EAAQ6B,S,EAAW;AACtD,aAAO,KAAKC,2CAAL,CAAiDvD,KAAjD,EAAwD,IAAxD,EAA8DyB,MAA9D,EAAsE6B,SAAtE,CAAP;AACD;;;gEAE2CtD,K,EAAOwD,U,EAAY/B,M,EAAQ6B,S,EAAW;AAChF,UAAIG,SAAS,EAAb;AAAA,UAAiBC,mBAAmB,EAApC;AAAA,UAAwCC,4BAA4B,EAApE;;AAEA;AAHgF;AAAA;AAAA;;AAAA;AAIhF,8BAAoB3D,KAApB,mIAA2B;AAAA,cAAnB4D,QAAmB;;AACzB,cAAG,CAACA,QAAJ,EAAc;AACZ;AACD;AACD,cAAG,CAAC,CAACA,SAASzD,YAAV,IAA0B,CAACyD,SAASlB,OAApC,IAA+C,CAACkB,SAAStB,IAA1D,KAAmE,CAACsB,SAASnB,OAA7E,IAAwF,CAACmB,SAASC,eAArG,EAAsH;AACpH;AACAvJ,oBAAQC,KAAR,CAAc,kCAAd,EAAkDqJ,QAAlD;AACA;AACD;;AAED;AACA;AACA,cAAGE,MAAMC,OAAN,CAAcP,UAAd,CAAH,EAA8B;AAAA;AAAA;AAAA;;AAAA;AAC5B,qCAAeA,UAAf,wIAA2B;AAAA,oBAAnB9E,GAAmB;;AACzB,uBAAOkF,SAASlF,GAAT,CAAP;AACD;AAH2B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAI7B;;AAED,cAAIwB,OAAO,KAAK8D,QAAL,CAAcJ,SAAStB,IAAvB,CAAX;;AAEA,cAAGpC,IAAH,EAAS;AACPA,iBAAK+D,cAAL,CAAoBL,QAApB;AACA;AACA1D,iBAAKgE,KAAL,GAAa,KAAb;AACD;;AAED,cAAG,KAAKvC,mBAAL,CAAyBpG,QAAzB,CAAkCqI,SAAStB,IAA3C,CAAH,EAAqD;AACnD3J,cAAEC,IAAF,CAAO,KAAK+I,mBAAZ,EAAiCiC,SAAStB,IAA1C;AACA;AACD;;AAED,cAAI6B,cAAcP,SAAS,cAAT,KAA6B1D,QAAQA,KAAKC,YAA5D;AACA,cAAIiE,qBAAqB,KAAKC,sBAAL,IAA+B,CAAC,KAAKA,sBAAL,CAA4B9I,QAA5B,CAAqC4I,WAArC,CAAzD;AACA,cAAGC,kBAAH,EAAuB;AACrB;AACD;;AAED,cAAIE,2BAA2B,KAA/B;AACA,cAAGV,SAASnB,OAAT,IAAoB,IAAvB,EAA6B;AAC3B,gBAAGmB,SAASW,KAAZ,EAAmB;AACjB;AACA;AACA;AACAD,yCAA2B,IAA3B;AACD,aALD,MAKO;AACL,kBAAGpE,IAAH,EAAS;AACPyD,0CAA0BjL,IAA1B,CAA+BwH,IAA/B;AACA,qBAAKsE,iBAAL,CAAuBtE,IAAvB;AACD;AACD;AACD;AACF;;AAED,cAAG,CAACA,IAAJ,EAAU;AACRA,mBAAO,KAAKkC,UAAL,CAAgBwB,QAAhB,EAA0B,IAA1B,CAAP;AACD;;AAED,eAAKd,OAAL,CAAa5C,IAAb,EAAmBoE,wBAAnB;;AAEA;AACA,cAAG,CAACpE,KAAK2D,eAAT,EAA0B;AACxBF,sCAA0BjL,IAA1B,CAA+BwH,IAA/B;AACD;;AAEDuD,iBAAO/K,IAAP,CAAYwH,IAAZ;AACAwD,2BAAiBhL,IAAjB,CAAsBkL,QAAtB;AACD;;AAED;AAxEgF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAyEhF,8BAA6BF,iBAAiBe,OAAjB,EAA7B,mIAAyD;AAAA;;AAAA;;AAAA,cAAhDC,KAAgD;AAAA,cAAzCd,SAAyC;;AACvD,cAAIT,QAAQM,OAAOiB,KAAP,CAAZ;AACA,cAAGd,UAASlB,OAAZ,EAAqB;AACnB,iBAAKK,wBAAL,CAA8BI,KAA9B;AACD;;AAED,cAAIwB,aAAa,KAAKC,kCAAL,CAAwChB,SAAxC,CAAjB;AANuD;AAAA;AAAA;;AAAA;AAOvD,mCAAee,UAAf,wIAA2B;AAAA,kBAAnBE,GAAmB;;AACzB,mBAAK9B,wBAAL,CAA8B8B,IAAIC,QAAlC;AACD;AATsD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAWvD3B,gBAAM4B,gBAAN;AACD;AArF+E;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAuFhF,WAAK1B,2BAAL,CAAiCM,yBAAjC,EAA4DlC,MAA5D,EAAoE6B,SAApE;;AAEA,aAAOG,MAAP;AACD;;;4CAEuBuB,W,EAAaC,Q,EAAU;AAC7C,aAAUD,WAAV,SAAyBC,QAAzB;AACD;;;uDAEkCC,M,EAAQ;AACzC,UAAI1I,UAAU,EAAd;AACA,UAAI2I,WAAW,EAAf;AAFyC;AAAA;AAAA;;AAAA;AAGzC,+BAAwBhH,OAAOpF,IAAP,CAAY,KAAK8I,gBAAjB,CAAxB,wIAA4D;AAAA,cAApDuD,YAAoD;;AAC1D,cAAIC,UAAUD,aAAaE,KAAb,CAAmB,GAAnB,EAAwB,CAAxB,KAA8BJ,OAAO5C,IAAnD;AACA,cAAG+C,OAAH,EAAY;AACV7I,oBAAQ9D,IAAR,CAAa,KAAKmJ,gBAAL,CAAsBuD,YAAtB,CAAb;AACAD,qBAASzM,IAAT,CAAc0M,YAAd;AACD;AACF;;AAED;AAXyC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAYzC,+BAAeD,QAAf,wIAAyB;AAAA,cAAjBzG,GAAiB;;AACvB,iBAAO,KAAKmD,gBAAL,CAAsBnD,GAAtB,CAAP;AACD;AAdwC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAgBzC,aAAOlC,OAAP;AACD;;;6CAEwB0D,I,EAAmC;AAAA,UAA7BqF,mBAA6B,uEAAP,KAAO;;;AAE1D;;AAEA,UAAIC,gBAAgBtF,KAAKsF,aAAzB;;AAEA;AACA;AACAtF,WAAKuF,wBAAL;;AAEA,UAAG,CAACD,cAAc7C,UAAlB,EAA8B;AAC5B;AACD;;AAED,UAAIA,aAAa6C,cAAc7C,UAAd,CAAyB+C,KAAzB,EAAjB,CAd0D,CAcP;;AAEnD,UAAIC,gBAAgBhD,WAAWlE,GAAX,CAAe,UAACoG,GAAD,EAAS;AAAC,eAAOA,IAAIvC,IAAX;AAAgB,OAAzC,CAApB;AACA,UAAIsD,gBAAgB,IAApB;AACA,UAAIC,0BAA0B,KAAKC,SAAL,CAAeH,aAAf,EAA8BC,aAA9B,CAA9B;;AAlB0D;AAAA;AAAA;;AAAA;AAoB1D,+BAAmCC,wBAAwBpB,OAAxB,EAAnC,wIAAsE;AAAA;;AAAA;;AAAA,cAA7DC,KAA6D;AAAA,cAAtDqB,cAAsD;;AACpE,cAAGA,cAAH,EAAmB;AACjB7F,iBAAK8F,qBAAL,CAA2BD,cAA3B;AACA,gBAAGR,mBAAH,EAAwB;AACtBQ,6BAAenD,QAAf,CAAwB,IAAxB;AACD;AACF,WALD,MAKO;AACL,gBAAIqD,eAAeN,cAAcjB,KAAd,CAAnB;AACA;AACA;AACA,gBAAIwB,aAAa,KAAKC,uBAAL,CAA6BF,YAA7B,EAA2C/F,KAAKoC,IAAhD,CAAjB;AACA,gBAAG,CAAC,KAAKT,gBAAL,CAAsBqE,UAAtB,CAAJ,EAAuC;AACrC,kBAAIE,YAAY,EAACC,gBAAgBJ,YAAjB,EAA+BnB,UAAU5E,IAAzC,EAAhB;AACA,mBAAK2B,gBAAL,CAAsBqE,UAAtB,IAAoCE,SAApC;AACD;AACF;AACF;AApCyD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAqC3D;;AAED;;;;gDAC4B3C,M,EAAQhC,M,EAAQ6B,S,EAAW;AAAA;;AAAA,iCAE7CnB,QAF6C;AAG/CmE,2BAAmBnE,SAASoE,KAAT,CAAehL,QAAf,CAAwB,GAAxB,IAA+BkI,MAA/B,GAAwCA,OAAO/C,MAAP,CAAc,UAACR,IAAD,EAAU;AAAC,iBAAOiC,SAASoE,KAAT,CAAehL,QAAf,CAAwB2E,KAAKC,YAA7B,CAAP;AAAkD,SAA3E,CAHZ;AAI/CqG,qBAAa,EAJkC;AAI9BC,uBAAe,EAJe;AAAA;AAAA;AAAA;;AAAA;AAKnD,iCAAgBH,gBAAhB,wIAAkC;AAAA,gBAA1BpG,IAA0B;;AAChC,gBAAGA,KAAKuC,OAAR,EAAiB;AACfgE,2BAAa/N,IAAb,CAAkBwH,IAAlB;AACD,aAFD,MAEO;AACLsG,yBAAW9N,IAAX,CAAgBwH,IAAhB;AACD;AACF;AAXkD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAanD,YAAGoG,iBAAiBlI,MAAjB,GAA0B,CAA7B,EAAgC;AAC9B,iBAAKsI,oCAAL,CAA0CvE,QAA1C,EAAoDmE,gBAApD,EAAsEE,UAAtE,EAAkFC,YAAlF,EAAgGhF,MAAhG,EAAwG6B,SAAxG;AACD;AAfkD;;AACrD;AADqD;AAAA;AAAA;;AAAA;AAErD,+BAAoB,KAAK5B,iBAAzB,wIAA4C;AAAA,cAApCS,QAAoC;AAAA,cACtCmE,gBADsC;AAAA,cAEtCE,UAFsC,EAErBC,YAFqB;;AAAA,gBAApCtE,QAAoC;AAc3C;AAhBoD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAiBtD;;AAED;;;;;;;yDAIqCA,Q,EAAUmE,gB,EAAkBE,U,EAAYC,Y,EAAchF,M,EAAQ6B,S,EAAW;AAC5G,WAAKjL,QAAL,CAAc,YAAM;AAClB8J,iBAASH,QAAT,CAAkBsE,gBAAlB,EAAoCE,UAApC,EAAgDC,YAAhD,EAA8DhF,MAA9D,EAAsE6B,SAAtE;AACD,OAFD;AAGD;;;+BAEUM,Q,EAAU+C,mB,EAAqB;AACxC,UAAIC,YAAY7F,eAAe8F,uBAAf,IAA0C9F,eAAe8F,uBAAf,CAAuCjD,SAASzD,YAAhD,CAA1D;AACA,UAAG,CAACyG,SAAJ,EAAe;AACbA,oBAAYE,MAAZ;AACD;AACD,UAAI5G,OAAO,IAAI0G,SAAJ,CAAchD,QAAd,CAAX;;AAEA;AACA;AACA;AACA;AACA;AACA,UAAG,CAAC+C,mBAAJ,EAAyB;AACvB,aAAKtD,2BAAL,CAAiC,CAACnD,IAAD,CAAjC,EAAyCa,eAAeG,uBAAxD;AACD;;AAED,aAAOhB,IAAP;AACD;;AAED;;;;;;;;;;yCAOqB6G,Y,EAAc;AACjC,UAAIC,MAAM,KAAK5E,UAAL,CAAgB2E,YAAhB,EAA8B,IAA9B,CAAV;AACA,aAAOC,GAAP;AACD;;;sCAEiBA,G,EAAKC,Q,EAAU;AAC/B,WAAKnE,OAAL,CAAakE,GAAb;AACA;AAF+B;AAAA;AAAA;;AAAA;AAG/B,+BAA6BC,SAASC,kBAAtC,wIAA0D;AAAA,cAAlDC,iBAAkD;;AACxDA,4BAAkBnB,qBAAlB,CAAwCgB,GAAxC;AACAG,4BAAkBvE,QAAlB,CAA2B,IAA3B;AACD;AAN8B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAO/B,WAAKG,wBAAL,CAA8BiE,GAA9B;AACAA,UAAII,WAAJ,GAAkBH,SAAS3E,IAA3B;AACA0E,UAAIpE,QAAJ,CAAa,IAAb;AACD;;;kCAEa1C,I,EAAM;AAClB,UAAImH,OAAO,IAAInH,KAAKoH,WAAT,CAAqB,EAAC5E,SAASxC,KAAKwC,OAAf,EAArB,CAAX;;AAEA,WAAKI,OAAL,CAAauE,IAAb;;AAEA;AALkB;AAAA;AAAA;;AAAA;AAMlB,+BAA6BnH,KAAKgH,kBAAlC,wIAAsD;AAAA,cAA9CC,iBAA8C;;AACpDA,4BAAkBnB,qBAAlB,CAAwCqB,IAAxC;AACAF,4BAAkBvE,QAAlB,CAA2B,IAA3B;AACD;AATiB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAUlB,WAAKG,wBAAL,CAA8BsE,IAA9B;AACAA,WAAKzE,QAAL,CAAc,IAAd;;AAEA,aAAOyE,IAAP;AACD;;;4BAEOnH,I,EAA0B;AAAA,UAApBqH,UAAoB,uEAAP,KAAO;;AAChC,WAAKC,QAAL,CAAc,CAACtH,IAAD,CAAd,EAAsBqH,UAAtB;AACD;;;6BAEQvH,K,EAA2B;AAAA;;AAAA,UAApBuH,UAAoB,uEAAP,KAAO;;AAClCvH,YAAMyH,OAAN,CAAc,UAACvH,IAAD,EAAU;AACtB,YAAG,CAAC,OAAK0B,SAAL,CAAe1B,KAAKoC,IAApB,CAAJ,EAA+B;AAC7B,iBAAKV,SAAL,CAAe1B,KAAKoC,IAApB,IAA4BpC,IAA5B;AACA,iBAAKF,KAAL,CAAWtH,IAAX,CAAgBwH,IAAhB;AACD;AACF,OALD;AAMD;;AAED;;;;wCACoB6B,E,EAAIwE,K,EAAOvE,Q,EAAU;AACvC,UAAG,CAAC8B,MAAMC,OAAN,CAAcwC,KAAd,CAAJ,EAA0B;AACxBA,gBAAQ,CAACA,KAAD,CAAR;AACD;AACD,WAAK7E,iBAAL,CAAuBhJ,IAAvB,CAA4B,EAACqJ,IAAIA,EAAL,EAASwE,OAAOA,KAAhB,EAAuBvE,UAAUA,QAAjC,EAA5B;AACD;;;2CAEsBD,E,EAAI;AACzBpJ,QAAE+O,MAAF,CAAS,KAAKhG,iBAAd,EAAiC/I,EAAEgP,IAAF,CAAO,KAAKjG,iBAAZ,EAA+B,EAACK,IAAIA,EAAL,EAA/B,CAAjC;AACD;;;oCAEe;AACd,aAAO,KAAK/B,KAAL,CAAWU,MAAX,CAAkB,UAACR,IAAD,EAAU;AACjC;AACA;AACA,eAAOA,KAAKqE,KAAL,IAAc,IAAd,IAAsB,CAACrE,KAAKgE,KAA5B,KAAsC,CAAChE,KAAK2D,eAAN,IAAyB3D,KAAKuC,OAApE,CAAP;AACD,OAJM,CAAP;AAKD;;;oCAEezC,K,EAAO;AAAA;AAAA;AAAA;;AAAA;AACrB,+BAAgBA,KAAhB,wIAAuB;AAAA,cAAfE,IAAe;;AACrBA,eAAK0C,QAAL,CAAc,KAAd;AACD;AAHoB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAItB;;;uCAEkB1C,I,EAAM;AACvBA,WAAKuC,OAAL,GAAe,IAAf;;AAEA,UAAG,CAACvC,KAAKgE,KAAT,EAAgB;AAAEhE,aAAK0C,QAAL,CAAc,IAAd;AAAsB;;AAExC,WAAKgF,qCAAL,CAA2C1H,IAA3C;AACD;;;0DAEqCA,I,EAAM;AAC1C;AAD0C;AAAA;AAAA;;AAAA;AAE1C,+BAAqBA,KAAKwC,OAAL,CAAaC,UAAlC,wIAA8C;AAAA,cAAtCkF,SAAsC;;AAC5C,cAAIC,eAAe,KAAK9D,QAAL,CAAc6D,UAAUvF,IAAxB,CAAnB;AACA,cAAGwF,YAAH,EAAiB;AACf5H,iBAAK6H,wBAAL,CAA8BD,YAA9B;AACA,gBAAGA,aAAaE,uBAAb,CAAqC9H,IAArC,CAAH,EAA+C;AAC7C4H,2BAAaC,wBAAb,CAAsC7H,IAAtC;AACA4H,2BAAalF,QAAb,CAAsB,IAAtB;AACD;AACF;AACF;;AAED;AAb0C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAc1C,+BAAkB1C,KAAKgH,kBAAvB,wIAA2C;AAAA,cAAnChC,MAAmC;;AACzCA,iBAAO6C,wBAAP,CAAgC7H,IAAhC;AACAgF,iBAAOtC,QAAP,CAAgB,IAAhB;AACD;AAjByC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAmB1C1C,WAAKgH,kBAAL,GAA0B,EAA1B;AACD;;AAED;;;;uCAC+C;AAAA,UAA9Be,qBAA8B,uEAAN,IAAM;;AAC7C,UAAIC,gBAAgB,KAAKjI,QAAzB;;AAD6C;AAAA;AAAA;;AAAA;AAG7C,+BAAgBiI,aAAhB,wIAA+B;AAAA,cAAvBhI,IAAuB;;AAC7BA,eAAK0C,QAAL,CAAc,IAAd,EAAoBqF,qBAApB;AACD;AAL4C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAM9C;;;sCAEiB/H,I,EAAM8B,Q,EAAU;AAChCrJ,QAAE+O,MAAF,CAAS,KAAK1H,KAAd,EAAqB,EAACsC,MAAMpC,KAAKoC,IAAZ,EAArB;AACA,aAAO,KAAKV,SAAL,CAAe1B,KAAKoC,IAApB,CAAP;;AAEApC,WAAKiI,qBAAL;;AAEA,WAAKxG,mBAAL,CAAyBjJ,IAAzB,CAA8BwH,KAAKoC,IAAnC;AACD;;AAED;;;;0CAQsB8F,Y,EAAc;AAClC,aAAO,KAAKnI,QAAL,CAAcS,MAAd,CAAqB,UAASR,IAAT,EAAc;AACxC,eAAO,CAACvH,EAAE4C,QAAF,CAAW6M,YAAX,EAAyBlI,KAAKC,YAA9B,KAA+CxH,EAAE4C,QAAF,CAAW6M,YAAX,EAAyB,GAAzB,CAAhD,KAAkF,CAAClI,KAAKgE,KAA/F;AACD,OAFM,CAAP;AAGD;;;mCAEc;AACb,aAAO,KAAKjE,QAAL,CAAcS,MAAd,CAAqB,UAACR,IAAD,EAAU;AACpC,eAAOA,KAAK2D,eAAZ;AACD,OAFM,CAAP;AAGD;;;6CAEwBM,W,EAAa;AACpC,aAAO,KAAKlE,QAAL,CAAcS,MAAd,CAAqB,UAACR,IAAD,EAAU;AACpC,eAAOA,KAAKC,YAAL,IAAqBgE,WAArB,IAAoC,CAACjE,KAAK2D,eAAjD;AACD,OAFM,CAAP;AAGD;;;6BAEQwE,M,EAAQ;AACf,aAAO,KAAKzG,SAAL,CAAeyG,MAAf,CAAP;AACD;;;8BAESC,G,EAA4B;AAAA,UAAvB1C,aAAuB,uEAAP,KAAO;;AACpC,UAAIpJ,UAAU,EAAd;AADoC;AAAA;AAAA;;AAAA;AAEpC,+BAAc8L,GAAd,wIAAmB;AAAA,cAAXvG,EAAW;;AACjB,cAAI7B,OAAO,KAAK0B,SAAL,CAAeG,EAAf,CAAX;AACA,cAAG7B,QAAQ0F,aAAX,EAA0B;AACxBpJ,oBAAQ9D,IAAR,CAAawH,IAAb;AACD;AACF;AAPmC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAQpC,aAAO1D,OAAP;AACD;;;2CAEsB+L,S,EAAW;AAChC,aAAO,KAAKC,uBAAL,CAA6B,CAACD,SAAD,CAA7B,CAAP;AACD;;;4CAEuBE,U,EAAY;AAClC,aAAO,KAAKC,yBAAL,CAA+B,KAAKzI,QAApC,EAA8CwI,UAA9C,CAAP;AACD;;;8CAEyBzI,K,EAAOyI,U,EAAY;AAC3C,UAAIjM,UAAUwD,MAAMU,MAAN,CAAa,UAACR,IAAD,EAAU;AAAA;AAAA;AAAA;;AAAA;AACnC,iCAAqBuI,UAArB,wIAAkC;AAAA,gBAA1BF,SAA0B;;AAChC,gBAAG,CAACrI,KAAKyI,kBAAL,CAAwBJ,SAAxB,CAAJ,EAAwC;AACtC,qBAAO,KAAP;AACD;AACF;AALkC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAMnC,eAAO,IAAP;AACD,OAPa,CAAd;;AASA,aAAO/L,OAAP;AACD;;AAGD;;;;;;gCAIYoM,a,EAAe;AACzB,UAAIC,kBAAkB,EAAtB;AADyB;AAAA;AAAA;;AAAA;AAEzB,+BAAoBD,aAApB,wIAAmC;AAAA,cAA3BE,QAA2B;;AACjC,cAAIC,WAAW,KAAK/E,QAAL,CAAc8E,SAASxG,IAAvB,CAAf;AACA,cAAGyG,YAAY,CAACA,SAASlF,eAAzB,EAA0C;AACxC;AACA;AACAiF,qBAASxG,IAAT,GAAgB,IAAhB;AACA,gBAAI0E,MAAM,KAAKgC,oBAAL,CAA0BF,QAA1B,CAAV;AACA,gBAAG,CAACA,SAASrG,OAAV,IAAqB,CAACsG,SAASE,sBAAT,CAAgCjC,GAAhC,CAAzB,EAA+D;AAC7D;AACA,mBAAKkC,iBAAL,CAAuBlC,GAAvB,EAA4B+B,QAA5B;AACAF,8BAAgBnQ,IAAhB,CAAqBsO,GAArB;AACD;AACF,WAVD,MAUO;AACL;AACA6B,4BAAgBnQ,IAAhB,CAAqBoQ,QAArB;AACA,gBAAGC,YAAYA,SAASlF,eAAxB,EAAyC;AACvCkF,uBAASlF,eAAT,GAA2B,KAA3B;AACD;AACF;AACF;AArBwB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAuBzB,UAAI7D,QAAQ,KAAK6C,6BAAL,CAAmCgG,eAAnC,EAAoD9H,eAAeQ,uBAAnE,CAAZ;AAvByB;AAAA;AAAA;;AAAA;AAwBzB,+BAAgBvB,KAAhB,wIAAuB;AAAA,cAAfE,IAAe;;AACrBA,eAAK0C,QAAL,CAAc,IAAd,EAAoB,IAApB;AACA1C,eAAKuC,OAAL,GAAe,KAAf;AACD;AA3BwB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AA6BzB,aAAOzC,KAAP;AACD;;;;8FAEyBjH,I,EAAMe,U,EAAYqP,iB;;;;;mDACnC,KAAKC,mBAAL,CAAyB,KAAKnJ,QAA9B,EAAwClH,IAAxC,EAA8Ce,UAA9C,EAA0DqP,iBAA1D,C;;;;;;;;;;;;;;;;;;;8FAGiBnJ,K,EAAOjH,I,EAAMe,U,EAAYqP,iB;;;;;mDAC1C7R,QAAQ+R,GAAR,CAAYrJ,MAAMvB,GAAN,CAAU,UAACyB,IAAD,EAAU;AACrC,sBAAIoJ,aAAa,IAAIC,YAAJ,CAAiBrJ,IAAjB,EAAuBnH,IAAvB,EAA6Be,UAA7B,CAAjB;AACA,yBAAOwP,WAAWE,mBAAX,EAAP;AACD,iBAHkB,CAAZ,EAGHlQ,IAHG,CAGE,UAAC0G,KAAD,EAAW;AAClB,sBAAGmJ,qBAAqBnJ,MAAM5B,MAAN,IAAgB,CAAxC,EAA2C;AACzC,2BAAO,IAAP;AACD;;AAED,sBAAItF,OAAO,EAACkH,OAAOA,KAAR,EAAX;;AAEA,sBAAGjH,IAAH,EAAS;AACP;AACAD,yBAAK,aAAL,IAAsBgB,UAAtB;AACD;;AAED,yBAAOL,KAAKsD,SAAL,CAAejE,IAAf,EAAqB,IAArB,EAA2B,CAA3B,CAA6B,kBAA7B,CAAP;AACD,iBAhBM,C;;;;;;;;;;;;;;;;;;wBAtGM;AACb,aAAO,KAAKkH,KAAL,CAAWU,MAAX,CAAkB,UAASR,IAAT,EAAc;AACrC,eAAO,CAACA,KAAKgE,KAAb;AACD,OAFM,CAAP;AAGD;;;;;;AAqHH,CAAC,IAAMuF,2BAA2B,wBAAjC;AACD,IAAMC,6BAA6B,0BAAnC;AACA,IAAMC,gCAAgC,6BAAtC;;IAEaC,uB,WAAAA,uB;AAEX,mCAAY9K,YAAZ,EAA0BhH,cAA1B,EAA0C+R,iBAA1C,EAA6DzB,YAA7D,EAA2EnQ,OAA3E,EAAoF;AAAA;;AAAA;;AAClF,SAAK6G,YAAL,GAAoBA,YAApB;AACA,SAAKhH,cAAL,GAAsBA,cAAtB;AACA,SAAKO,QAAL,GAAgBJ,WAAWK,WAAWC,IAAX,CAAgBd,MAAhB,CAA3B;;AAEA;AACA,SAAKoS,iBAAL,GAAyBA,iBAAzB;;AAEA,SAAKC,YAAL,GAAoBxQ,IAApB,CAAyB,YAAM;AAC7B,cAAKwF,YAAL,CAAkBiL,mBAAlB,CAAsC,iBAAtC,EAAyD3B,YAAzD,EAAuE,UAACnI,QAAD,EAAWuG,UAAX,EAAuBC,YAAvB,EAAqChF,MAArC,EAA6C6B,SAA7C,EAA2D;AAAA;AAAA;AAAA;;AAAA;AAChI,iCAAgBrD,QAAhB,wIAA0B;AAAA,gBAAlBC,IAAkB;;AACxB,gBAAI;AACF,sBAAK8J,sBAAL,CAA4B9J,IAA5B;AACD,aAFD,CAEE,OAAOjC,CAAP,EAAU;AACV3D,sBAAQwG,GAAR,CAAY,yDAAZ,EAAuE7C,CAAvE;AACD;AACF;AAP+H;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAQjI,OARD;AASD,KAVD;AAWD;;;;;;;;;;mDAIQ,KAAK4L,iBAAL,E;;;;;;;;;;;;;;;;;;2CAGc3J,I,EAAM;AAAA;;AAC3B,UAAI+J,wBAAwB;AAC1B3H,cAAMpC,KAAKoC,IADe;AAE1BnC,sBAAcD,KAAKC,YAFO;AAG1B+J,oBAAYhK,KAAKgK,UAHS;AAI1BxH,iBAASxC,KAAKwC;AAJY,OAA5B;;AAOA,UAAIyH,QAAQ,KAAKC,cAAL,CAAoBC,eAApB,CAAoCJ,qBAApC,CAAZ;;AAEA,UAAG,KAAKK,YAAR,EAAsB;AACpB,aAAKF,cAAL,CAAoBG,sBAApB,CAA2CrK,IAA3C;AACD;;AAED,UAAGiK,SAAS,KAAKK,WAAjB,EAA8B;AAC5B;AACA,YAAG,KAAKC,WAAR,EAAqB;AACnB,cAAG,KAAKpS,QAAL,CAAcqS,cAAd,CAA6B,QAA7B,CAAH,EAA2C;AACzC,iBAAKrS,QAAL,CAAcsS,MAAd,CAAqB,KAAKF,WAA1B;AACD,WAFD,MAEO;AACLG,yBAAa,KAAKH,WAAlB;AACD;AACF;AACD,aAAKA,WAAL,GAAmB,KAAKpS,QAAL,CAAc,YAAM;AACrC,kBAAKwS,UAAL;AACD,SAFkB,EAEhB,IAFgB,CAAnB;AAGD;AACF;;;mCAEc3K,I,EAAM;AACnB,aAAO,KAAKkK,cAAL,CAAoBU,cAApB,CAAmC5K,IAAnC,CAAP;AACD;;;;8FAEyBA,I;;;;;AACxB,qBAAKkK,cAAL,CAAoBW,gBAApB,CAAqC7K,IAArC;mDACO,KAAK2K,UAAL,E;;;;;;;;;;;;;;;;;;;;;;;;AAIP,qBAAKT,cAAL,CAAoBY,eAApB;mDACO,KAAKlT,cAAL,CAAoBmT,UAApB,CAA+BvB,0BAA/B,C;;;;;;;;;;;;;;;;;;;;;;;;AAIP,qBAAKc,WAAL,GAAmB,CAAC,KAAKA,WAAzB;;qBAEG,KAAKA,W;;;;;AACN,qBAAK1S,cAAL,CAAoBmB,OAApB,CAA4BwQ,wBAA5B,EAAsDhQ,KAAKsD,SAAL,CAAe,IAAf,CAAtD;AACA,qBAAK8N,UAAL;;;;;AAEA,qBAAK/S,cAAL,CAAoBmB,OAApB,CAA4BwQ,wBAA5B,EAAsDhQ,KAAKsD,SAAL,CAAe,KAAf,CAAtD;mDACO,KAAKjF,cAAL,CAAoBmT,UAApB,CAA+BvB,0BAA/B,C;;;;;;;;;;;;;;;;;;;;;;;;;;;oBAKL,KAAKc,W;;;;;;;;;uBAIoB,KAAKU,gBAAL,E;;;AAAzBA,gC;AAEA5B,0B,GAAa,IAAIC,YAAJ,CAAiB,KAAKa,cAAtB,EAAsCc,iBAAiBnS,IAAvD,EAA6DmS,iBAAiBC,WAA9E,C;;AACjB7B,2BAAW8B,aAAX,GAA2B9R,IAA3B,CAAgC,UAAC+R,UAAD,EAAgB;AAC9C;AACA,0BAAKvT,cAAL,CAAoBmB,OAApB,CAA4ByQ,0BAA5B,EAAwDjQ,KAAKsD,SAAL,CAAesO,UAAf,CAAxD;AACD,iBAHD;;;;;;;;;;;;;;;;;;;;;;;;;;uBAOsB,KAAKvT,cAAL,CAAoB0B,OAApB,CAA4BiQ,wBAA5B,C;;;AAAlB6B,yB;;AACJ,oBAAGA,SAAH,EAAc;AACZ,uBAAKd,WAAL,GAAmB/Q,KAAKC,KAAL,CAAW4R,SAAX,CAAnB;AACD;;;uBAEwB,KAAKxT,cAAL,CAAoB0B,OAApB,CAA4BkQ,0BAA5B,C;;;AAArB6B,4B;;qBACDA,Y;;;;;AACDA,+BAAe9R,KAAKC,KAAL,CAAW6R,YAAX,CAAf;;uBAC6B,KAAKL,gBAAL,E;;;AAAzBA,gC;;uBACE7P,KAAKmQ,eAAL,CAAqBC,WAArB,CAAiCF,YAAjC,EAA+CL,iBAAiBnS,IAAhE,C;;;AACFqR,8B,GAAiB,IAAIsB,gBAAJ,CAAqBH,YAArB,C;;AACrB,qBAAKnB,cAAL,GAAsBA,cAAtB;;;;;AAEA,qBAAKA,cAAL,GAAsB,IAAIsB,gBAAJ,EAAtB;;;;uBAG4B,KAAK5T,cAAL,CAAoB0B,OAApB,CAA4BmQ,6BAA5B,C;;;AAA1BgC,iC;;AACJ,oBAAGA,iBAAH,EAAsB;AACpB,uBAAKrB,YAAL,GAAoB7Q,KAAKC,KAAL,CAAWiS,iBAAX,CAApB;AACD,iBAFD,MAEO;AACL;AACA,uBAAKrB,YAAL,GAAoB,IAApB;AACD;;;;;;;;;;;;;;;;;;;;;;;;AAID,qBAAKA,YAAL,GAAoB,CAAC,KAAKA,YAA1B;;AAEA,oBAAG,KAAKA,YAAR,EAAsB;AACpB,uBAAKxS,cAAL,CAAoBmB,OAApB,CAA4B0Q,6BAA5B,EAA2DlQ,KAAKsD,SAAL,CAAe,IAAf,CAA3D;AACD,iBAFD,MAEO;AACL,uBAAKjF,cAAL,CAAoBmB,OAApB,CAA4B0Q,6BAA5B,EAA2DlQ,KAAKsD,SAAL,CAAe,KAAf,CAA3D;AACD;;;;;;;;;;;;;;;;;;;;;AAGL,C,CAAC;;IAEY6O,gB,WAAAA,gB;;;;;;;;;AAEX;;;8FAEclN,G,EAAKmN,K;;;;;;;;;;;;;;;;;;;;;8FAILnN,G;;;;;;;;;;;;;;;;;;;;;8FAIGA,G;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAQjB;;;;;;;;;;;;;;;;;;;;;;;;;;8FAQgBwB,I;;;;;mDACP,KAAK4L,UAAL,CAAgB,CAAC5L,IAAD,CAAhB,C;;;;;;;;;;;;;;;;;;;8FAGQF,K;;;;;;;;;;;;;;;;;;;;;8FAICE,I;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAQlB;;;;;;;;mDAGS5I,QAAQ+R,GAAR,CAAY,CACjB,KAAK0C,KAAL,EADiB,EAEjB,KAAKC,cAAL,EAFiB,CAAZ,C;;;;;;;;;;;;;;;;;;;;;AAMX;IAAcC,a,WAAAA,a;AAEZ,yBAAYnN,YAAZ,EAA0BhH,cAA1B,EAA0CC,WAA1C,EAAuDE,OAAvD,EAAgEiU,QAAhE,EAA0E;AAAA;;AAExED,kBAAcE,mBAAd,GAAoC,qBAApC;AACAF,kBAAcG,mBAAd,GAAoC,qBAApC;AACAH,kBAAcI,yBAAd,GAA0C,2BAA1C;;AAEA,SAAKtU,WAAL,GAAmBA,WAAnB;AACA,SAAK+G,YAAL,GAAoBA,YAApB;AACA,SAAKhH,cAAL,GAAsBA,cAAtB;;AAEA;AACA,SAAKwU,SAAL,GAAiBJ,YAAYK,YAAYhU,IAAZ,CAAiBd,MAAjB,CAA7B;AACA,SAAKY,QAAL,GAAgBJ,WAAWK,WAAWC,IAAX,CAAgBd,MAAhB,CAA3B;;AAEA,SAAK+U,UAAL,GAAkB,EAAlB;AACA,SAAKC,mBAAL,GAA2B,EAA3B;AACA,SAAKjU,aAAL,GAAqB,EAArB;AACD;;;;;;;;;;;uBAGc,KAAKV,cAAL,CAAoB0B,OAApB,CAA4B,QAA5B,C;;;;;;;;;;gCAAyC/B,OAAOiV,kB;;;;;;;;;;;;;;;;;;;;;;;;;;;;uBAIhD,KAAKC,YAAL,E;;;;mEAAsB,a;;;;;;;;;;;;;;;;;;+CAGV3K,Q,EAAU;AACnC,UAAIG,WAAW,EAACzD,KAAK,IAAIkO,IAAJ,EAAN,EAAkB5K,UAAUA,QAA5B,EAAf;AACA,WAAKyK,mBAAL,CAAyB/T,IAAzB,CAA8ByJ,QAA9B;AACA,aAAOA,QAAP;AACD;;;6CAEwBA,Q,EAAU;AACjCxJ,QAAEC,IAAF,CAAO,KAAK6T,mBAAZ,EAAiCtK,QAAjC;AACD;;;0CAEqB;AAAA;;AACpB,WAAKsK,mBAAL,CAAyBhF,OAAzB,CAAiC,UAACtF,QAAD,EAAc;AAC7CA,iBAASH,QAAT,CAAkB,QAAKwK,UAAvB;AACD,OAFD;AAGD;;;oCAEe/T,O,EAAS;AACvB;;;;;;;;;;;AAWA,WAAKD,aAAL,CAAmBE,IAAnB,CAAwBD,OAAxB;AACA,aAAOA,OAAP;AACD;;;uCAEkBA,O,EAAS;AAC1BE,QAAEC,IAAF,CAAO,KAAKJ,aAAZ,EAA2BC,OAA3B;AACD;;;gCAEWoU,S,EAAW/T,I,EAAM;AAAA;AAAA;AAAA;;AAAA;AAC3B,+BAAmB,KAAKN,aAAxB,wIAAuC;AAAA,cAA/BC,OAA+B;;AACrCA,kBAAQoU,SAAR,EAAmB/T,QAAQ,EAA3B;AACD;AAH0B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAI5B;;;yCAEoBL,O,EAAS;AAC5B,WAAKoR,iBAAL,GAAyBpR,OAAzB;AACD;;;;8FAEsB6E,O;;;;;mDAUd,KAAKuM,iBAAL,CAAuBvM,OAAvB,C;;;;;;;;;;;;;;;;;;wCAGW;AAClB,aAAO,KAAKwP,kBAAZ;AACD;;;;8FAEoBC,mB;;;YAAqBC,S,uEAAY,G;;;;;mDAC7C,KAAKlV,cAAL,CAAoBmV,YAApB,GAAmC3T,IAAnC,CAAwC,UAAC0G,KAAD,EAAW;AACxD;AACA,sBAAIkN,QAAQlN,MAAM5B,MAAlB;AACA,sBAAI+O,UAAU,CAAd;AACA,sBAAIC,YAAY,EAAhB;;AAEA,sBAAIC;AAAA,yFAAc;AAAA;AAAA;AAAA;AAAA;AAAA;AACZC,sCADY,GACDtN,MAAM0F,KAAN,CAAYyH,OAAZ,EAAqBA,UAAUH,SAA/B,CADC;AAAA;AAAA,qCAEc,QAAKO,mBAAL,CAAyBD,QAAzB,EAAmC,IAAnC,EAAyCvM,eAAeI,2BAAxD,EAAqF8K,cAAcE,mBAAnG,CAFd;;AAAA;AAEZqB,+CAFY;;AAGhBJ,wCAAU1U,IAAV,CAAe8U,iBAAf;;AAEAL,yCAAWG,SAASlP,MAApB;;AALgB,oCAOb+O,UAAUD,KAPG;AAAA;AAAA;AAAA;;AAAA,iEAQP,IAAI5V,OAAJ,CAAY,UAACmW,YAAD,EAAeC,WAAf,EAA+B;AAChD,wCAAKrV,QAAL,CAAc,YAAM;AAClB0U,yDAAuBA,oBAAoBI,OAApB,EAA6BD,KAA7B,CAAvB;AACAG,gDAAc/T,IAAd,CAAmBmU,YAAnB;AACD,iCAHD;AAID,+BALM,CARO;;AAAA;AAed;AACA,sCAAKlU,WAAL,CAAiB,mBAAjB;AACA,sCAAKuT,kBAAL,GAA0B,IAA1B;;AAjBc;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qBAAd;;AAAA;AAAA;AAAA;AAAA,qBAAJ;;AAqBA,yBAAOO,aAAP;AACD,iBA5BM,C;;;;;;;;;;;;;;;;;;;8FA+BsBrN,K,EAAO2N,W;;;;;;;mDAC7B,IAAIrW,OAAJ;AAAA,uFAAY,mBAAOC,OAAP,EAAgBC,MAAhB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kCACdwI,MAAM5B,MAAN,IAAgB,CADF;AAAA;AAAA;AAAA;;AAEf7G;AAFe;;AAAA;AAAA;AAAA,mCAMA,QAAKqW,gBAAL,CAAsB3B,cAAcG,mBAApC,CANA;;AAAA;AAMbyB,gCANa;;;AAQjBvW,oCAAQ+R,GAAR,CAAYrJ,MAAMvB,GAAN;AAAA,mGAAU,mBAAOyB,IAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAChBoJ,kDADgB,GACH,IAAIC,YAAJ,CAAiBrJ,IAAjB,EAAuB2N,KAAK9U,IAA5B,EAAkC8U,KAAK1C,WAAvC,CADG;AAAA;AAAA,+CAED7B,WAAWwE,qBAAX,EAFC;;AAAA;AAEpBxE,kDAFoB;;AAGpB,4CAAGqE,WAAH,EAAgB;AACd,iDAAOrE,WAAW/E,KAAlB;AACD;AALmB,2EAMb+E,UANa;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+BAAV;;AAAA;AAAA;AAAA;AAAA,gCAAZ,EAOIhQ,IAPJ,CAOS,UAACjC,MAAD,EAAY;AACnB,sCAAKS,cAAL,CAAoBgU,UAApB,CAA+BzU,MAA/B,EAAuCiC,IAAvC,CAA4C,YAAM;AAChD;AACA,oCAAG,QAAKkT,UAAL,CAAgBuB,UAAnB,EAA+B;AAC7B,0CAAKvB,UAAL,CAAgBuB,UAAhB,GAA6B,IAA7B;AACA,0CAAKC,mBAAL;AACD;AACDzW;AACD,+BAPD,EAOGsE,KAPH,CAOS,UAACtB,KAAD,EAAW;AAClB;AACAD,wCAAQC,KAAR,CAAc,qBAAd,EAAqCA,KAArC;AACA,wCAAKiS,UAAL,CAAgBuB,UAAhB,GAA6BxT,KAA7B;AACA,wCAAKyT,mBAAL;AACAxW;AACD,+BAbD;AAcD,6BAtBD,EAsBGqE,KAtBH,CAsBS,UAACoC,CAAD,EAAO;AACdzG,qCAAOyG,CAAP;AACD,6BAxBD;;AARiB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAAZ;;AAAA;AAAA;AAAA;AAAA,oB;;;;;;;;;;;;;;;;;;;8FAoCS+B,K;;;;;;;;;AAChB;;;;;AACA,mCAAgBA,KAAhB,+HAAuB;AAAfE,sBAAe;AAAEA,uBAAKgK,UAAL,GAAkB,IAAI0C,IAAJ,EAAlB;AAA+B;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;mDACjD,KAAKqB,wBAAL,CAA8BjO,KAA9B,EAAqC,IAArC,EAA2C1G,IAA3C,CAAgD,UAAC4U,aAAD,EAAmB;AACxE;AADwE;AAAA;AAAA;;AAAA;AAExE,2CAAgBlO,KAAhB,wIAAuB;AAAA,0BAAfE,IAAe;;AACrB,0BAAGA,KAAKuC,OAAR,EAAiB;AAAE,gCAAK3D,YAAL,CAAkB0F,iBAAlB,CAAoCtE,IAApC;AAA2C;AAC/D;AAJuE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAMxE,0BAAK3G,WAAL,CAAiB,gBAAjB;AACA;AACA,0BAAKuF,YAAL,CAAkBqP,oBAAlB,CAAuCnO,KAAvC;;AAEA,yBAAO,EAACoO,aAAapO,KAAd,EAAP;AACD,iBAXM,C;;;;;;;;;;;;;;;;;AAcT;;;;;;;;;8FAKsCqO,c;;;;;;;;AAEpC;AACIC,6B,GAAgB,KAAKxP,YAAL,CAAkBmB,QAAlB,CAA2BS,MAA3B,CAAkC,UAACR,IAAD,EAAU;AAAC,yBAAO,CAACA,KAAK2D,eAAb;AAA6B,iBAA1E,EAA4E6B,KAA5E,E;;qBAEjB2I,c;;;;;;;;;8BACeC,a;;;;;;;;AAARpO,oB;;uBASA,KAAKpB,YAAL,CAAkByP,oBAAlB,CAAuCrO,IAAvC,C;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAIND,wB,GAAW,KAAKnB,YAAL,CAAkBmB,Q;;;;;;AACjC,mCAAgBA,QAAhB,+HAA0B;AAAlBC,sBAAkB;AAAEA,uBAAK0C,QAAL,CAAc,IAAd;AAAsB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;mDAC3C,KAAKqL,wBAAL,CAA8BhO,QAA9B,EAAwC,KAAxC,C;;;;;;;;;;;;;;;;;;;8FAGUjD,K;;;;;AACjB,qBAAKwR,UAAL,GAAkBxR,KAAlB;;uBACM,KAAKlF,cAAL,CAAoBmB,OAApB,CAA4B,WAA5B,EAAyC+D,KAAzC,C;;;;;;;;;;;;;;;;;;;;;;;;oBAIF,KAAKwR,U;;;;;;uBACiB,KAAK1W,cAAL,CAAoB0B,OAApB,CAA4B,WAA5B,C;;;AAAxB,qBAAKgV,U;;;mDAEA,KAAKA,U;;;;;;;;;;;;;;;;;;;8FAGOxR,K;;;;;AACnB,qBAAKyR,YAAL,GAAoBzR,KAApB;;qBACGA,K;;;;;;uBACK,KAAKlF,cAAL,CAAoBmB,OAApB,CAA4B,aAA5B,EAA2C+D,KAA3C,C;;;;;;;;uBAEA,KAAKlF,cAAL,CAAoBmT,UAApB,CAA+B,aAA/B,C;;;;;;;;;;;;;;;;;;;;;;;;oBAKJ,KAAKwD,Y;;;;;;uBACmB,KAAK3W,cAAL,CAAoB0B,OAApB,CAA4B,aAA5B,C;;;AAA1B,qBAAKiV,Y;;;mDAEA,KAAKA,Y;;;;;;;;;;;;;;;;;;2CAUS;AACrB,WAAKC,gBAAL,GAAwB,EAAxB;AACD;;;wCAEmBrU,Q,EAAU;AAC5B,UAAIsU,eAAe,KAAKC,eAAxB;AACA,UAAGD,aAAavQ,MAAhB,EAAwB;AAAA;AAAA;AAAA;;AAAA;AACtB,iCAAwBuQ,YAAxB,wIAAsC;AAAA,gBAA9BE,YAA8B;;AACpCA,yBAAaxU,QAAb;AACD;AAHqB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAItB,aAAKyU,oBAAL;AACD;AACF;;;yDAEoC;AACnC,UAAG,KAAKtC,UAAL,CAAgBuC,OAAnB,EAA4B;AAC1B,aAAKC,iCAAL;AACD;AACD,WAAKxC,UAAL,CAAgBuC,OAAhB,GAA0B,KAAKzC,SAAL,CAAe,YAAU;AACjD;AACA,YAAI2C,gBAAgB,CAAC,IAAIrC,IAAJ,KAAa,KAAKJ,UAAL,CAAgB0C,SAA9B,IAA2C,IAA/D;AACA,YAAIC,mBAAmB,GAAvB,CAHiD,CAGrB;AAC5B,YAAGF,gBAAgBE,gBAAnB,EAAqC;AACnC,eAAK5V,WAAL,CAAiB,sBAAjB;AACA,eAAKyV,iCAAL;AACD;AACF,OARwC,CAQvCzW,IARuC,CAQlC,IARkC,CAAf,EAQZ,GARY,CAA1B;AASD;;;wDAEmC;AAClC,UAAG,KAAK+T,SAAL,CAAe5B,cAAf,CAA8B,QAA9B,CAAH,EAA4C;AAC1C,aAAK4B,SAAL,CAAe3B,MAAf,CAAsB,KAAK6B,UAAL,CAAgBuC,OAAtC;AACD,OAFD,MAEO;AACLK,sBAAc,KAAK5C,UAAL,CAAgBuC,OAA9B;AACD;AACD,WAAKvC,UAAL,CAAgBuC,OAAhB,GAA0B,IAA1B;AACD;;;kCAEa;AACZ,WAAKM,UAAL,GAAkB,IAAlB;AACD;;;oCAEe;AACd,WAAKA,UAAL,GAAkB,KAAlB;AACD;;;;;;;YAEUC,O,uEAAU,E;;;;;mDACZ,IAAIhY,OAAJ;AAAA,uFAAY,mBAAOC,OAAP,EAAgBC,MAAhB;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,iCAEd,QAAK6X,UAFS;AAAA;AAAA;AAAA;;AAGf/U,oCAAQwG,GAAR,CAAY,yBAAZ;AACAvJ;AAJe;;AAAA;;AAQjB,gCAAG,CAAC+X,OAAJ,EAAaA,UAAU,EAAV;;AAETC,yCAVa,GAUG,QAAKzQ,YAAL,CAAkB0Q,aAAlB,EAVH;;AAYjB;AACA;;AAbiB,kCAcd,QAAKhD,UAAL,CAAgBiD,gBAAhB,IAAoC,CAACH,QAAQI,KAd/B;AAAA;AAAA;AAAA;;AAef,oCAAKC,kBAAL,GAA0B,IAA1B;AACA,oCAAKf,eAAL,CAAqBlW,IAArB,CAA0BnB,OAA1B;;AAEA;AACA;AACA,oCAAK0W,wBAAL,CAA8BsB,aAA9B,EAA6C,KAA7C;;AAEAjV,oCAAQwG,GAAR,CAAY,iCAAZ;AAtBe;;AAAA;AAAA;AAAA,mCA0BA,QAAK8M,gBAAL,CAAsB3B,cAAcI,yBAApC,CA1BA;;AAAA;AA0BbwB,gCA1Ba;;AAAA,iCA8BdA,KAAK+B,OA9BS;AAAA;AAAA;AAAA;;AA+Bf,oCAAKC,WAAL,CAAiBN,aAAjB,EAAgCjW,IAAhC,CAAqC,UAACe,QAAD,EAAc;AACjD,sCAAKyE,YAAL,CAAkBgR,eAAlB,CAAkCP,aAAlC;AACAhY,sCAAQ8C,QAAR;AACD,6BAHD,EAGGwB,KAHH,CAGS,UAACoC,CAAD,EAAO;AACd,sCAAK1E,WAAL,CAAiB,gBAAjB,EAAmC0E,CAAnC;AACD,6BALD;AA/Be;;AAAA;AAwCb8R,8CAxCa,GAwCQ,QAAKvD,UAAL,CAAgBwD,aAxCxB;;;AA0CjB,oCAAKxD,UAAL,CAAgBiD,gBAAhB,GAAmC,IAAnC;AACA,oCAAKjD,UAAL,CAAgB0C,SAAhB,GAA4B,IAAItC,IAAJ,EAA5B;AACA,oCAAKqD,kCAAL;;AAEIC,uCA9Ca,GA8CC,GA9CD;AA+CbC,oCA/Ca,GA+CFZ,cAAc7J,KAAd,CAAoB,CAApB,EAAuBwK,WAAvB,CA/CE;;AAgDjB,gCAAGC,SAAS/R,MAAT,GAAkBmR,cAAcnR,MAAnC,EAA2C;AACzC;AACA,sCAAKoO,UAAL,CAAgBwD,aAAhB,GAAgC,IAAhC;AACD,6BAHD,MAGO;AACL,sCAAKxD,UAAL,CAAgBwD,aAAhB,GAAgC,KAAhC;AACD;;AAED,gCAAG,CAACD,kBAAJ,EAAwB;AACtB,sCAAKvD,UAAL,CAAgBU,KAAhB,GAAwBqC,cAAcnR,MAAtC;AACA,sCAAKoO,UAAL,CAAgBW,OAAhB,GAA0B,CAA1B;AACD;;AAED;AACA;AACA,gCAAG,QAAKX,UAAL,CAAgBW,OAAhB,GAA0B,QAAKX,UAAL,CAAgBU,KAA7C,EAAoD;AAClD,sCAAKV,UAAL,CAAgBU,KAAhB,GAAwB,QAAKV,UAAL,CAAgBW,OAAxC;AACD;;AAED,oCAAKa,mBAAL;;AAEA;AACA;AACA;AACA;AACA;AACA,gCAAG,CAAC,QAAKoC,iBAAT,EAA4B;AAC1B,sCAAKA,iBAAL,GAAyB,EAAzB;AACD;;AAED;AACA,gCAAG,CAAC,QAAKC,aAAT,EAAwB;AACtB,sCAAKA,aAAL,GAAqB,EAArB;AACD;;AAEGhZ,kCAlFa,GAkFJ,EAlFI;;AAmFjBA,mCAAOiZ,KAAP,GAAe,GAAf;;AAnFiB;AAAA;AAAA,mCAsFThZ,QAAQ+R,GAAR,CAAY8G,SAAS1R,GAAT,CAAa,UAACyB,IAAD,EAAU;AACvC,kCAAIoJ,aAAa,IAAIC,YAAJ,CAAiBrJ,IAAjB,EAAuB2N,KAAK9U,IAA5B,EAAkC8U,KAAK1C,WAAvC,CAAjB;AACA7B,yCAAWiH,gBAAX,GAA8BjB,QAAQiB,gBAAtC;AACA,qCAAOjH,WAAW8B,aAAX,EAAP;AACD,6BAJiB,CAAZ,EAIF9R,IAJE,CAIG,UAACkX,WAAD,EAAiB;AACxBnZ,qCAAO2I,KAAP,GAAewQ,WAAf;AACD,6BANK,CAtFS;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AA8Ff,oCAAKjX,WAAL,CAAiB,gBAAjB;;AA9Fe;AAAA;AAAA;AAAA;AAAA;;;AAiGjB,+CAAgB4W,QAAhB,+HAA0B;AAAlBjQ,kCAAkB;;AACxB;AACA;AACAA,mCAAKuQ,UAAL,GAAkB,CAAlB;AACD;;AArGgB;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA;;AAAA;AAAA;;AAAA;AAAA;AAAA,mCAuGS,QAAKC,YAAL,EAvGT;;AAAA;AAuGjBrZ,mCAAOsZ,UAvGU;AAAA;AAAA,mCAwGW,QAAKC,cAAL,EAxGX;;AAAA;AAwGjBvZ,mCAAOwZ,YAxGU;AAAA;AAAA,4CA2Gf,QAAK9Y,WA3GU;AAAA;AAAA,mCA2GqB,QAAK+Y,UAAL,EA3GrB;;AAAA;AAAA;AAAA,4CA2GwCzZ,MA3GxC;;AAAA,4CA2GgD,UAACgD,QAAD,EAAc;AAC3E,sCAAK0W,iBAAL,CAAuBZ,QAAvB,EAAiC9V,QAAjC,EAA2CiV,OAA3C,EAAoDhW,IAApD,CAAyD,YAAM;AAC7D/B,wCAAQ8C,QAAR;AACD,+BAFD,EAEGwB,KAFH,CAES,UAACoC,CAAD,EAAO;AACd3D,wCAAQwG,GAAR,CAAY,gCAAZ,EAA8C7C,CAA9C;AACA,wCAAK+S,eAAL,CAAqB,IAArB,EAA2B,IAA3B,EAAiCzB,aAAjC,EAAgDjW,IAAhD,CAAqD,UAAC2X,aAAD,EAAmB;AACtE1Z,0CAAQ0Z,aAAR;AACD,iCAFD;AAGD,+BAPD;AAQD,6BApHc;;AAAA,4CAoHZ,UAAC5W,QAAD,EAAW6W,UAAX,EAA0B;AAC3B,sCAAKF,eAAL,CAAqB3W,QAArB,EAA+B6W,UAA/B,EAA2C3B,aAA3C,EAA0DjW,IAA1D,CAA+D,UAAC2X,aAAD,EAAmB;AAChF1Z,wCAAQ0Z,aAAR;AACD,+BAFD;AAGD,6BAxHc;;AAAA,0CA2GE5U,YA3GF;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AA2Hf/B,oCAAQwG,GAAR,CAAY,wBAAZ;;AA3He;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAAZ;;AAAA;AAAA;AAAA;AAAA,oB;;;;;;;;;;;;;;;;;;;8FAgIeqQ,W,EAAa9W,Q,EAAUiV,O;;;;;;;;;AAC7C;AACI8B,mC,GAAsB,E;;;;;;AAC1B,mCAAgBD,WAAhB,+HAA6B;AAArBjR,sBAAqB;;AAC3B,sBAAGA,KAAKuQ,UAAL,IAAmB,CAAtB,EAAyB;AACvB;AACAW,wCAAoB1Y,IAApB,CAAyBwH,IAAzB;AACD;AACF;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AACD,qBAAKpB,YAAL,CAAkBgR,eAAlB,CAAkCsB,mBAAlC;AACA,qBAAK5E,UAAL,CAAgBjS,KAAhB,GAAwB,IAAxB;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEI8W,6B,GAAgB,KAAKhB,aAAL,CAAmB5R,GAAnB,CAAuB,UAACyB,IAAD,EAAU;AAAC,yBAAOA,KAAKoC,IAAZ;AAAiB,iBAAnD,C;;AACpBjI,yBAASiX,eAAT,GAA2BjX,SAASiX,eAAT,CAAyB5Q,MAAzB,CAAgC,UAAC6Q,SAAD,EAAe;AAAC,yBAAO,CAACF,cAAc9V,QAAd,CAAuBgW,UAAUjP,IAAjC,CAAR;AAA+C,iBAA/F,CAA3B;;AAEA;AACA;;uBACsB,KAAKiL,mBAAL,CAAyBlT,SAASiX,eAAlC,EAAmD,IAAnD,EAAyDvQ,eAAeC,4BAAxE,EAAsGiL,cAAcI,yBAApH,C;;;AAAlBmF,yB;;;AAEJ;AACA,qBAAKpB,iBAAL,GAAyB,KAAKA,iBAAL,CAAuBqB,MAAvB,CAA8BD,SAA9B,CAAzB;AACA,qBAAKhF,UAAL,CAAgBkF,cAAhB,GAAiC,KAAKtB,iBAAL,CAAuBhS,MAAxD;;AAEA;AACA;AACA;AACIoF,0B,GAAa,CAAC,SAAD,EAAY,WAAZ,C;;AAEjB;;;uBACkB,KAAK+J,mBAAL,CAAyBlT,SAAS+T,WAAlC,EAA+C5K,UAA/C,EAA2DzC,eAAeE,wBAA1E,EAAoGgL,cAAcI,yBAAlH,C;;;AAAdsF,qB;;;AAEJ;AACA,qBAAKtB,aAAL,GAAqB,KAAKA,aAAL,CAAmBoB,MAAnB,CAA0BE,KAA1B,CAArB;;AAEA;AACIC,uB,GAAUvX,SAASuX,O;AACvB;AACA;AACA;AACA;;;uBACM,KAAKC,0BAAL,CAAgCD,OAAhC,C;;;;uBAEA,KAAK3D,wBAAL,CAA8B0D,KAA9B,EAAqC,KAArC,C;;;;uBACA,KAAK1D,wBAAL,CAA8BuD,SAA9B,EAAyC,KAAzC,C;;;;AAEN,qBAAKhF,UAAL,CAAgBiD,gBAAhB,GAAmC,KAAnC;AACA,qBAAKjD,UAAL,CAAgBW,OAAhB,IAA2BgE,YAAY/S,MAAvC;;AAEA,qBAAK4P,mBAAL;;;uBAE2B,KAAK0C,YAAL,E;;;;AAAvBoB,6B,oBAA+C,I;;;AAEnD;AACA,qBAAKC,YAAL,CAAkB1X,SAASsW,UAA3B;AACA,qBAAKqB,cAAL,CAAoB3X,SAASwW,YAA7B;;AAEA,qBAAK7B,iCAAL;;AAEA;AACA;;;uBAES,KAAK4B,cAAL,E;;;;;;;;;;gCAAyB,KAAKpE,UAAL,CAAgBwD,a;;;;;;;;mDACzC,IAAI1Y,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtCc,6BAAW,YAAY;AACrB,yBAAK2Z,IAAL,CAAU3C,OAAV,EAAmBhW,IAAnB,CAAwB/B,OAAxB;AACD,mBAFU,CAETgB,IAFS,CAEJ,OAFI,CAAX,EAEc,EAFd,EADsC,CAGnB;AACpB,iBAJM,C;;;qBAOD,KAAKoX,kB;;;;;AACX,qBAAKA,kBAAL,GAA0B,KAA1B;mDACO,IAAIrY,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtCc,6BAAW,YAAY;AACrB,yBAAK2Z,IAAL,CAAU3C,OAAV,EAAmBhW,IAAnB,CAAwB/B,OAAxB;AACD,mBAFU,CAETgB,IAFS,CAEJ,OAFI,CAAX,EAEc,EAFd,EADsC,CAGnB;AACpB,iBAJM,C;;;AAQP;;;;;;;AAQA,qBAAKiU,UAAL,CAAgBkF,cAAhB,GAAiC,CAAjC;AACA,qBAAK1D,mBAAL;;AAEA;AACA;AACIkE,wC,GAA2B,E;;AAC/B,oBACE,KAAK9B,iBAAL,CAAuBhS,MAAvB,IAAiC8T,wBAAjC,IACAP,MAAMvT,MAAN,IAAgB8T,wBADhB,IAEAN,QAAQxT,MAAR,IAAkB8T,wBAHpB,EAIE;AACA,uBAAK3Y,WAAL,CAAiB,mBAAjB;AACD;;AAED,qBAAK4Y,mBAAL,CAAyB9X,QAAzB;AACA,qBAAKd,WAAL,CAAiB,gBAAjB,EAAmC,EAAC6Y,gBAAgB,KAAKhC,iBAAtB,EAAyCiC,YAAY,KAAKhC,aAA1D,EAAyEiC,cAAcV,OAAvF,EAAgGtS,aAAawS,aAA7G,EAAnC;;AAEA,qBAAK1B,iBAAL,GAAyB,EAAzB;AACA,qBAAKC,aAAL,GAAqB,EAArB;;mDAEOhW,Q;;;;;;;;;;;;;;;;;;;8FAIWA,Q,EAAU6W,U,EAAY3B,a;;;;;AAC1CjV,wBAAQwG,GAAR,CAAY,YAAZ,EAA0BzG,QAA1B;AACA,oBAAG6W,cAAc,GAAjB,EAAsB;AACpB,uBAAK3X,WAAL,CAAiB,sBAAjB;AACD;;AAEDe,wBAAQwG,GAAR,CAAY,cAAZ,EAA4BzG,QAA5B;;AAEA,oBAAG,CAACA,QAAJ,EAAc;AACZA,6BAAW,EAACE,OAAO,EAACC,SAAS,8BAAV,EAAR,EAAX;AACD;;AAED,qBAAKgS,UAAL,CAAgBiD,gBAAhB,GAAmC,KAAnC;AACA,qBAAKjD,UAAL,CAAgBjS,KAAhB,GAAwBF,SAASE,KAAjC;AACA,qBAAKyT,mBAAL;;AAEA,qBAAKC,wBAAL,CAA8BsB,aAA9B,EAA6C,KAA7C;AACA,qBAAKzQ,YAAL,CAAkBqP,oBAAlB,CAAuCoB,aAAvC;;AAEA,qBAAKP,iCAAL;;AAEA,qBAAKzV,WAAL,CAAiB,YAAjB,EAA+Bc,SAASE,KAAxC;;AAEA,qBAAK4X,mBAAL,CAAyB,EAAC5X,OAAO,YAAR,EAAzB;;mDAEOF,Q;;;;;;;;;;;;;;;;;;;8FAGiB6T,a,EAAe1K,U,EAAY/B,M,EAAQ8Q,U;;;;;;;uBACzC,KAAK3E,gBAAL,CAAsB2E,UAAtB,C;;;AAAdxZ,oB,mBAAiDA,I;;uBAC/CsC,KAAKmQ,eAAL,CAAqBgH,oBAArB,CAA0CtE,aAA1C,EAAyDnV,IAAzD,C;;;AACFiH,qB,GAAQ,KAAKlB,YAAL,CAAkByE,2CAAlB,CAA8D2K,aAA9D,EAA6E1K,UAA7E,EAAyF/B,MAAzF,C;;AAEZ;AACA;AACA;;AACIgR,0C,GAA6BzS,MAAMU,MAAN,CAAa,UAACR,IAAD,EAAU;AACtD,sBAAIwS,eAAexS,KAAKyS,2BAAxB;AACA;AACAzS,uBAAKyS,2BAAL,GAAmC,KAAnC;AACA,yBAAOD,YAAP;AACD,iBALgC,C;;AAMjC,oBAAGD,2BAA2BrU,MAA3B,GAAoC,CAAvC,EAA0C;AACxC,uBAAK6P,wBAAL,CAA8BwE,0BAA9B,EAA0D,KAA1D;AACD;;mDAEMzS,K;;;;;;;;;;;;;;;;;;;;;;;;;AAIH4S,4B,GAAe,KAAK9T,YAAL,CAAkBmB,QAAlB,CAA2BS,MAA3B,CAAkC,UAACR,IAAD,EAAU;AAAC,yBAAOA,KAAK2D,eAAL,IAAwB,IAA/B;AAAoC,iBAAjF,C;;sBAChB+O,aAAaxU,MAAb,GAAsB,C;;;;;mDAChB,KAAKmP,mBAAL,CAAyBqF,YAAzB,EAAuC,IAAvC,EAA6C7R,eAAeI,2BAA5D,EAAyF8K,cAAcI,yBAAvG,C;;;;;;;;;;;;;;;;;;;8FAIsBuF,O;;;;;;;sBAC5BA,QAAQxT,MAAR,IAAkB,C;;;;;;;;;AAIrB9D,wBAAQwG,GAAR,CAAY,0BAAZ,EAAwC8Q,OAAxC;;;;;;8BAEmBA,O;;;;;;;;AAAXiB,uB;AACF9L,4B,GAAe8L,QAAQ3S,I;gCACrB7E,KAAKmQ,e;gCAAqC,CAACzE,YAAD,C;;uBAAuB,KAAK6G,gBAAL,CAAsB3B,cAAcI,yBAApC,C;;;gDAAgEtT,I;;qCAA5GyZ,oB;;;AACvBtS,oB,GAAO,KAAKpB,YAAL,CAAkBkF,QAAlB,CAA2B+C,aAAazE,IAAxC,C;;AAEX;;oBACIpC,I;;;;;;;;AAEA3F,qB,GAAQsY,QAAQtY,K;;sBAEjBA,MAAMuY,GAAN,KAAc,e;;;;;;uBAGT,KAAKhU,YAAL,CAAkByP,oBAAlB,CAAuCrO,IAAvC,C;;;;;;;sBAGA3F,MAAMuY,GAAN,KAAc,e;;;;;;uBAGMzX,KAAKa,MAAL,CAAYmG,YAAZ,E;;;AAA1B0E,6BAAazE,I;AAET0E,mB,GAAM,KAAKlI,YAAL,CAAkBkK,oBAAlB,CAAuCjC,YAAvC,C;;AACV,oBAAG,CAACA,aAAatE,OAAd,IAAyB,CAACvC,KAAK+I,sBAAL,CAA4BjC,GAA5B,CAA7B,EAA+D;AAC7D,uBAAKlI,YAAL,CAAkBoK,iBAAlB,CAAoClC,GAApC,EAAyC9G,IAAzC;AACD;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAIL;AACA;AACA;AACA;AACA;AACA;AACA,qBAAK+R,IAAL,CAAU,IAAV,EAAgB,EAAC1B,kBAAkB,CAAC,YAAD,EAAe,YAAf,CAAnB,EAAhB;;;;;;;;;;;;;;;;;;;;;;;;AAIA,qBAAK/B,UAAL,GAAkB,IAAlB;AACA,qBAAKC,YAAL,GAAoB,IAApB;AACA,qBAAKC,gBAAL,GAAwB,EAAxB;AACA,qBAAKlC,UAAL,GAAkB,EAAlB;;;;;;;;;;;;;;;;;;;;;;;;AAIA,qBAAKgC,UAAL,GAAkB,IAAlB;AACA,qBAAKC,YAAL,GAAoB,IAApB;mDACO,KAAK3W,cAAL,CAAoBmT,UAApB,CAA+B,WAA/B,C;;;;;;;;;;;;;;;;;;wBA1Za;AACpB,UAAG,CAAC,KAAKyD,gBAAT,EAA2B;AACzB,aAAKA,gBAAL,GAAwB,EAAxB;AACD;AACD,aAAO,KAAKA,gBAAZ;AACD;;;;;;AAwZH,CAAC,IAAIqE,aAAJ;;IAEYjM,M,WAAAA,M;AAEX,oBAA2B;AAAA,QAAflD,QAAe,uEAAJ,EAAI;;AAAA;;AACzB,SAAKoP,OAAL,GAAe,EAAf;AACA,SAAKtQ,OAAL,GAAe,EAAf;AACA,SAAKwE,kBAAL,GAA0B,EAA1B;AACA,SAAKjD,cAAL,CAAoBL,QAApB;;AAEA,QAAG,CAAC,KAAKtB,IAAT,EAAe;AACb;AACA,UAAG,OAAOjH,IAAP,KAAiB,WAAjB,IAAgCA,KAAKa,MAAL,CAAY+W,gBAA/C,EAAiE;AAC/D,aAAK3Q,IAAL,GAAYjH,KAAKa,MAAL,CAAY+W,gBAAZ,EAAZ;AACD;AACF;;AAED,QAAG,CAAC,KAAKvQ,OAAL,CAAaC,UAAjB,EAA6B;AAC3B,WAAKD,OAAL,CAAaC,UAAb,GAA0B,EAA1B;AACD;AACF;;;;mCAoCcuQ,I,EAAM;AACnB;AACA,WAAKC,UAAL,GAAkBD,KAAKC,UAAvB;AACA,WAAKjJ,UAAL,GAAkBgJ,KAAKhJ,UAAvB;AACA,WAAKzH,OAAL,GAAeyQ,KAAKzQ,OAApB;AACA,WAAKH,IAAL,GAAY4Q,KAAK5Q,IAAjB;AACA,WAAK8Q,YAAL,GAAoBF,KAAKE,YAAzB;AACA,WAAKC,SAAL,GAAiBH,KAAKG,SAAtB;AACA,WAAKlI,WAAL,GAAmB+H,KAAK/H,WAAxB;;AAEA;AACA;AACA,UAAImI,aAAa,CAAC,iBAAD,EAAoB,aAApB,EAAmC,OAAnC,EAA4C,YAA5C,CAAjB;AAZmB;AAAA;AAAA;;AAAA;AAanB,+BAAeA,UAAf,wIAA2B;AAAA,cAAnB5U,GAAmB;;AACzB,cAAGwU,KAAKxU,GAAL,MAAc6U,SAAjB,EAA4B;AAC1B,iBAAK7U,GAAL,IAAYwU,KAAKxU,GAAL,CAAZ;AACD;AACF;;AAED;AAnBmB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAoBnB,UAAG,CAAC,KAAKyB,YAAT,EAAuB;AACrB,aAAKA,YAAL,GAAoB+S,KAAK/S,YAAzB;AACD;;AAED;AACA;;AAEA,UAAI;AACF,YAAIqT,gBAAgB,OAAON,KAAKxQ,OAAZ,KAAwB,QAAxB,GAAmCjJ,KAAKC,KAAL,CAAWwZ,KAAKxQ,OAAhB,CAAnC,GAA8DwQ,KAAKxQ,OAAvF;AACAoE,eAAO2M,SAAP,CAAiB,KAAKjO,aAAtB,EAAqCgO,aAArC;AACD,OAHD,CAGE,OAAOvV,CAAP,EAAU;AACV3D,gBAAQwG,GAAR,CAAY,qCAAZ,EAAmD7C,CAAnD;AACD;;AAED,UAAG,KAAKkV,UAAR,EAAoB;AAClB,aAAKA,UAAL,GAAkB,IAAIvG,IAAJ,CAAS,KAAKuG,UAAd,CAAlB;AACA,aAAKjJ,UAAL,GAAkB,IAAI0C,IAAJ,CAAS,KAAK1C,UAAd,CAAlB;AACD,OAHD,MAGO;AACL,aAAKiJ,UAAL,GAAkB,IAAIvG,IAAJ,EAAlB;AACA,aAAK1C,UAAL,GAAkB,IAAI0C,IAAJ,EAAlB;AACD;;AAED;AACA,WAAK8G,kBAAL,GAA0B,IAA1B;;AAEA,UAAGR,KAAKxQ,OAAR,EAAiB;AACf,aAAKiR,2BAAL,CAAiC,KAAKnO,aAAtC;AACD,OAFD,MAEO,IAAG0N,KAAKzQ,OAAL,IAAgB,IAAnB,EAAyB;AAC9B,aAAKmR,oBAAL;AACD;AACF;;;gDAE2BC,U,EAAY;AACtC,UAAGA,WAAWb,OAAd,EAAuB;AACrB,aAAKA,OAAL,GAAea,WAAWb,OAA1B;AACD;AACD,UAAG,CAAC,KAAKA,OAAT,EAAkB;AAAE,aAAKA,OAAL,GAAe,EAAf;AAAoB;AACzC;;;sDAEiC;AAChC,aAAO,KAAKc,eAAL,EAAP;AACD;;;sCAEiB;AAChB,UAAIzc,SAAS,KAAKmO,aAAlB;AACAnO,aAAO2b,OAAP,GAAiB,KAAKA,OAAtB;AACA,aAAO3b,MAAP;AACD;;AAED;;;;2CACuB;AACrB;AACD;;;6BAEQkN,K,EAAOwP,oB,EAAsB;AACpC,WAAKxP,KAAL,GAAaA,KAAb;;AAEA;AACA;AACA;AACA,UAAG,CAAC,KAAKkM,UAAT,EAAqB;AAAE,aAAKA,UAAL,GAAkB,CAAlB;AAAsB;AAC7C,UAAGlM,KAAH,EAAU;AACR,aAAKkM,UAAL;AACD,OAFD,MAEO;AACL,aAAKA,UAAL,GAAkB,CAAlB;AACD;;AAED,UAAGlM,SAAS,CAACwP,oBAAb,EAAmC;AACjC;AACA,aAAKC,iBAAL,GAAyB,IAAIpH,IAAJ,EAAzB;AACD,OAHD,MAGO,IAAG,CAAC,KAAKqH,0BAAL,EAAJ,EAAuC;AAC5C;AACA,aAAKD,iBAAL,GAAyB,IAAIpH,IAAJ,CAAS,KAAK1C,UAAd,CAAzB;AACD;AACF;;;+CAE0B;AACzB;AACD;;;0CAEqBhK,I,EAAM;AAC1BA,WAAKgU,sBAAL,CAA4B,IAA5B;;AAEA,UAAG,KAAKlM,uBAAL,CAA6B9H,IAA7B,CAAH,EAAuC;AACrC;AACD;;AAED,UAAIyC,aAAa,KAAKD,OAAL,CAAaC,UAAb,IAA2B,EAA5C;AACAA,iBAAWjK,IAAX,CAAgB;AACd4J,cAAMpC,KAAKoC,IADG;AAEdnC,sBAAcD,KAAKC;AAFL,OAAhB;AAIA,WAAKuC,OAAL,CAAaC,UAAb,GAA0BA,UAA1B;AACD;;;6CAEwBzC,I,EAAM;AAC7BA,WAAKiU,8BAAL,CAAoC,IAApC;AACA,WAAKC,uBAAL,CAA6BlU,KAAKoC,IAAlC;AACD;;AAED;AACA;AACA;AACA;;;;2CACuBpC,I,EAAM;AAC3B,UAAG,CAACvH,EAAEgP,IAAF,CAAO,KAAKT,kBAAZ,EAAgC,EAAC5E,MAAMpC,KAAKoC,IAAZ,EAAhC,CAAJ,EAAwD;AACtD,aAAK4E,kBAAL,CAAwBxO,IAAxB,CAA6BwH,IAA7B;AACD;AACF;;;mDAE8BA,I,EAAM;AACnCvH,QAAE+O,MAAF,CAAS,KAAKR,kBAAd,EAAkC,EAAC5E,MAAMpC,KAAKoC,IAAZ,EAAlC;AACA;AACA,UAAG,KAAK0F,uBAAL,CAA6B9H,IAA7B,CAAH,EAAuC;AACrC,aAAKkU,uBAAL,CAA6BlU,KAAKoC,IAAlC;AACA;AACA,aAAKM,QAAL,CAAc,IAAd;AACD;AACF;;;4CAEuBN,I,EAAM;AAC5B,UAAIK,aAAa,KAAKD,OAAL,CAAaC,UAAb,IAA2B,EAA5C;AACAA,mBAAaA,WAAWjC,MAAX,CAAkB,UAAC2T,CAAD,EAAO;AAAC,eAAOA,EAAE/R,IAAF,IAAUA,IAAjB;AAAsB,OAAhD,CAAb;AACA,WAAKI,OAAL,CAAaC,UAAb,GAA0BA,UAA1B;AACD;;;4CAEuBzC,I,EAAM;AAC5B,UAAIoU,SAAS,KAAK5R,OAAL,CAAaC,UAAb,CAAwBgF,IAAxB,CAA6B,UAAC0M,CAAD,EAAO;AAC/C,eAAOA,EAAE/R,IAAF,IAAUpC,KAAKoC,IAAtB;AACD,OAFY,CAAb;AAGA,aAAOgS,UAAU,IAAjB;AACD;;;4CAEuB,CAEvB;;;uCAEkB,CAElB;;;iDAE4BrR,O,EAASC,O,EAAS;AAC7C;AACD;;;6DAEwChB,O,EAASe,O,EAASC,O,EAAS;AAClE;AADkE;AAAA;AAAA;;AAAA;AAElE,+BAAqB,KAAKR,OAAL,CAAaC,UAAlC,wIAA8C;AAAA,cAAtCkF,SAAsC;;AAC5C,cAAGA,UAAUvF,IAAV,IAAkBW,OAArB,EAA8B;AAC5B4E,sBAAUvF,IAAV,GAAiBY,OAAjB;AACA,iBAAKN,QAAL,CAAc,IAAd;AACD;AACF;AAPiE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAQnE;;;mCAEc;AACb,aAAO,KAAP;AACD;;AAED;;;;;;sCAIkBlE,G,EAAKmN,K,EAAO0I,M,EAAQ;AACpC,UAAG,CAACA,MAAJ,EAAY;AACVja,gBAAQC,KAAR,CAAc,mCAAd;AACA;AACD;AACD,UAAIzB,OAAO,KAAKka,OAAL,CAAauB,MAAb,CAAX;AACA,UAAG,CAACzb,IAAJ,EAAU;AACRA,eAAO,EAAP;AACD;AACDA,WAAK4F,GAAL,IAAYmN,KAAZ;AACA,WAAKmH,OAAL,CAAauB,MAAb,IAAuBzb,IAAvB;AACD;;;sCAEiB4F,G,EAAK6V,M,EAAQ;AAC7B,UAAG,CAACA,MAAJ,EAAY;AACVja,gBAAQC,KAAR,CAAc,mCAAd;AACA;AACD;AACD,UAAIzB,OAAO,KAAKka,OAAL,CAAauB,MAAb,CAAX;AACA,UAAGzb,IAAH,EAAS;AACP,eAAOA,KAAK4F,GAAL,CAAP;AACD,OAFD,MAEO;AACL,eAAO,IAAP;AACD;AACF;;;mCAEcA,G,EAAKmN,K,EAAO;AACzB,WAAK2I,iBAAL,CAAuB9V,GAAvB,EAA4BmN,KAA5B,EAAmC/E,OAAO2N,SAA1C;AACD;;;mCAEc/V,G,EAAK;AAClB,aAAO,KAAKgW,iBAAL,CAAuBhW,GAAvB,EAA4BoI,OAAO2N,SAAnC,CAAP;AACD;;;iDAmB4B;AAC3B,aAAO,KAAKE,cAAL,CAAoB,mBAApB,KAA4C,IAAnD;AACD;;;;;AAoBD;;;;;8DAK0C;AACxC,aAAO,EAAP;AACD;;AAED;;;;qEACiD;AAC/C,aAAO,CAAC,mBAAD,CAAP;AACD;;;2CAEsBC,S,EAAW;AAChC,UAAIC,OAAO,SAAPA,IAAO,CAACC,GAAD,EAAM/b,IAAN,EAAe;AACxB,YAAG,CAAC+b,GAAJ,EAAS;AAAE,iBAAOA,GAAP;AAAa;AADA;AAAA;AAAA;;AAAA;AAExB,iCAAe/b,IAAf,wIAAqB;AAAA,gBAAb2F,GAAa;;AACnB,mBAAOoW,IAAIpW,GAAJ,CAAP;AACD;AAJuB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAKxB,eAAOoW,GAAP;AACD,OAND;;AAQA,UAAIC,OAAO,KAAKjB,eAAL,EAAX;AACAiB,WAAK/B,OAAL,CAAalM,OAAO2N,SAApB,IAAiCI,KAAKE,KAAK/B,OAAL,CAAalM,OAAO2N,SAApB,CAAL,EAAqC,KAAKO,8CAAL,EAArC,CAAjC;AACAD,aAAOF,KAAKE,IAAL,EAAW,KAAKE,uCAAL,EAAX,CAAP;;AAEA,UAAIC,QAAQN,UAAUd,eAAV,EAAZ;AACAoB,YAAMlC,OAAN,CAAclM,OAAO2N,SAArB,IAAkCI,KAAKK,MAAMlC,OAAN,CAAclM,OAAO2N,SAArB,CAAL,EAAsCG,UAAUI,8CAAV,EAAtC,CAAlC;AACAE,cAAQL,KAAKK,KAAL,EAAYN,UAAUK,uCAAV,EAAZ,CAAR;;AAEA,aAAOxb,KAAKsD,SAAL,CAAegY,IAAf,MAAyBtb,KAAKsD,SAAL,CAAemY,KAAf,CAAhC;AACD;;;uCAEkB3M,S,EAAW;AAC5B;;;;;;;;AAQA,aAAO4M,YAAYC,sBAAZ,CAAmC,IAAnC,EAAyC7M,SAAzC,CAAP;AACD;;AAED;;;;;;sCAIkB;AAChB,aAAO,KAAK8M,qBAAL,CAA2B,KAAKlC,UAAhC,CAAP;AACD;;;sCAEiB;AAChB,aAAO,KAAKkC,qBAAL,CAA2B,KAAKrB,iBAAhC,CAAP;AACD;;;0CAEqBsB,I,EAAM;AAC1B,UAAI,OAAOC,IAAP,KAAgB,WAAhB,IAA+BA,KAAKC,cAAxC,EAAwD;AACtD,YAAI,CAACzC,aAAL,EAAoB;AAClB,cAAI0C,SAAUC,UAAUC,SAAV,IAAuBD,UAAUC,SAAV,CAAoBvX,MAA5C,GAAsDsX,UAAUC,SAAV,CAAoB,CAApB,CAAtD,GAA+ED,UAAUE,QAAtG;AACA7C,0BAAgB,IAAIwC,KAAKC,cAAT,CAAwBC,MAAxB,EAAgC;AAC9CI,kBAAM,SADwC;AAE9CC,mBAAO,OAFuC;AAG9CC,iBAAK,SAHyC;AAI9CC,qBAAS,MAJqC;AAK9CC,kBAAM,SALwC;AAM9CC,oBAAQ;AANsC,WAAhC,CAAhB;AAQD;AACD,eAAOnD,cAAcoD,MAAd,CAAqBb,IAArB,CAAP;AACD,OAbD,MAaO;AACL;AACA;AACA;AACA,eAAOA,KAAKc,YAAL,KAAsB,GAAtB,GAA4Bd,KAAKe,kBAAL,EAAnC;AACD;AACF;;;wBAhXmB;AAClB,UAAG,CAAC,KAAK3T,OAAT,EAAkB;AAChB,aAAKA,OAAL,GAAe,EAAf;AACA,eAAO,KAAKA,OAAZ;AACD;;AAED,UAAG,KAAKA,OAAL,KAAiB,IAAjB,IAAyB,QAAO,KAAKA,OAAZ,MAAwB,QAApD,EAA8D;AAC5D;AACA,eAAO,KAAKA,OAAZ;AACD;;AAED,UAAI;AACF,YAAIA,UAAUjJ,KAAKC,KAAL,CAAW,KAAKgJ,OAAhB,CAAd;AACA,aAAKA,OAAL,GAAeA,OAAf;AACA,eAAO,KAAKA,OAAZ;AACD,OAJD,CAIE,OAAOzE,CAAP,EAAU;AACV3D,gBAAQwG,GAAR,CAAY,oBAAZ,EAAkC7C,CAAlC,EAAqC,IAArC;AACA,aAAKyE,OAAL,GAAe,EAAf;AACA,eAAO,KAAKA,OAAZ;AACD;AACF;;;wBAuOY;AACX,aAAO,KAAKiS,cAAL,CAAoB,QAApB,CAAP;AACD;;;wBAEc;AACb,aAAO,KAAKA,cAAL,CAAoB,UAApB,CAAP;AACD;;;wBAEY;AACX,aAAO,KAAKA,cAAL,CAAoB,QAApB,CAAP;AACD;;AAED;;;;wBACkB;AAChB,aAAO,MAAP;AACD;;;wBAMuB;AACtB,UAAG,CAAC,KAAKjB,kBAAT,EAA6B;AAC3B,YAAI/B,QAAQ,KAAKgD,cAAL,CAAoB,mBAApB,CAAZ;AACA,YAAGhD,KAAH,EAAU;AACR,eAAK+B,kBAAL,GAA0B,IAAI9G,IAAJ,CAAS+E,KAAT,CAA1B;AACD,SAFD,MAEO;AACL,eAAK+B,kBAAL,GAA0B,IAAI9G,IAAJ,CAAS,KAAK1C,UAAd,CAA1B;AACD;AACF;AACD,aAAO,KAAKwJ,kBAAZ;AACD,K;sBAEqB4B,I,EAAM;AAC1B,WAAK5B,kBAAL,GAA0B4B,IAA1B;;AAEA,WAAKgB,cAAL,CAAoB,mBAApB,EAAyChB,IAAzC;AACD;;;8BA1QgBiB,C,EAAGC,C,EAAG;AACrB;AACA;AACA,eAASC,eAAT,CAAyBC,QAAzB,EAAmCC,QAAnC,EAA6C;AAC3C,YAAIhe,EAAEoL,OAAF,CAAU2S,QAAV,CAAJ,EAAyB;AACvB,iBAAOC,QAAP;AACD;AACF;AACDhe,QAAEie,SAAF,CAAYL,CAAZ,EAAeC,CAAf,EAAkBC,eAAlB;AACA,aAAOF,CAAP;AACD;;;;;;AAmVH;IAAchN,Y,WAAAA,Y;AAEZ,wBAAYrJ,IAAZ,EAAkBnH,IAAlB,EAAwBoS,WAAxB,EAAqC;AAAA;;AACnC,SAAKjL,IAAL,GAAYA,IAAZ;AACA,SAAKnH,IAAL,GAAYA,IAAZ;AACA,SAAKoS,WAAL,GAAmBA,WAAnB;;AAEA,QAAG,KAAKpS,IAAL,IAAa,CAAC,KAAKoS,WAAtB,EAAmC;AACjC,YAAM,8DAAN;AACD;;AAED,QAAG,KAAKA,WAAL,IAAoB,CAAC,KAAKA,WAAL,CAAiBxR,OAAzC,EAAkD;AAChD,YAAM,6CAAN;AACD;AACF;;;;;8FAEyBkd,c;;;;;;AACxB,qBAAKtG,gBAAL,GAAwB,CAAC,YAAD,CAAxB;AACA,qBAAKuG,aAAL,GAAqB,IAArB;;qBACGD,c;;;;;mDACM,KAAKE,QAAL,E;;;;uBAEY,KAAKA,QAAL,E;;;AAAfC,sB;mDACGre,EAAEkc,IAAF,CAAOmC,MAAP,EAAe,CAAC,SAAD,CAAf,C;;;;;;;;;;;;;;;;;;;;;;;;mDAKF,KAAKxN,mBAAL,E;;;;;;;;;;;;;;;;;;;;;;;;AAIP,qBAAK+G,gBAAL,GAAwB,CAAC,YAAD,EAAe,OAAf,EAAwB,iBAAxB,CAAxB;AACA,qBAAKuG,aAAL,GAAqB,IAArB;mDACO,KAAKC,QAAL,E;;;;;;;;;;;;;;;;;;;;;;;;mDAIA,KAAKA,QAAL,E;;;;;;;;;;;;;;;;;;;;;;;;;AAKH1f,sB,GAAS,EAACiL,MAAM,KAAKpC,IAAL,CAAUoC,IAAjB,EAAuBnC,cAAc,KAAKD,IAAL,CAAUC,YAA/C,EAA6DsC,SAAS,KAAKvC,IAAL,CAAUuC,OAAhF,EAAyF0Q,YAAY,KAAKjT,IAAL,CAAUiT,UAA/G,E;;oBACT,KAAKjT,IAAL,CAAU2D,e;;;;;AACZ;AACIoT,4B,GAAe,KAAK/W,IAAL,CAAU+W,YAAV,MAA4B,CAAC,KAAKH,a;;sBAClD,KAAK/d,IAAL,IAAa,CAACke,Y;;;;;;uBACa5b,KAAKmQ,eAAL,CAAqB0L,WAArB,CAAiC,KAAKhX,IAAtC,EAA4C,KAAKnH,IAAjD,EAAuD,KAAKoS,WAA5D,C;;;AAAxBgM,+B;;AACJxe,kBAAEyB,KAAF,CAAQ/C,MAAR,EAAgB8f,eAAhB;;AAEA,oBAAG,KAAKhM,WAAL,CAAiBxR,OAAjB,KAA6B,KAAhC,EAAuC;AACrCtC,yBAAOgc,SAAP,GAAmB,IAAnB;AACD;;;;;qBAGgB,KAAKyD,a;;;;;gCAAgB,KAAK5W,IAAL,CAAUkX,+BAAV,E;;;;;;uBAA4D/b,KAAKa,MAAL,CAAYmb,MAAZ,CAAmB5d,KAAKsD,SAAL,CAAe,KAAKmD,IAAL,CAAUkX,+BAAV,EAAf,CAAnB,C;;;;gCAAd,K;;;AAApF/f,uBAAOqL,O;;AACP,oBAAG,CAAC,KAAKoU,aAAT,EAAwB;AACtBzf,yBAAO+b,YAAP,GAAsB,IAAtB;AACA/b,yBAAOgc,SAAP,GAAmB,IAAnB;AACD;;;;;;;AAGH;AACAhc,uBAAOqL,OAAP,GAAiB,KAAKxC,IAAL,CAAUwC,OAA3B;AACArL,uBAAO+b,YAAP,GAAsB,KAAKlT,IAAL,CAAUkT,YAAhC;AACA/b,uBAAOgc,SAAP,GAAmB,KAAKnT,IAAL,CAAUmT,SAA7B;;;;AAGF,oBAAG,KAAK9C,gBAAR,EAA0B;AACxB5X,oBAAEyB,KAAF,CAAQ/C,MAAR,EAAgBsB,EAAE2e,IAAF,CAAO,KAAKpX,IAAZ,EAAkB,KAAKqQ,gBAAvB,CAAhB;AACD;;mDAEMlZ,M;;;;;;;;;;;;;;;;;;;;;AAKX;IAAc8d,W,WAAAA,W;AACZ,uBAAYoC,OAAZ,EAAqBC,QAArB,EAA+B3L,KAA/B,EAAsC;AAAA;;AACpC,SAAK0L,OAAL,GAAeA,OAAf;AACA,SAAKC,QAAL,GAAgBA,QAAhB;AACA,SAAK3L,KAAL,GAAaA,KAAb;AACD;;;;8BAEgB4L,K,EAAO;AACtB,UAAIC,OAAO,IAAIvC,WAAJ,EAAX;AACAuC,WAAKH,OAAL,GAAeE,MAAM,CAAN,CAAf;AACAC,WAAKF,QAAL,GAAgBC,MAAM,CAAN,CAAhB;AACAC,WAAK7L,KAAL,GAAa4L,MAAM,CAAN,CAAb;AACA,aAAOC,IAAP;AACD;;;6CAE+BxS,M,EAAQqD,S,EAAW;AACjD,UAAIoP,iBAAiBpP,UAAUgP,OAAV,CAAkBjS,KAAlB,CAAwB,GAAxB,EAA6BsS,MAA7B,CAAoC,UAACC,QAAD,EAAW1K,OAAX,EAAuB;AAC9E,eAAO0K,YAAYA,SAAS1K,OAAT,CAAnB;AACD,OAFoB,EAElBjI,MAFkB,CAArB;;AAIA,UAAI4S,iBAAiBvP,UAAUsD,KAA/B;AACA,UAAG,OAAOiM,cAAP,IAA0B,QAA1B,IAAsCA,eAAevc,QAAf,CAAwB,MAAxB,CAAzC,EAA0E;AACxEuc,yBAAiB,KAAKC,cAAL,CAAoBD,cAApB,CAAjB;AACD;;AAED,UAAME,eAAe,CAAC,KAAD,EAAQ,EAAR,EAAY,IAAZ,EAAkBzE,SAAlB,EAA6B0E,GAA7B,CAArB;;AAEA,UAAGN,kBAAkBpE,SAArB,EAAgC;AAC9B,eAAOyE,aAAazc,QAAb,CAAsBgN,UAAUsD,KAAhC,CAAP;AACD;;AAED,UAAGtD,UAAUiP,QAAV,IAAsB,GAAzB,EAA8B;AAC5B;AACA,YAAG1T,MAAMC,OAAN,CAAc4T,cAAd,CAAH,EAAkC;AAChC,iBAAOle,KAAKsD,SAAL,CAAe4a,cAAf,KAAkCle,KAAKsD,SAAL,CAAe+a,cAAf,CAAzC;AACD,SAFD,MAEO;AACL,iBAAOH,kBAAkBG,cAAzB;AACD;AACF,OAPD,MAOO,IAAGvP,UAAUiP,QAAV,IAAsB,GAAzB,EAA+B;AACpC,eAAOG,iBAAiBG,cAAxB;AACD,OAFM,MAEA,IAAGvP,UAAUiP,QAAV,IAAsB,GAAzB,EAA+B;AACpC,eAAOG,iBAAiBG,cAAxB;AACD,OAFM,MAEA,IAAGvP,UAAUiP,QAAV,IAAsB,IAAzB,EAAgC;AACrC,eAAOG,kBAAkBG,cAAzB;AACD,OAFM,MAEA,IAAGvP,UAAUiP,QAAV,IAAsB,IAAzB,EAAgC;AACrC,eAAOG,kBAAkBG,cAAzB;AACD,OAFM,MAEA,IAAGvP,UAAUiP,QAAV,IAAsB,YAAzB,EAAwC;AAC7C,eAAOG,eAAeO,UAAf,CAA0BJ,cAA1B,CAAP;AACD,OAFM,MAEA,IAAGvP,UAAUiP,QAAV,IAAsB,IAAzB,EAA+B;AACpC,eAAOM,eAAenX,OAAf,CAAuBgX,cAAvB,KAA0C,CAAC,CAAlD;AACD,OAFM,MAEA,IAAGpP,UAAUiP,QAAV,IAAsB,UAAzB,EAAqC;AAC1C,eAAO,KAAKW,wBAAL,CAA8BR,cAA9B,EAA8CG,cAA9C,CAAP;AACD,OAFM,MAEA,IAAGvP,UAAUiP,QAAV,IAAsB,SAAzB,EAAoC;AACzC,YAAIY,QAAQ,IAAIC,MAAJ,CAAWP,cAAX,CAAZ;AACA,eAAOM,MAAME,IAAN,CAAWX,cAAX,CAAP;AACD;;AAED,aAAO,KAAP;AACD;;;6CAE+BA,c,EAAgBG,c,EAAgB;AAC9D;AACA,UAAG,OAAOA,cAAP,IAA0B,QAA7B,EAAuC;AACrC;AACA,eAAOH,eAAepc,QAAf,CAAwBuc,cAAxB,CAAP;AACD,OAHD,MAGO;AACL;AACA,YAAIS,cAAJ;AACA,YAAGzU,MAAMC,OAAN,CAAc+T,cAAd,CAAH,EAAkC;AAChCS,2BAAiBpD,YAAYqD,SAAZ,CAAsBV,cAAtB,CAAjB;AACD,SAFD,MAEO;AACLS,2BAAiBT,cAAjB;AACD;AAPI;AAAA;AAAA;;AAAA;AAQL,iCAAeH,cAAf,wIAA+B;AAAA,gBAAvB7C,GAAuB;;AAC7B,gBAAG,KAAK2D,wBAAL,CAA8B3D,GAA9B,EAAmCyD,cAAnC,CAAH,EAAuD;AACrD,qBAAO,IAAP;AACD;AACF;AAZI;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAaL,eAAO,KAAP;AACD;AACF;;;2CAE6BrY,I,EAAMqI,S,EAAW;AAC7C,UAAGzE,MAAMC,OAAN,CAAcwE,SAAd,CAAH,EAA6B;AAC3BA,oBAAY4M,YAAYqD,SAAZ,CAAsBjQ,SAAtB,CAAZ;AACD;AACD,aAAO,KAAKkQ,wBAAL,CAA8BvY,IAA9B,EAAoCqI,SAApC,CAAP;AACD;;;4CAE8BrI,I,EAAMuI,U,EAAY;AAAA;AAAA;AAAA;;AAAA;AAC/C,+BAAqBA,UAArB,wIAAiC;AAAA,cAAzBF,SAAyB;;AAC/B,cAAG,CAAC,KAAK6M,sBAAL,CAA4BlV,IAA5B,EAAkCqI,SAAlC,CAAJ,EAAkD;AAChD,mBAAO,KAAP;AACD;AACF;AAL8C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAM/C,aAAO,IAAP;AACD;;;mCAEqBmQ,M,EAAQ;AAC5B;AACA,UAAIC,QAAQD,OAAOpT,KAAP,CAAa,GAAb,CAAZ;AACA,UAAIsT,OAAOD,MAAM,CAAN,CAAX;AACA,UAAIrD,OAAO,IAAI1I,IAAJ,EAAX;AACA,UAAIiM,SAASC,SAASH,MAAM,CAAN,CAAT,CAAb;AACA,UAAGC,QAAQ,MAAX,EAAmB;AACjBtD,aAAKyD,OAAL,CAAazD,KAAK0D,OAAL,KAAiBH,MAA9B;AACD,OAFD,MAEO,IAAGD,QAAQ,OAAX,EAAoB;AACzBtD,aAAK2D,QAAL,CAAc3D,KAAK4D,QAAL,KAAkBL,MAAhC;AACD;AACD,aAAOvD,IAAP;AACD;;;;;;AAEH,C,CAAC;;;;;;;;;AAWD;;IAEa5J,gB,WAAAA,gB;;;AACX,4BAAY9H,QAAZ,EAAsB;AAAA;;AAIpB;;;;;;;AAJoB,sIAEdA,QAFc;;AAWpB,QAAG,CAAC,QAAKlB,OAAL,CAAayW,4BAAjB,EAA+C;AAC7C,cAAKzW,OAAL,CAAayW,4BAAb,GAA4C,EAA5C;AACD;;AAED;AACA,QAAIC,QAAQjb,OAAOpF,IAAP,CAAY,QAAK2J,OAAL,CAAayW,4BAAzB,CAAZ;AACAC,UAAM3R,OAAN,CAAc,UAAC4R,QAAD,EAAc;AAC1B,UAAIC,cAAc,QAAK5W,OAAL,CAAayW,4BAAb,CAA0CE,QAA1C,CAAlB;AACA,cAAK3W,OAAL,CAAayW,4BAAb,CAA0CE,QAA1C,IAAsD,IAAIE,aAAJ,CAAkBD,WAAlB,CAAtD;AACD,KAHD;AAjBoB;AAqBrB;;;;oCAEepZ,I,EAAM;AACpB,UAAIoZ,cAAc,KAAKxO,cAAL,CAAoB5K,IAApB,CAAlB;AACA,UAAIiK,QAAQmP,YAAYtP,sBAAZ,CAAmC9J,IAAnC,CAAZ;AACA,aAAOiK,KAAP;AACD;;;mCAEcjK,I,EAAM;AACnB,UAAIsZ,UAAU,KAAK9W,OAAL,CAAayW,4BAAb,CAA0CjZ,KAAKoC,IAA/C,CAAd;AACA,UAAG,CAACkX,OAAJ,EAAa;AACXA,kBAAU,KAAK9W,OAAL,CAAayW,4BAAb,CAA0CjZ,KAAKoC,IAA/C,IAAuD,IAAIiX,aAAJ,EAAjE;AACD;AACD,aAAOC,OAAP;AACD;;;qCAEgBtZ,I,EAAM;AACrB,WAAK4K,cAAL,CAAoB5K,IAApB,EAA0B6L,KAA1B;AACD;;;sCAEiB;AAChB,WAAKrJ,OAAL,CAAayW,4BAAb,GAA4C,EAA5C;AACD;;;2CAEsBjZ,I,EAAM;AAC3B;AACA;AACA;AACA,UAAIoZ,cAAc,KAAKxO,cAAL,CAAoB5K,IAApB,CAAlB;AACA,UAAGoZ,YAAY7U,OAAZ,CAAoBrG,MAApB,GAA6BsN,iBAAiB+N,6BAAjD,EAAgF;AAC9EH,oBAAYI,QAAZ;AACD;AACF;;;;EAtDmC5S,M;;AAyDtC;;;AACA4E,iBAAiB+N,6BAAjB,GAAiD,EAAjD;AACA,C,CAAC;;IAEYF,a,WAAAA,a;AAEX,2BAAyB;AAAA,QAAbliB,MAAa,uEAAJ,EAAI;;AAAA;;AACvB,QAAG,CAAC,KAAKoN,OAAT,EAAkB;AAChB,WAAKA,OAAL,GAAe,EAAf;AACD;;AAED;AACA,QAAGpN,OAAOoN,OAAV,EAAmB;AAAA;AAAA;AAAA;;AAAA;AACjB,+BAAuBpN,OAAOoN,OAA9B,wIAAuC;AAAA,cAA/BkV,WAA+B;;AACrC,cAAIxP,QAAQ,KAAKyP,kBAAL,CAAwBD,YAAYzZ,IAApC,CAAZ;AACAiK,gBAAM0P,gBAAN,CAAuB,KAAKC,YAAL,EAAvB;AACA,eAAKrV,OAAL,CAAa/L,IAAb,CAAkByR,KAAlB;AACD;AALgB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAMlB;AACF;;;;uCAEkBjK,I,EAAM;AACvB,UAAI6Z,mBAAmBR,cAAcS,wBAAd,IAA0CT,cAAcS,wBAAd,CAAuC9Z,KAAKC,YAA5C,CAAjE;AACA,UAAG,CAAC4Z,gBAAJ,EAAsB;AACpBA,2BAAmBE,kBAAnB;AACD;AACD,UAAI9P,QAAQ,IAAI4P,gBAAJ,CAAqB7Z,IAArB,CAAZ;AACA,aAAOiK,KAAP;AACD;;;mCAEc;AACb,aAAO,KAAK1F,OAAL,CAAa,KAAKA,OAAL,CAAarG,MAAb,GAAsB,CAAnC,CAAP;AACD;;;2CAEsB8B,I,EAAM;AAC3B,UAAIga,mBAAmB,KAAKN,kBAAL,CAAwB1Z,IAAxB,CAAvB;;AAEA,UAAIia,gBAAgB,KAAKL,YAAL,EAApB;AACAI,uBAAiBL,gBAAjB,CAAkCM,aAAlC;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,UAAGD,iBAAiBE,aAAjB,CAA+BD,aAA/B,CAAH,EAAkD;AAChD;AACD;;AAED,WAAK1V,OAAL,CAAa/L,IAAb,CAAkBwhB,gBAAlB;AACA,aAAOA,gBAAP;AACD;;;4BAEO;AACN,WAAKzV,OAAL,CAAarG,MAAb,GAAsB,CAAtB;AACD;;;+BAEU;AAAA;;AACT,UAAIic,cAAc,EAAlB;;AAEA,UAAIC,qBAAqB,SAArBA,kBAAqB,CAACnQ,KAAD,EAAW;AAClC,eAAOA,MAAMoQ,SAAN,KAAoBhB,cAAciB,wBAAzC;AACD,OAFD;;AAIA,UAAIC,eAAe,SAAfA,YAAe,CAACtQ,KAAD,EAAQzF,KAAR,EAAegW,IAAf,EAAwB;AACzC;AACA,YAAGA,IAAH,EAAS;AACPL,sBAAY3hB,IAAZ,CAAiByR,KAAjB;AACD,SAFD,MAEO;AACL;AACA,cAAIzF,QAAQ2V,YAAY1Z,OAAZ,CAAoBwJ,KAApB,CAAZ;AACA,cAAGzF,UAAU,CAAC,CAAd,EAAiB;AACf2V,wBAAYM,MAAZ,CAAmBjW,KAAnB,EAA0B,CAA1B;AACD;AACF;;AAED,YAAGgW,QAAQJ,mBAAmBnQ,KAAnB,CAAR,IAAqCA,MAAMyQ,eAAN,MAA2B,CAAC,CAApE,EAAuE;AACrE;AACA,cAAIT,gBAAgB,QAAK1V,OAAL,CAAaC,QAAQ,CAArB,CAApB;AACA,cAAGyV,aAAH,EAAkB;AAChBE,wBAAY3hB,IAAZ,CAAiByhB,aAAjB;AACD;AACF;AACF,OAnBD;;AAqBA,WAAK1V,OAAL,CAAagD,OAAb,CAAqB,UAAC0C,KAAD,EAAQzF,KAAR,EAAkB;AACrC,YAAGA,SAAS,CAAT,IAAcA,SAAS,QAAKD,OAAL,CAAarG,MAAb,GAAsB,CAAhD,EAAmD;AACjD;AACAqc,uBAAatQ,KAAb,EAAoBzF,KAApB,EAA2B,IAA3B;AACD,SAHD,MAGO;AACL,cAAImW,cAAcP,mBAAmBnQ,KAAnB,CAAlB;AACAsQ,uBAAatQ,KAAb,EAAoBzF,KAApB,EAA2BmW,WAA3B;AACD;AACF,OARD;;AAUA,WAAKpW,OAAL,GAAe,KAAKA,OAAL,CAAa/D,MAAb,CAAoB,UAACyJ,KAAD,EAAQzF,KAAR,EAAkB;AACnD,eAAO2V,YAAY1Z,OAAZ,CAAoBwJ,KAApB,MAA+B,CAAC,CAAvC;AACD,OAFc,CAAf;AAGD;;;;;;AAGH;;;AACAoP,cAAciB,wBAAd,GAAyC,EAAzC;AACA;IAAcP,kB,WAAAA,kB;AAEZ,8BAAY/Z,IAAZ,EAAkB;AAAA;;AAChB;AACA,SAAKA,IAAL,GAAY4G,OAAO2M,SAAP,CAAiB,EAAjB,EAAqBvT,IAArB,CAAZ;;AAEA;AACA,SAAK4a,yBAAL,GAAiC,MAAjC;;AAEA;AACA,SAAKC,kBAAL,GAA0B,CAA1B;;AAEA,QAAG,OAAO,KAAK7a,IAAL,CAAUgK,UAAjB,IAA+B,QAAlC,EAA4C;AAC1C,WAAKhK,IAAL,CAAUgK,UAAV,GAAuB,IAAI0C,IAAJ,CAAS,KAAK1M,IAAL,CAAUgK,UAAnB,CAAvB;AACD;AACF;;;;qCAEgBiQ,a,EAAe;AAC9B,WAAKa,gBAAL,GAAwBb,iBAAiB,IAAzC;;AAEA;AACA,UAAG,KAAKja,IAAL,CAAUwC,OAAV,CAAkB,KAAKoY,yBAAvB,CAAH,EAAsD;AACpD,YAAGX,aAAH,EAAkB;AAChB,eAAKY,kBAAL,GAA0B,KAAK7a,IAAL,CAAUwC,OAAV,CAAkB,KAAKoY,yBAAvB,EAAkD1c,MAAlD,GAA2D+b,cAAcja,IAAd,CAAmBwC,OAAnB,CAA2B,KAAKoY,yBAAhC,EAA2D1c,MAAhJ;AACD,SAFD,MAEO;AACL,eAAK2c,kBAAL,GAA0B,KAAK7a,IAAL,CAAUwC,OAAV,CAAkB,KAAKoY,yBAAvB,EAAkD1c,MAA5E;AACD;AACF;AACF;;;sCAEiB;AAChB;AACA,UAAG,KAAK2c,kBAAL,IAA2BxH,SAA9B,EAAyC;AACvC,YAAG,CAAC,KAAKyH,gBAAN,IAA0B,KAAKD,kBAAL,IAA2B,CAAxD,EAA2D;AACzD,iBAAO,CAAP;AACD,SAFD,MAEO,IAAG,KAAKA,kBAAL,GAA0B,CAA7B,EAAgC;AACrC,iBAAO,CAAC,CAAR;AACD,SAFM,MAEA;AACL,iBAAO,CAAP;AACD;AACF;;AAED;AACA,aAAO,CAAP;AACD;;;gCAEW;AACV;AACA;;AAEA;AACA,UAAG,KAAKA,kBAAL,IAA2BxH,SAA9B,EAAyC;AACvC,eAAO0H,KAAKC,GAAL,CAAS,KAAKH,kBAAd,CAAP;AACD;;AAED;AACA;AACA,aAAO,CAAP;AACD;;;kCAEa5Q,K,EAAO;AACnB,UAAG,CAACA,KAAJ,EAAW;AACT,eAAO,KAAP;AACD;;AAED,UAAIgR,MAAM,IAAIrU,MAAJ,CAAW,KAAK5G,IAAhB,CAAV;AACA,UAAIkb,MAAM,IAAItU,MAAJ,CAAWqD,MAAMjK,IAAjB,CAAV;AACA,aAAOib,IAAIlS,sBAAJ,CAA2BmS,GAA3B,CAAP;AACD;;;;;;AAGH,C,CAAC;;AAED,IAAIle,cAAc,OAAOzF,MAAP,KAAkB,WAAlB,GAAgCA,MAAhC,GAA0C,OAAO0F,MAAP,KAAkB,WAAlB,GAAgCA,MAAhC,GAAyC,IAArG;;IAEake,gB,WAAAA,gB;AAEX,8BAAc;AAAA;;AACZ,SAAKC,mBAAL,GAA2B,GAA3B;AACD;;AAED;;;;;;;uCAKmB;AACjB,UAAIpf,SAASgB,YAAYhB,MAAZ,IAAsBgB,YAAYqe,QAA/C;AACA,UAAGrf,MAAH,EAAW;AACT,YAAIsf,MAAM,IAAIC,WAAJ,CAAgB,CAAhB,CAAV;AACAvf,eAAOwf,eAAP,CAAuBF,GAAvB;AACA,YAAIG,MAAM,CAAC,CAAX;AACA,eAAO,uCAAuCC,OAAvC,CAA+C,OAA/C,EAAwD,UAASC,CAAT,EAAY;AACvEF;AACA,cAAItH,IAAKmH,IAAIG,OAAK,CAAT,KAAiBA,MAAI,CAAL,GAAQ,CAAzB,GAA6B,EAArC;AACA,cAAIG,IAAID,KAAK,GAAL,GAAWxH,CAAX,GAAgBA,IAAE,GAAF,GAAM,GAA9B;AACA,iBAAOyH,EAAEC,QAAF,CAAW,EAAX,CAAP;AACH,SALM,CAAP;AAMD,OAVD,MAUO;AACL,YAAIC,IAAI,IAAIpP,IAAJ,GAAWqP,OAAX,EAAR;AACA,YAAG/e,YAAYgf,WAAZ,IAA2B,OAAOhf,YAAYgf,WAAZ,CAAwBC,GAA/B,KAAuC,UAArE,EAAgF;AAC9EH,eAAKE,YAAYC,GAAZ,EAAL,CAD8E,CACtD;AACzB;AACD,YAAI7Z,OAAO,uCAAuCsZ,OAAvC,CAA+C,OAA/C,EAAwD,UAASC,CAAT,EAAY;AAC7E,cAAIxH,IAAI,CAAC2H,IAAIf,KAAKmB,MAAL,KAAc,EAAnB,IAAuB,EAAvB,GAA4B,CAApC;AACAJ,cAAIf,KAAKoB,KAAL,CAAWL,IAAE,EAAb,CAAJ;AACA,iBAAO,CAACH,KAAG,GAAH,GAASxH,CAAT,GAAcA,IAAE,GAAF,GAAM,GAArB,EAA2B0H,QAA3B,CAAoC,EAApC,CAAP;AACD,SAJU,CAAX;AAKA,eAAOzZ,IAAP;AACD;AACF;;;;;;;;;mDAGQ,KAAK2Q,gBAAL,E;;;;;;;;;;;;;;;;;;;;yFAGuF,E;YAA7EqJ,gB,UAAAA,gB;YAAkBC,iB,UAAAA,iB;YAAmBC,a,UAAAA,a;YAAeC,E,UAAAA,E;YAAIC,Q,UAAAA,Q;YAAUC,O,UAAAA,O;;YAAeC,Y;;;;;;sBAC/FA,gBAAgB,CAACF,Q;;;;;AAClBpiB,wBAAQC,KAAR,CAAc,wBAAd;;;;qBAICmiB,Q;;;;;;uBACyB,KAAKG,OAAL,CAAaP,gBAAb,EAA+BK,OAA/B,C;;;AAAtBG,6B;;sBACDJ,aAAaI,a;;;;;AACdxiB,wBAAQC,KAAR,CAAc,2CAAd;mDACO,I;;;AAIPwiB,uB,GAAUC,SAASC,GAAT,CAAaC,GAAb,CAAiBxjB,KAAjB,CAAuB8iB,aAAvB,C;AACVW,sB,GAAUH,SAASC,GAAT,CAAaC,GAAb,CAAiBxjB,KAAjB,CAAuB+iB,MAAM,EAA7B,C;AACVW,yB,GAAYJ,SAASK,GAAT,CAAaC,OAAb,CAAqBf,iBAArB,EAAwCQ,OAAxC,EAAiD,EAAEN,IAAIU,MAAN,EAAeI,MAAMP,SAASO,IAAT,CAAcC,GAAnC,EAAwCC,SAAST,SAASU,GAAT,CAAaC,KAA9D,EAAjD,C;mDACTP,UAAUrB,QAAV,CAAmBiB,SAASC,GAAT,CAAaW,IAAhC,C;;;;;;;;;;;;;;;;;;;8FAGSjmB,I,EAAM+G,G,EAAK+d,E;;;;;;AACvBM,uB,GAAUC,SAASC,GAAT,CAAaC,GAAb,CAAiBxjB,KAAjB,CAAuBgF,GAAvB,C;AACVye,sB,GAAUH,SAASC,GAAT,CAAaC,GAAb,CAAiBxjB,KAAjB,CAAuB+iB,MAAM,EAA7B,C;AACVoB,yB,GAAYb,SAASK,GAAT,CAAaS,OAAb,CAAqBnmB,IAArB,EAA2BolB,OAA3B,EAAoC,EAAEN,IAAIU,MAAN,EAAeI,MAAMP,SAASO,IAAT,CAAcC,GAAnC,EAAwCC,SAAST,SAASU,GAAT,CAAaC,KAA9D,EAApC,C;mDACTE,UAAU9B,QAAV,E;;;;;;;;;;;;;;;;;;;8FAGegC,I;;;;;mDACff,SAASgB,GAAT,CAAaC,SAAb,CAAuB7B,MAAvB,CAA8B2B,OAAK,CAAnC,EAAsChC,QAAtC,E;;;;;;;;;;;;;;;;;;;;;;;;;AAIP;AACI3d,sB,GAAS,G;AAAS8f,oB,GAAO,C;;uBACZ,KAAKC,iBAAL,CAAuB/f,MAAvB,C;;;AAAbggB,oB;;uBACmB,KAAKD,iBAAL,CAAuB/f,MAAvB,C;;;AAAnBigB,0B;mDACG,KAAKC,MAAL,CAAYD,UAAZ,EAAwBD,IAAxB,EAA8BF,IAA9B,EAAoC9f,MAApC,C;;;;;;;;;;;;;;;;;;;8FAGYM,G;;;;;mDACZA,IAAI6f,SAAJ,CAAc,CAAd,EAAiB7f,IAAIN,MAAJ,GAAW,CAA5B,C;;;;;;;;;;;;;;;;;;;8FAGaM,G;;;;;mDACbA,IAAI6f,SAAJ,CAAc7f,IAAIN,MAAJ,GAAW,CAAzB,EAA4BM,IAAIN,MAAhC,C;;;;;;;;;;;;;;;;;;;8FAGIzG,I;;;;;mDACJuF,YAAYoD,IAAZ,CAAiB3B,mBAAmBhH,IAAnB,EAAyBikB,OAAzB,CAAiC,iBAAjC,EACtB,SAAS4C,YAAT,CAAsBC,KAAtB,EAA6BC,EAA7B,EAAiC;AAC/B,yBAAOC,OAAOC,YAAP,CAAoB,OAAOF,EAA3B,CAAP;AACH,iBAHuB,CAAjB,C;;;;;;;;;;;;;;;;;;;8FAMUG,Y;;;;;mDACV3hB,YAAYqD,IAAZ,CAAiBse,YAAjB,C;;;;;;;;;;;;;;;;;;;8FAGIlnB,I;;;;;mDACJqlB,SAAS8B,MAAT,CAAgBnnB,IAAhB,EAAsBokB,QAAtB,E;;;;;;;;;;;;;;;;;;;8FAGKvhB,O,EAASkE,G;;;;;;AACjBqe,uB,GAAUC,SAASC,GAAT,CAAaC,GAAb,CAAiBxjB,KAAjB,CAAuBgF,GAAvB,C;AACVqgB,2B,GAAc/B,SAASC,GAAT,CAAaW,IAAb,CAAkBlkB,KAAlB,CAAwBc,OAAxB,C;AACdwc,sB,GAASgG,SAASgC,UAAT,CAAoBD,WAApB,EAAiChC,OAAjC,EAA0ChB,QAA1C,E;mDACN/E,M;;;;;;;;;;;;;;;;;;;8FAGU9b,U,EAAYvB,O,EAASukB,I,EAAMe,K;;;;;;;uBACzB,KAAKC,MAAL,CAAY,CAAChkB,UAAD,EAAa,IAAb,EAAmBvB,OAAnB,EAA4BukB,IAA5B,EAAkCe,KAAlC,EAAyCrgB,IAAzC,CAA8C,GAA9C,CAAZ,C;;;AAAfoY,sB;mDACGA,M;;;;;;;;;;;;;;;;;AAGT;;;;;;yFAC8D,E;YAA9Bpc,Q,UAAAA,Q;YAAUukB,O,UAAAA,O;YAAS/jB,O,UAAAA,O;;;;;;;;uBAC9B,KAAKkjB,MAAL,CAAY1jB,QAAZ,EAAsBukB,OAAtB,EAA+B/jB,OAA/B,EAAwC,KAAKkgB,mBAA7C,C;;;AAAf8D,sB;AACAC,4B,GAAeD,OAAOhhB,M;AACtBkhB,2B,GAAcD,eAAa,C;AAC3BE,0B,GAAaH,OAAO1Z,KAAP,CAAa,CAAb,EAAgB4Z,WAAhB,C;AACbE,2B,GAAcJ,OAAO1Z,KAAP,CAAa4Z,WAAb,EAA0BA,cAAc,CAAxC,C;AACdG,0B,GAAaL,OAAO1Z,KAAP,CAAa4Z,cAAc,CAA3B,EAA8BA,cAAc,CAA5C,C;mDACV,CAACC,UAAD,EAAaC,WAAb,EAA0BC,UAA1B,C;;;;;;;;;;;;;;;;;;;8FAG0B7kB,Q,EAAUd,U;;;;;;sBAGxCA,WAAWH,OAAX,IAAsB,K;;;;;oBACnBG,WAAWoB,U;;;;;AACbZ,wBAAQC,KAAR,CAAc,mCAAd;;;;;uBAIc,KAAKmlB,YAAL,CAAkB5lB,WAAWoB,UAA7B,EAAyCpB,WAAWH,OAApD,EAA6DG,WAAWsB,OAAxE,EAAiFtB,WAAW6lB,QAA5F,C;;;AAAhBR,uB;;;;;AAEA;AACAA,0BAAUrlB,WAAWqlB,OAArB;;;mDAGK,KAAKS,wBAAL,CAA8B,EAAChlB,UAAUA,QAAX,EAAqBukB,SAASA,OAA9B,EAAuC/jB,SAAStB,WAAWsB,OAA3D,EAA9B,EACN9B,IADM,CACD,UAACP,IAAD,EAAU;AACd,sBAAI8mB,WAAW,EAACzjB,IAAIrD,KAAK,CAAL,CAAL,EAAcG,IAAIH,KAAK,CAAL,CAAlB,EAA2BI,IAAIJ,KAAK,CAAL,CAA/B,EAAf;AACA,yBAAO8mB,QAAP;AACA,iBAJK,C;;;;;;;;;;;;;;;;;AAOR;;;;;8FAC6C3kB,U,EAAYN,Q;;;;;;AACpDjB,uB,GAAU,KAAK0B,IAAL,CAAU1B,O;AACpByB,uB,GAAU,KAAKC,IAAL,CAAUykB,6B;;uBACH,KAAK3B,iBAAL,CAAuB,GAAvB,C;;;AAAjBwB,wB;;uBACgB,KAAKD,YAAL,CAAkBxkB,UAAlB,EAA8BvB,OAA9B,EAAuCyB,OAAvC,EAAgDukB,QAAhD,C;;;AAAhBR,uB;mDAEG,KAAKS,wBAAL,CAA8B,EAAChlB,UAAUA,QAAX,EAAqBukB,SAASA,OAA9B,EAAuC/jB,SAASA,OAAhD,EAA9B,EACN9B,IADM,CACD,UAACP,IAAD,EAAU;AACd,sBAAIe,aAAa,EAAC6lB,UAAUA,QAAX,EAAqBvkB,SAASA,OAA9B,EAAuCF,YAAYA,UAAnD,EAA+DvB,SAASA,OAAxE,EAAjB;AACA,sBAAIkmB,WAAW,EAACzjB,IAAIrD,KAAK,CAAL,CAAL,EAAcG,IAAIH,KAAK,CAAL,CAAlB,EAA2BI,IAAIJ,KAAK,CAAL,CAA/B,EAAf;AACA,yBAAO,EAACA,MAAM8mB,QAAP,EAAiB/lB,YAAYA,UAA7B,EAAP;AACD,iBALM,C;;;;;;;;;;;;;;;;;;;;;AASX;IAAcimB,U,WAAAA,U;;;;;;;;;;;;8FAECnlB,Q,EAAUukB,O,EAAS/jB,O,EAASgD,M;;;;;;AACnC/G,sB,GAAS;AACX2oB,2BAAS5hB,SAAO,EADL;AAEX6hB,0BAAQjD,SAASkD,IAAT,CAAcC,MAFX;AAGXC,8BAAYhlB;AAHD,iB;mDAMN4hB,SAASqD,MAAT,CAAgBzlB,QAAhB,EAA0BukB,OAA1B,EAAmC9nB,MAAnC,EAA2C0kB,QAA3C,E;;;;;;;;;;;;;;;;;;;EATsBV,gB;;AAajC,CAAC,IAAIne,cAAc,OAAOzF,MAAP,KAAkB,WAAlB,GAAgCA,MAAhC,GAA0C,OAAO0F,MAAP,KAAkB,WAAlB,GAAgCA,MAAhC,GAAyC,IAArG;;AAED,IAAMmjB,eAAepjB,YAAYhB,MAAZ,GAAqBgB,YAAYhB,MAAZ,CAAmBqkB,MAAxC,GAAiD,IAAtE;;IAEaC,W,WAAAA,W;;;;;;;;;;;;;AAEX;;;;;8FAIa5lB,Q,EAAUukB,O,EAAS/jB,O,EAASgD,M;;;;;;;uBACvB,KAAKqiB,kBAAL,CAAwB7lB,QAAxB,EAAkC,QAAlC,EAA4C,CAAC,YAAD,CAA5C,C;;;AAAZ8D,mB;;oBACAA,G;;;;;AACFpE,wBAAQwG,GAAR,CAAY,iCAAZ;mDACO,I;;;mDAGF,KAAK4f,mBAAL,CAAyBhiB,GAAzB,EAA8BygB,OAA9B,EAAuC/jB,OAAvC,EAAgDgD,MAAhD,C;;;;;;;;;;;;;;;;;;;8FAGe2f,I;;;;;;;;AAClB4C,2B,GAAc,I;mDACXL,aAAaM,WAAb,CAAyB,EAAC/f,MAAM,SAAP,EAAkBzC,QAAQ2f,IAA1B,EAAzB,EAA0D4C,WAA1D,EAAuE,CAAC,SAAD,EAAY,SAAZ,CAAvE,EAA+FrnB,IAA/F,CAAoG,UAACunB,SAAD,EAAe;AACxH,yBAAOP,aAAaQ,SAAb,CAAuB,KAAvB,EAA8BD,SAA9B,EAAyCvnB,IAAzC;AAAA,0FAA8C,mBAAOyjB,OAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qCACnC,QAAKgE,sBAAL,CAA4B,IAAIC,UAAJ,CAAejE,OAAf,CAA5B,CADmC;;AAAA;AAC/Cre,iCAD+C;AAAA,iEAE5CA,GAF4C;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qBAA9C;;AAAA;AAAA;AAAA;AAAA,uBAIN7C,KAJM,CAIA,UAAColB,GAAD,EAAS;AACd3mB,4BAAQC,KAAR,CAAc,qBAAd,EAAqC0mB,GAArC;AACD,mBANM,CAAP;AAOD,iBARM,EASNplB,KATM,CASA,UAAColB,GAAD,EAAS;AACd3mB,0BAAQC,KAAR,CAAc,sBAAd,EAAsC0mB,GAAtC;AACD,iBAXM,C;;;;;;;;;;;;;;;;;;;;;;;;;AAeP;AACI7iB,sB,GAAS,G;mDACN9G,QAAQ+R,GAAR,CAAY,CACjB,KAAK8U,iBAAL,CAAuB/f,MAAvB,CADiB,EAEjB,KAAK+f,iBAAL,CAAuB/f,MAAvB,CAFiB,CAAZ,EAGJ9E,IAHI,CAGC,UAAC4nB,MAAD,EAAY;AAClB,yBAAOA,OAAOtiB,IAAP,CAAY,EAAZ,CAAP;AACD,iBALM,C;;;;;;;;;;;;;;;;;AAQT;;;;;+FAEkBjH,I,EAAM+G,G,EAAK+d,E;;;;;;;;qBAEdA,E;;;;;;uBAAW,KAAK0E,sBAAL,CAA4B1E,EAA5B,C;;;;;;;;gCAAkC,IAAI2E,WAAJ,CAAgB,EAAhB,C;;;AAAtDjE,sB;AACEkE,mB,GAAM,EAAExgB,MAAM,SAAR,EAAmB4b,IAAIU,MAAvB,E;;uBAEY,KAAKgE,sBAAL,CAA4BziB,GAA5B,C;;;AAAlB4iB,yB;;uBACc,KAAKb,kBAAL,CAAwBa,SAAxB,EAAmCD,IAAIxgB,IAAvC,EAA6C,CAAC,SAAD,CAA7C,C;;;AAAhBkc,uB;;uBACiB,KAAKwE,mBAAL,CAAyB5pB,IAAzB,C;;;AAAjB6pB,wB;mDAEGtlB,OAAOqkB,MAAP,CAAczC,OAAd,CAAsBuD,GAAtB,EAA2BtE,OAA3B,EAAoCyE,QAApC,EAA8CloB,IAA9C;AAAA,wFAAmD,mBAAO0d,MAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mCACrC,QAAKyK,mBAAL,CAAyBzK,MAAzB,CADqC;;AAAA;AACpD0K,kCADoD;AAAA,+DAEjDA,MAFiD;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAAnD;;AAAA;AAAA;AAAA;AAAA,oB;;;;;;;;;;;;;;;;;;;;;;0FAMuF,E;YAA7EpF,gB,WAAAA,gB;YAAkBC,iB,WAAAA,iB;YAAmBC,a,WAAAA,a;YAAeC,E,WAAAA,E;YAAIC,Q,WAAAA,Q;YAAUC,O,WAAAA,O;;YAAeC,Y;;;;;;sBAC/FA,gBAAgB,CAACF,Q;;;;;AAClBpiB,wBAAQC,KAAR,CAAc,wBAAd;;;;qBAICmiB,Q;;;;;;uBACyB,KAAKG,OAAL,CAAaP,gBAAb,EAA+BK,OAA/B,C;;;AAAtBG,6B;;sBACDJ,aAAaI,a;;;;;AACdxiB,wBAAQC,KAAR,gDAA2DmiB,QAA3D,YAA0EI,aAA1E;mDACO,I;;;qBAKEL,E;;;;;;uBAAW,KAAK0E,sBAAL,CAA4B1E,EAA5B,C;;;;;;;;gCAAkC,IAAI2E,WAAJ,CAAgB,EAAhB,C;;;AAAtDjE,sB;AACEkE,mB,GAAM,EAAExgB,MAAM,SAAR,EAAmB4b,IAAIU,MAAvB,E;;uBAEY,KAAKgE,sBAAL,CAA4B3E,aAA5B,C;;;AAAlB8E,yB;;uBACc,KAAKb,kBAAL,CAAwBa,SAAxB,EAAmCD,IAAIxgB,IAAvC,EAA6C,CAAC,SAAD,CAA7C,C;;;AAAhBkc,uB;;uBACiB,KAAK4E,mBAAL,CAAyBpF,iBAAzB,C;;;AAAjBiF,wB;mDAEGtlB,OAAOqkB,MAAP,CAAcjD,OAAd,CAAsB+D,GAAtB,EAA2BtE,OAA3B,EAAoCyE,QAApC,EAA8CloB,IAA9C;AAAA,wFAAmD,mBAAO0d,MAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mCACpC,QAAK4K,mBAAL,CAAyB5K,MAAzB,CADoC;;AAAA;AACpD6K,mCADoD;AAAA,+DAEjDA,OAFiD;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAAnD;;AAAA;AAAA;AAAA;AAAA,qBAGJhmB,KAHI,CAGE,UAACtB,KAAD,EAAW;AAClBD,0BAAQC,KAAR,CAAc,mBAAd,EAAmCA,KAAnC;AACD,iBALM,C;;;;;;;;;;;;;;;;;AAQT;;;;;;;gGAIyBunB,K,EAAOT,G,EAAKU,O,EAASC,I;;;;;;sBACjC,OAAOF,KAAP,KAAiB,Q;;;;;;uBAAiB,KAAKP,mBAAL,CAAyBO,KAAzB,C;;;;;;;;iCAAkCA,K;;;AAA3EnqB,oB;oDACG2oB,aAAa2B,SAAb,CAAuB,KAAvB,EAA8BtqB,IAA9B,EAAoC,EAAEkJ,MAAMwgB,GAAR,EAAaW,MAAMA,IAAnB,EAApC,EAA+D,KAA/D,EAAsED,OAAtE,EACNzoB,IADM,CACD,UAACoF,GAAD,EAAS;AACb,yBAAOA,GAAP;AACD,iBAHM,EAIN7C,KAJM,CAIA,UAAColB,GAAD,EAAS;AACd3mB,0BAAQC,KAAR,CAAc0mB,GAAd;AACA,yBAAO,IAAP;AACD,iBAPM,C;;;;;;;;;;;;;;;;AAST;;;;;gGAC0BviB,G,EAAKygB,O,EAAS/jB,O,EAASgD,M;;;;;;;;;uBAGjC,KAAKmjB,mBAAL,CAAyBpC,OAAzB,C;;;;iCACA/jB,O;iCACN,EAACyF,MAAM,SAAP,E;AAJJxJ,sB;AACF,wB,EAAQ,Q;AACR+mB,sB;AACAgC,4B;AACA4B,sB;;oDAGK1B,aAAa4B,UAAb,CAAwB7qB,MAAxB,EAAgCqH,GAAhC,EAAqCN,MAArC,EACN9E,IADM;AAAA,wFACD,oBAAOykB,IAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mCACY,QAAKgD,sBAAL,CAA4B,IAAIC,UAAJ,CAAejD,IAAf,CAA5B,CADZ;;AAAA;AACArf,+BADA;AAAA,gEAEGA,GAFH;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBADC;;AAAA;AAAA;AAAA;AAAA,qBAKN7C,KALM,CAKA,UAAColB,GAAD,EAAS;AACd3mB,0BAAQC,KAAR,CAAc0mB,GAAd;AACA,yBAAO,IAAP;AACD,iBARM,C;;;;;;;;;;;;;;;;;;;gGAWiBvI,M;;;;;oDAEjB,IAAIphB,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,sBAAI2qB,OAAO,IAAIC,IAAJ,CAAS,CAAC1J,MAAD,CAAT,CAAX;AACA,sBAAI2J,IAAI,IAAIC,UAAJ,EAAR;AACAD,oBAAEE,MAAF,GAAW,UAAStkB,CAAT,EAAY;AACrB1G,4BAAQ0G,EAAEqW,MAAF,CAAS0C,MAAjB;AACD,mBAFD;AAGAqL,oBAAEG,iBAAF,CAAoBL,IAApB;AACD,iBAPM,C;;;;;;;;;;;;;;;;;;;gGAUiBM,W;;;;;oDAEjB,IAAInrB,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,sBAAI2qB,OAAO,IAAIC,IAAJ,CAAS,CAACK,WAAD,CAAT,CAAX;AACA,sBAAIJ,IAAI,IAAIC,UAAJ,EAAR;AACAD,oBAAEE,MAAF,GAAW,UAAStkB,CAAT,EAAY;AACrB1G,4BAAQ0G,EAAEqW,MAAF,CAAS0C,MAAjB;AACD,mBAFD;AAGAqL,oBAAEK,UAAF,CAAaP,IAAb;AACD,iBAPM,C;;;;;;;;;;;;;;;;;;;gGAUoBM,W;;;;;;AACvBE,yB,GAAY,IAAI3B,UAAJ,CAAeyB,WAAf,C;AACZG,yB,GAAY,E;;;AAGhB,qBAASC,CAAT,GAAW,CAAX,EAAcA,IAAEF,UAAUG,UAA1B,EAAsCD,GAAtC,EAA2C;AACzCE,gCAAcJ,UAAUE,CAAV,EAAa9G,QAAb,CAAsB,EAAtB,CAAd;AACA,sBAAGgH,YAAY3kB,MAAZ,GAAqB,CAAxB,EAA2B;AACzB2kB,kCAAc,MAAMA,WAApB;AACD;AACDH,+BAAaG,WAAb;AACD;oDACMH,S;;;;;;;;;;;;;;;;;;;gGAGoBI,G;;;;;;AAC3B,qBAASC,KAAT,GAAiB,EAAjB,EAAqBpH,CAArB,GAAyB,CAAzB,EAA4BA,IAAImH,IAAI5kB,MAApC,EAA4Cyd,KAAK,CAAjD;AACAoH,wBAAMvqB,IAAN,CAAWogB,SAASkK,IAAIE,MAAJ,CAAWrH,CAAX,EAAc,CAAd,CAAT,EAA2B,EAA3B,CAAX;AADA,iB,oCAEO,IAAImF,UAAJ,CAAeiC,KAAf,C;;;;;;;;;;;;;;;;;;;gGAGiB5L,M;;;;;;;uBACE,KAAK8L,YAAL,CAAkB9L,MAAlB,C;;;AAAtB+L,6B;AACAC,mB,GAAMD,cAAchlB,M;AACpB6kB,qB,GAAQ,IAAIjC,UAAJ,CAAeqC,GAAf,C;;AACZ,qBAAQR,CAAR,GAAY,CAAZ,EAAeA,IAAIQ,GAAnB,EAAwBR,GAAxB,EAAoC;AAClCI,wBAAMJ,CAAN,IAAWO,cAAcE,UAAd,CAAyBT,CAAzB,CAAX;AACD;oDACMI,MAAMM,M;;;;;;;;;;;;;;;;;;;gGAGWA,M;;;;;oDACjB,IAAIjsB,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,sBAAI2qB,OAAO,IAAIC,IAAJ,CAAS,CAACmB,MAAD,CAAT,EAAkB,EAACC,MAAK,0BAAN,EAAlB,CAAX;AACA,sBAAIC,SAAS,IAAInB,UAAJ,EAAb;AACAmB,yBAAOlB,MAAP,GAAgB,UAASmB,GAAT,EAAa;AAC3B,wBAAIC,UAAUD,IAAIpP,MAAJ,CAAW0C,MAAzB;AACAzf,4BAAQosB,QAAQT,MAAR,CAAeS,QAAQhjB,OAAR,CAAgB,GAAhB,IAAuB,CAAtC,CAAR;AACD,mBAHD;AAIA8iB,yBAAOG,aAAP,CAAqBzB,IAArB;AACD,iBARM,C;;;;;;;;;;;;;;;;;;;gGAWK3nB,O,EAASkE,G;;;;;;;;;uBACE,KAAKyiB,sBAAL,CAA4BziB,GAA5B,C;;;AAAnBmlB,0B;;uBACgB,KAAKpD,kBAAL,CAAwBoD,UAAxB,EAAoC,MAApC,EAA4C,CAAC,MAAD,CAA5C,EAAsD,EAAChjB,MAAM,SAAP,EAAtD,C;;;AAAhBkc,uB;;uBACoB,KAAKwE,mBAAL,CAAyB/mB,OAAzB,C;;;AAApBukB,2B;oDACG7iB,OAAOqkB,MAAP,CAAcuD,IAAd,CAAmB,EAACjjB,MAAM,MAAP,EAAnB,EAAmCkc,OAAnC,EAA4CgC,WAA5C,EACNzlB,IADM;AAAA,wFACD,oBAAOyqB,SAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mCACa,QAAKhD,sBAAL,CAA4BgD,SAA5B,CADb;;AAAA;AACA/B,gCADA;AAAA,gEAEGA,IAFH;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBADC;;AAAA;AAAA;AAAA;AAAA,qBAKNnmB,KALM,CAKA,UAASolB,GAAT,EAAa;AAClB3mB,0BAAQC,KAAR,CAAc,sBAAd;AACD,iBAPM,C;;;;;;;;;;;;;;;;;;;EApMsB8gB,gB;;AA+MjC;IAAc2I,iB,WAAAA,iB;AAEZ,6BAAY9nB,MAAZ,EAAoB;AAAA;;AAClB,SAAKA,MAAL,GAAcA,MAAd;AACD;;;;;gGAE4Bwc,M,EAAQ8D,a,EAAeG,O,EAASra,I,EAAM6I,W;;;;;;sBAE9DA,YAAYxR,OAAZ,KAAwB,K;;;;;;uBACC,KAAKuC,MAAL,CAAY+nB,WAAZ,CAAwBvL,MAAxB,EAAgC8D,aAAhC,EAA+C,IAA/C,C;;;AAA1BD,iC;;AACA2H,iCAAiB/Y,YAAYxR,OAAZ,GAAsB4iB,iBAAvC;;;;;;uBAEe,KAAKrgB,MAAL,CAAYiiB,iBAAZ,CAA8B,GAA9B,C;;;AAAX1B,kB;;uBACsB,KAAKvgB,MAAL,CAAY+nB,WAAZ,CAAwBvL,MAAxB,EAAgC8D,aAAhC,EAA+CC,EAA/C,C;;;AAA1BF,iC;AACID,gC,GAAmB,CAACnR,YAAYxR,OAAb,EAAsB2I,IAAtB,EAA4Bma,EAA5B,EAAgCF,iBAAhC,EAAmD3d,IAAnD,CAAwD,GAAxD,C;;uBACF,KAAK1C,MAAL,CAAY2gB,OAAZ,CAAoBP,gBAApB,EAAsCK,OAAtC,C;;;AAAjBD,wB;;uBACyB,KAAKxgB,MAAL,CAAYmb,MAAZ,CAAmB5d,KAAKsD,SAAL,CAAeoO,WAAf,CAAnB,C;;;AAAzBgZ,gC;;AACJD,iCAAiB,CAAC/Y,YAAYxR,OAAb,EAAsB+iB,QAAtB,EAAgCpa,IAAhC,EAAsCma,EAAtC,EAA0CF,iBAA1C,EAA6D4H,gBAA7D,EAA+EvlB,IAA/E,CAAoF,GAApF,CAAjB;;;oDAGKslB,c;;;;;;;;;;;;;;;;;;;gGAGShkB,I,EAAMnH,I,EAAMoS,W;;;;;;AACxB9T,sB,GAAS,E;AACb;;;uBACqB,KAAK6E,MAAL,CAAYkoB,yBAAZ,E;;;AAAjBC,wB;;sBACDlZ,YAAYxR,OAAZ,KAAwB,K;;;;;;uBAEG,KAAKuC,MAAL,CAAY+nB,WAAZ,CAAwBI,QAAxB,EAAkCtrB,KAAKG,EAAvC,EAA2C,IAA3C,C;;;AAA5B7B,uBAAO+b,Y;;;;;;uBAEqB,KAAKkR,sBAAL,CAA4BD,QAA5B,EAAsCtrB,KAAKG,EAA3C,EAA+CH,KAAKI,EAApD,EAAwD+G,KAAKoC,IAA7D,EAAmE6I,WAAnE,C;;;AAA5B9T,uBAAO+b,Y;;;;uBAIM,KAAKlX,MAAL,CAAYqoB,cAAZ,CAA2BF,QAA3B,C;;;AAAXG,kB;;uBACW,KAAKtoB,MAAL,CAAYuoB,eAAZ,CAA4BJ,QAA5B,C;;;AAAXlrB,kB;;uBACmB,KAAKmrB,sBAAL,CAA4B7qB,KAAKsD,SAAL,CAAemD,KAAKkX,+BAAL,EAAf,CAA5B,EAAoFoN,EAApF,EAAwFrrB,EAAxF,EAA4F+G,KAAKoC,IAAjG,EAAuG6I,WAAvG,C;;;AAAnBuZ,0B;;sBACDvZ,YAAYxR,OAAZ,KAAwB,K;;;;;;uBACJ,KAAKuC,MAAL,CAAY2gB,OAAZ,CAAoB6H,UAApB,EAAgCvrB,EAAhC,C;;;AAAjBujB,wB;;AACJrlB,uBAAOgc,SAAP,GAAmBqJ,QAAnB;;;;AAGFrlB,uBAAOqL,OAAP,GAAiBgiB,UAAjB;oDACOrtB,M;;;;;;;;;;;;;;;;;;mDAGsBqhB,M,EAAQ8D,a,EAAeG,O,EAAS;AAC7D,UAAIgI,oBAAoBjM,OAAO6F,SAAP,CAAiB,CAAjB,EAAoB,CAApB,CAAxB;AACA,UAAGoG,sBAAsB,KAAzB,EAAgC;AAC9B,eAAO;AACLpI,6BAAmB7D,OAAO6F,SAAP,CAAiB,CAAjB,EAAoB7F,OAAOta,MAA3B,CADd;AAELumB,6BAAmBA,iBAFd;AAGLrI,4BAAkB5D,MAHb;AAIL+D,cAAI,IAJC;AAKLC,oBAAU,IALL;AAMLF,yBAAeA,aANV;AAOLG,mBAASA;AAPJ,SAAP;AASD,OAVD,MAUO;AACL,YAAIiI,aAAalM,OAAOpT,KAAP,CAAa,GAAb,CAAjB;AACA,eAAO;AACLqf,6BAAmBC,WAAW,CAAX,CADd;AAELlI,oBAAUkI,WAAW,CAAX,CAFL;AAGLtiB,gBAAMsiB,WAAW,CAAX,CAHD;AAILnI,cAAImI,WAAW,CAAX,CAJC;AAKLrI,6BAAmBqI,WAAW,CAAX,CALd;AAML9qB,sBAAY8qB,WAAW,CAAX,CANP;AAOLtI,4BAAkB,CAACsI,WAAW,CAAX,CAAD,EAAgBA,WAAW,CAAX,CAAhB,EAA+BA,WAAW,CAAX,CAA/B,EAA8CA,WAAW,CAAX,CAA9C,EAA6DhmB,IAA7D,CAAkE,GAAlE,CAPb;AAQL4d,yBAAeA,aARV;AASLG,mBAASA;AATJ,SAAP;AAWD;AACF;;;;gGAEiBzc,I,EAAMnH,I;;;;;;sBAEnB,OAAOmH,KAAKwC,OAAZ,IAAuB,Q;;;;;;;;qBAKvBxC,KAAKwC,OAAL,CAAawV,UAAb,CAAwB,KAAxB,C;;;;;;iCAGgBze,I;;uBAAiB,KAAKyC,MAAL,CAAYinB,YAAZ,CAAyBjjB,KAAKwC,OAAL,CAAa6b,SAAb,CAAuB,CAAvB,EAA0Bre,KAAKwC,OAAL,CAAatE,MAAvC,CAAzB,C;;;;AAAhC8B,qBAAKwC,O,kBAAehJ,K;;;;;;;;;;;;oBAMpBwG,KAAKkT,Y;;;;;AACP;AACA9Y,wBAAQwG,GAAR,CAAY,mDAAZ;;;;;AAIF;AACI+jB,gC,GAAmB3kB,KAAKkT,Y;AACxBwJ,4B,GAAe,I;;AACnB,oBAAG,CAACiI,iBAAiB3M,UAAjB,CAA4B,KAA5B,CAAD,IAAuC,CAAC2M,iBAAiB3M,UAAjB,CAA4B,KAA5B,CAA3C,EAA+E;AAC7E;AACA2M,qCAAmB,QAAQA,gBAA3B;AACAjI,iCAAe,KAAf;AACD;AACGkI,yB,GAAY,KAAKC,8BAAL,CAAoCF,gBAApC,EAAsD9rB,KAAKG,EAA3D,EAA+DH,KAAKI,EAApE,C;;AAEhB;;sBACG2rB,UAAUxiB,IAAV,IAAkBwiB,UAAUxiB,IAAV,KAAmBpC,KAAKoC,I;;;;;AAC3ChI,wBAAQC,KAAR,CAAc,+CAAd;AACA,oBAAG,CAAC2F,KAAK2D,eAAT,EAA0B;AAAE3D,uBAAKyS,2BAAL,GAAmC,IAAnC;AAAyC;AACrEzS,qBAAK2D,eAAL,GAAuB,IAAvB;;;;;uBAImB,KAAK3H,MAAL,CAAY8oB,WAAZ,CAAwBF,SAAxB,EAAmClI,YAAnC,C;;;AAAjByH,wB;;oBAEAA,Q;;;;;AACF/pB,wBAAQwG,GAAR,CAAY,uBAAZ,EAAqCZ,IAArC;AACA,oBAAG,CAACA,KAAK2D,eAAT,EAA0B;AAAE3D,uBAAKyS,2BAAL,GAAmC,IAAnC;AAAyC;AACrEzS,qBAAK2D,eAAL,GAAuB,IAAvB;;;;;uBAKa,KAAK3H,MAAL,CAAYqoB,cAAZ,CAA2BF,QAA3B,C;;;AAAXG,kB;;uBACW,KAAKtoB,MAAL,CAAYuoB,eAAZ,CAA4BJ,QAA5B,C;;;AAAXlrB,kB;AACAmQ,0B,GAAa,KAAKyb,8BAAL,CAAoC7kB,KAAKwC,OAAzC,EAAkD8hB,EAAlD,EAAsDrrB,EAAtD,C;;iCAGIM,I;;uBAAiB,KAAKyC,MAAL,CAAYinB,YAAZ,CAAyB7Z,WAAWxP,UAApC,C;;;;AAApCoG,qBAAKiL,W,kBAAmBzR,K;;;;;;;;;sBAIvB4P,WAAWhH,IAAX,IAAmBgH,WAAWhH,IAAX,KAAoBpC,KAAKoC,I;;;;;AAC7C,oBAAG,CAACpC,KAAK2D,eAAT,EAA0B;AAAE3D,uBAAKyS,2BAAL,GAAmC,IAAnC;AAAyC;AACrEzS,qBAAK2D,eAAL,GAAuB,IAAvB;;;;;AAIF,oBAAG,CAACyF,WAAWoT,QAAf,EAAyB;AACvB;AACApT,6BAAWoT,QAAX,GAAsBxc,KAAKmT,SAA3B;AACD;;;uBAEmB,KAAKnX,MAAL,CAAY8oB,WAAZ,CAAwB1b,UAAxB,EAAoC,IAApC,C;;;AAAhB5G,uB;;AACJ,oBAAG,CAACA,OAAJ,EAAa;AACX,sBAAG,CAACxC,KAAK2D,eAAT,EAA0B;AAAE3D,yBAAKyS,2BAAL,GAAmC,IAAnC;AAAyC;AACrEzS,uBAAK2D,eAAL,GAAuB,IAAvB;AACD,iBAHD,MAGO;AACL,sBAAG3D,KAAK2D,eAAL,IAAwB,IAA3B,EAAiC;AAAE3D,yBAAKyS,2BAAL,GAAmC,IAAnC;AAAyC;AAC3E;AACDzS,uBAAK2D,eAAL,GAAuB,KAAvB;AACA3D,uBAAKwC,OAAL,GAAeA,OAAf;AACD;;;;;;;;;;;;;;;;;;;gGAGwB1C,K,EAAOjH,I,EAAMksB,M;;;;;;;;AAClC3H,uB;wFAAU,oBAAOpd,IAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gCACRA,IADQ;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA,kCAMTA,KAAKuC,OAAL,IAAgB,IAAhB,IAAwBvC,KAAKwC,OAAL,IAAgB,IAN/B;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAURwiB,oCAVQ,GAUG,OAAOhlB,KAAKwC,OAAZ,KAAwB,QAAxB,IAAoCxC,KAAKwC,OAAL,YAAwBic,MAV/D;;AAAA,iCAWTuG,QAXS;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA,mCAaF,QAAKzZ,WAAL,CAAiBvL,IAAjB,EAAuBnH,IAAvB,CAbE;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAeR,gCAAG,CAACmH,KAAK2D,eAAT,EAA0B;AAAE3D,mCAAKyS,2BAAL,GAAmC,IAAnC;AAAyC;AACrEzS,iCAAK2D,eAAL,GAAuB,IAAvB;;AAhBQ,iCAiBLohB,MAjBK;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAoBR3qB,oCAAQC,KAAR,CAAc,uBAAd,EAAuC2F,IAAvC;AApBQ;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mB;;kCAAVod,O;;;;;oDA0BGhmB,QAAQ+R,GAAR,CAAYrJ,MAAMvB,GAAN,CAAU,UAACyB,IAAD,EAAU;AACrC,yBAAOod,QAAQpd,IAAR,CAAP;AACD,iBAFkB,CAAZ,C;;;;;;;;;;;;;;;;;;;;;AAMX,CAAC,IAAIhD,cAAc,OAAOzF,MAAP,KAAkB,WAAlB,GAAgCA,MAAhC,GAA0C,OAAO0F,MAAP,KAAkB,WAAlB,GAAgCA,MAAhC,GAAyC,IAArG;;IAEYgoB,Y,WAAAA,Y;AACX,wBAAYC,cAAZ,EAA4B;AAAA;;AAC1B;AACA,QAAGloB,WAAH,EAAgB;AACd;AACA;AACA,UAAImoB,WAAY,OAAOC,QAAP,KAAoB,WAApB,IAAmCA,SAASC,YAA7C,IAA8D,OAAOjN,IAAP,CAAY5C,UAAU8P,SAAtB,CAA7E;;AAEA,UAAG,CAACH,QAAD,IAAcnoB,YAAYhB,MAAZ,IAAsBgB,YAAYhB,MAAZ,CAAmBqkB,MAA1D,EAAmE;AACjE,aAAKrkB,MAAL,GAAc,IAAIskB,WAAJ,EAAd;AACD,OAFD,MAEO;AACL,aAAKtkB,MAAL,GAAc,IAAI6jB,UAAJ,EAAd;AACD;AACF;;AAED;AACA,QAAGqF,cAAH,EAAmB;AACjB,WAAKlpB,MAAL,GAAckpB,cAAd;AACD;;AAED,SAAK5Z,eAAL,GAAuB,IAAIwY,iBAAJ,CAAsB,KAAK9nB,MAA3B,CAAvB;;AAEA,SAAKA,MAAL,CAAYb,IAAZ,GAAmB;AACjB1B,eAAU,KAAKA,OAAL,EADO;AAEjBmmB,qCAAgC,KAAKA,6BAAL;AAFf,KAAnB;AAID;;;;8BAES;AACR,aAAO,KAAP;AACD;;;mDAE8B5B,I,EAAM;AACnC;AACA;AACA;AACA;AACA,UAAGA,OAAO,IAAV,EAAgB;AACd,eAAO,KAAKhiB,MAAL,YAAuBskB,WAA9B;AACD,OAFD,MAEO;AACL,eAAO,IAAP;AACD;AACF;;AAED;;;;wCACoB;AAClB,aAAO,CAAC,KAAD,EAAQ,KAAR,EAAe,KAAf,CAAP;AACD;;;qDAEgC7mB,O,EAAS;AACxC,UAAI8rB,iBAAiB,KAAK9rB,OAAL,EAArB;AACA,aAAOmf,SAASnf,OAAT,IAAoBmf,SAAS2M,cAAT,CAA3B;AACD;;;8CAEyB9rB,O,EAAS;AACjC;AACA,UAAI+rB,kBAAkB;AACpB,eAAQ9Y,KAAKlT,KAAL,CAAW,YAAX,CADY;AAEpB,eAAQkT,KAAKlT,KAAL,CAAW,YAAX;AAFY,OAAtB;;AAKA,UAAI4b,OAAOoQ,gBAAgB/rB,OAAhB,CAAX;AACA,UAAG,CAAC2b,IAAJ,EAAU;AACR;AACA,eAAO,KAAP;AACD;AACD,UAAIqQ,UAAU,IAAI/Y,IAAJ,KAAa0I,IAA3B;AACA,aAAOqQ,OAAP;AACD;;;0CAEqBhsB,O,EAAS;AAC7B,aAAO;AACL,eAAQ,IADH;AAEL,eAAQ,IAFH;AAGL,eAAQ;AAHH,QAILA,OAJK,CAAP;AAKD;;;oDAE+B;AAC9B,aAAO,KAAKqC,qBAAL,CAA2B,KAAKrC,OAAL,EAA3B,CAAP;AACD;;;;;;AAGH,IAAGuD,WAAH,EAAgB;AACd;AACA,MAAI;AACFA,gBAAYioB,YAAZ,GAA2BA,YAA3B;AACAjoB,gBAAY7B,IAAZ,GAAmB,IAAI8pB,YAAJ,EAAnB;AACAjoB,gBAAYsjB,WAAZ,GAA0BA,WAA1B;AACAtjB,gBAAY6iB,UAAZ,GAAyBA,UAAzB;AACA7iB,gBAAY8mB,iBAAZ,GAAgCA,iBAAhC;AACA9mB,gBAAY6D,cAAZ,GAA6BA,cAA7B;AACA7D,gBAAY4J,MAAZ,GAAqBA,MAArB;AACA5J,gBAAYqM,YAAZ,GAA2BA,YAA3B;AACArM,gBAAYE,aAAZ,GAA4BA,aAA5B;AACAF,gBAAY0O,gBAAZ,GAA+BA,gBAA/B;AACA1O,gBAAY+O,aAAZ,GAA4BA,aAA5B;AACA/O,gBAAYrF,aAAZ,GAA4BA,aAA5B;AACAqF,gBAAY2B,kBAAZ,GAAiCA,kBAAjC;AACA3B,gBAAY9F,cAAZ,GAA6BA,cAA7B;AACA8F,gBAAYiY,WAAZ,GAA0BA,WAA1B;AACAjY,gBAAYwO,gBAAZ,GAA+BA,gBAA/B;AACAxO,gBAAY0M,uBAAZ,GAAsCA,uBAAtC;AACA1M,gBAAYqc,aAAZ,GAA4BA,aAA5B;AACArc,gBAAY+c,kBAAZ,GAAiCA,kBAAjC;AACD,GApBD,CAoBE,OAAOhc,CAAP,EAAU;AACV3D,YAAQwG,GAAR,CAAY,4CAAZ,EAA0D7C,CAA1D;AACD;AACF","file":"transpiled.js","sourcesContent":["export class SFAlertManager {\n\n  async alert(params) {\n    return new Promise((resolve, reject) => {\n      window.alert(params.text);\n      resolve();\n    })\n  }\n\n  async confirm(params) {\n    return new Promise((resolve, reject) => {\n      if(window.confirm(params.text)) {\n        resolve();\n      } else {\n        reject();\n      }\n    });\n  }\n\n}\n;export class SFAuthManager {\n\n  constructor(storageManager, httpManager, alertManager, timeout) {\n    SFAuthManager.DidSignOutEvent = \"DidSignOutEvent\";\n    SFAuthManager.WillSignInEvent = \"WillSignInEvent\";\n    SFAuthManager.DidSignInEvent = \"DidSignInEvent\";\n\n    this.httpManager = httpManager;\n    this.storageManager = storageManager;\n    this.alertManager = alertManager || new SFAlertManager();\n    this.$timeout = timeout || setTimeout.bind(window);\n\n    this.eventHandlers = [];\n  }\n\n  addEventHandler(handler) {\n    this.eventHandlers.push(handler);\n    return handler;\n  }\n\n  removeEventHandler(handler) {\n    _.pull(this.eventHandlers, handler);\n  }\n\n  notifyEvent(event, data) {\n    for(var handler of this.eventHandlers) {\n      handler(event, data || {});\n    }\n  }\n\n  async saveKeys(keys) {\n    this._keys = keys;\n    await this.storageManager.setItem(\"mk\", keys.mk);\n    await this.storageManager.setItem(\"ak\", keys.ak);\n  }\n\n  async signout(clearAllData) {\n    this._keys = null;\n    this._authParams = null;\n    if(clearAllData) {\n      return this.storageManager.clearAllData().then(() => {\n        this.notifyEvent(SFAuthManager.DidSignOutEvent);\n      })\n    } else {\n      this.notifyEvent(SFAuthManager.DidSignOutEvent);\n    }\n  }\n\n  async keys() {\n    if(!this._keys) {\n      var mk = await this.storageManager.getItem(\"mk\");\n      if(!mk) {\n        return null;\n      }\n      this._keys = {mk: mk, ak: await this.storageManager.getItem(\"ak\")};\n    }\n    return this._keys;\n  }\n\n  async getAuthParams() {\n    if(!this._authParams) {\n      var data = await this.storageManager.getItem(\"auth_params\");\n      this._authParams = JSON.parse(data);\n    }\n\n    if(this._authParams && !this._authParams.version) {\n      this._authParams.version = await this.defaultProtocolVersion();\n    }\n\n    return this._authParams;\n  }\n\n  async defaultProtocolVersion() {\n    var keys = await this.keys();\n    if(keys && keys.ak) {\n      // If there's no version stored, and there's an ak, it has to be 002. Newer versions would have thier version stored in authParams.\n      return \"002\";\n    } else {\n      return \"001\";\n    }\n  }\n\n  async protocolVersion() {\n    var authParams = await this.getAuthParams();\n    if(authParams && authParams.version) {\n      return authParams.version;\n    }\n\n    return this.defaultProtocolVersion();\n  }\n\n  async getAuthParamsForEmail(url, email, extraParams) {\n    return new Promise((resolve, reject) => {\n      var requestUrl = url + \"/auth/params\";\n      this.httpManager.getAbsolute(requestUrl, _.merge({email: email}, extraParams), (response) => {\n        resolve(response);\n      }, (response) => {\n        console.error(\"Error getting auth params\", response);\n        if(typeof response !== 'object') {\n          response = {error: {message: \"A server error occurred while trying to sign in. Please try again.\"}};\n        }\n        resolve(response);\n      })\n    })\n  }\n\n  lock() {\n    this.locked = true;\n  }\n\n  unlock() {\n    this.locked = false;\n  }\n\n  isLocked() {\n    return this.locked == true;\n  }\n\n  unlockAndResolve(resolve, param) {\n    this.unlock();\n    resolve(param);\n  }\n\n  async login(url, email, password, strictSignin, extraParams) {\n    return new Promise(async (resolve, reject) => {\n\n      let existingKeys = await this.keys();\n      if(existingKeys != null) {\n        resolve({error : {message: \"Cannot log in because already signed in.\"}});\n        return;\n      }\n\n      if(this.isLocked()) {\n        resolve({error : {message: \"Login already in progress.\"}});\n        return;\n      }\n\n      this.lock();\n\n      this.notifyEvent(SFAuthManager.WillSignInEvent);\n\n      let authParams = await this.getAuthParamsForEmail(url, email, extraParams);\n\n      // SF3 requires a unique identifier in the auth params\n      authParams.identifier = email;\n\n      if(authParams.error) {\n        this.unlockAndResolve(resolve, authParams);\n        return;\n      }\n\n      if(!authParams || !authParams.pw_cost) {\n        this.unlockAndResolve(resolve, {error : {message: \"Invalid email or password.\"}});\n        return;\n      }\n\n      if(!SFJS.supportedVersions().includes(authParams.version)) {\n        var message;\n        if(SFJS.isVersionNewerThanLibraryVersion(authParams.version)) {\n          // The user has a new account type, but is signing in to an older client.\n          message = \"This version of the application does not support your newer account type. Please upgrade to the latest version of Standard Notes to sign in.\";\n        } else {\n          // The user has a very old account type, which is no longer supported by this client\n          message = \"The protocol version associated with your account is outdated and no longer supported by this application. Please visit standardnotes.org/help/security for more information.\";\n        }\n        this.unlockAndResolve(resolve, {error: {message: message}});\n        return;\n      }\n\n      if(SFJS.isProtocolVersionOutdated(authParams.version)) {\n        let message = `The encryption version for your account, ${authParams.version}, is outdated and requires upgrade. You may proceed with login, but are advised to perform a security update using the web or desktop application. Please visit standardnotes.org/help/security for more information.`\n        var abort = false;\n        await this.alertManager.confirm({\n          title: \"Update Needed\",\n          text: message,\n          confirmButtonText: \"Sign In\",\n        }).catch(() => {\n          this.unlockAndResolve(resolve, {error: {}});\n          abort = true;\n        })\n        if(abort) {\n          return;\n        }\n      }\n\n      if(!SFJS.supportsPasswordDerivationCost(authParams.pw_cost)) {\n        let message = \"Your account was created on a platform with higher security capabilities than this browser supports. \" +\n        \"If we attempted to generate your login keys here, it would take hours. \" +\n        \"Please use a browser with more up to date security capabilities, like Google Chrome or Firefox, to log in.\"\n        this.unlockAndResolve(resolve, {error: {message: message}});\n        return;\n      }\n\n      var minimum = SFJS.costMinimumForVersion(authParams.version);\n      if(authParams.pw_cost < minimum) {\n        let message = \"Unable to login due to insecure password parameters. Please visit standardnotes.org/help/security for more information.\";\n        this.unlockAndResolve(resolve, {error: {message: message}});\n        return;\n      }\n\n      if(strictSignin) {\n        // Refuse sign in if authParams.version is anything but the latest version\n        var latestVersion = SFJS.version();\n        if(authParams.version !== latestVersion) {\n          let message = `Strict sign in refused server sign in parameters. The latest security version is ${latestVersion}, but your account is reported to have version ${authParams.version}. If you'd like to proceed with sign in anyway, please disable strict sign in and try again.`;\n          this.unlockAndResolve(resolve, {error: {message: message}});\n          return;\n        }\n      }\n\n      let keys = await SFJS.crypto.computeEncryptionKeysForUser(password, authParams);\n\n      var requestUrl = url + \"/auth/sign_in\";\n      var params = _.merge({password: keys.pw, email: email}, extraParams);\n\n      this.httpManager.postAbsolute(requestUrl, params, async (response) => {\n        this.notifyEvent(SFAuthManager.DidSignInEvent);\n        await this.handleAuthResponse(response, email, url, authParams, keys);\n        this.$timeout(() => this.unlockAndResolve(resolve, response));\n      }, (response) => {\n        console.error(\"Error logging in\", response);\n        if(typeof response !== 'object') {\n          response = {error: {message: \"A server error occurred while trying to sign in. Please try again.\"}};\n        }\n        this.$timeout(() => this.unlockAndResolve(resolve, response));\n      });\n    });\n  }\n\n  register(url, email, password) {\n    return new Promise(async (resolve, reject) => {\n\n      if(this.isLocked()) {\n        resolve({error : {message: \"Register already in progress.\"}});\n        return;\n      }\n\n      this.lock();\n\n      let results = await SFJS.crypto.generateInitialKeysAndAuthParamsForUser(email, password);\n      let keys = results.keys;\n      let authParams = results.authParams;\n\n      var requestUrl = url + \"/auth\";\n      var params = _.merge({password: keys.pw, email: email}, authParams);\n\n      this.httpManager.postAbsolute(requestUrl, params, async (response) => {\n        await this.handleAuthResponse(response, email, url, authParams, keys);\n        this.unlockAndResolve(resolve, response);\n      }, (response) => {\n        console.error(\"Registration error\", response);\n        if(typeof response !== 'object') {\n          response = {error: {message: \"A server error occurred while trying to register. Please try again.\"}};\n        }\n        this.unlockAndResolve(resolve, response);\n      })\n    });\n  }\n\n  async changePassword(url, email, current_server_pw, newKeys, newAuthParams) {\n    return new Promise(async (resolve, reject) => {\n\n      if(this.isLocked()) {\n        resolve({error : {message: \"Change password already in progress.\"}});\n        return;\n      }\n\n      this.lock();\n\n      let newServerPw = newKeys.pw;\n\n      var requestUrl = url + \"/auth/change_pw\";\n      var params = _.merge({new_password: newServerPw, current_password: current_server_pw}, newAuthParams);\n\n      this.httpManager.postAbsolute(requestUrl, params, async (response) => {\n        await this.handleAuthResponse(response, email, null, newAuthParams, newKeys);\n        this.unlockAndResolve(resolve, response);\n      }, (response) => {\n        if(typeof response !== 'object') {\n          response = {error: {message: \"Something went wrong while changing your password. Your password was not changed. Please try again.\"}}\n        }\n        this.unlockAndResolve(resolve, response);\n      })\n    });\n  }\n\n  async handleAuthResponse(response, email, url, authParams, keys) {\n    if(url) { await this.storageManager.setItem(\"server\", url);}\n    this._authParams = authParams;\n    await this.storageManager.setItem(\"auth_params\", JSON.stringify(authParams));\n    await this.storageManager.setItem(\"jwt\", response.token);\n    return this.saveKeys(keys);\n  }\n}\n;var globalScope = typeof window !== 'undefined' ? window : (typeof global !== 'undefined' ? global : null);\n\nexport class SFHttpManager {\n\n  constructor(timeout) {\n    // calling callbacks in a $timeout allows UI to update\n    this.$timeout = timeout || setTimeout.bind(globalScope);\n  }\n\n  setJWTRequestHandler(handler) {\n    this.jwtRequestHandler = handler;\n  }\n\n  async setAuthHeadersForRequest(request) {\n    var token = await this.jwtRequestHandler();\n    if(token) {\n      request.setRequestHeader('Authorization', 'Bearer ' + token);\n    }\n  }\n\n  postAbsolute(url, params, onsuccess, onerror) {\n    this.httpRequest(\"post\", url, params, onsuccess, onerror);\n  }\n\n  patchAbsolute(url, params, onsuccess, onerror) {\n    this.httpRequest(\"patch\", url, params, onsuccess, onerror);\n  }\n\n  getAbsolute(url, params, onsuccess, onerror) {\n    this.httpRequest(\"get\", url, params, onsuccess, onerror);\n  }\n\n  async httpRequest(verb, url, params, onsuccess, onerror) {\n\n    var xmlhttp = new XMLHttpRequest();\n\n    xmlhttp.onreadystatechange = function() {\n      if (xmlhttp.readyState == 4) {\n        var response = xmlhttp.responseText;\n        if(response) {\n          try {\n            response = JSON.parse(response);\n          } catch(e) {}\n        }\n\n       if(xmlhttp.status >= 200 && xmlhttp.status <= 299){\n         this.$timeout(function(){\n           onsuccess(response);\n         })\n       } else {\n         console.error(\"Request error:\", response);\n         this.$timeout(function(){\n           onerror(response, xmlhttp.status)\n         })\n       }\n     }\n   }.bind(this)\n\n    if(verb == \"get\" && Object.keys(params).length > 0) {\n      url = url + this.formatParams(params);\n    }\n\n    xmlhttp.open(verb, url, true);\n    await this.setAuthHeadersForRequest(xmlhttp);\n    xmlhttp.setRequestHeader('Content-type', 'application/json');\n\n    if(verb == \"post\" || verb == \"patch\") {\n      xmlhttp.send(JSON.stringify(params));\n    } else {\n      xmlhttp.send();\n    }\n  }\n\n  formatParams(params) {\n    return \"?\" + Object\n          .keys(params)\n          .map(function(key){\n            return key+\"=\"+encodeURIComponent(params[key])\n          })\n          .join(\"&\")\n  }\n\n}\n;export class SFMigrationManager {\n\n  constructor(modelManager, syncManager, storageManager) {\n    this.modelManager = modelManager;\n    this.syncManager = syncManager;\n    this.storageManager = storageManager;\n\n    this.loadMigrations();\n\n    this.syncManager.addEventHandler(async (event, data) => {\n      var dataLoadedEvent = event == \"local-data-loaded\";\n      var syncCompleteEvent = event == \"sync:completed\";\n\n      if(dataLoadedEvent || syncCompleteEvent) {\n        if(dataLoadedEvent) {\n          this.receivedLocalDataEvent = true;\n        } else if(syncCompleteEvent) {\n          this.receivedSyncCompletedEvent = true;\n        }\n\n        // We want to run pending migrations only after local data has been loaded, and a sync has been completed.\n        if(this.receivedLocalDataEvent && this.receivedSyncCompletedEvent) {\n          if(data && data.initialSync) {\n            // If initial online sync, clear any completed migrations that occurred while offline, so they can run again now\n            // that we have updated user items.\n            await this.clearCompletedMigrations();\n          }\n          this.runPendingMigrations();\n        }\n      }\n    })\n  }\n\n  async clearCompletedMigrations() {\n    var completed = await this.getCompletedMigrations();\n    completed.length = 0;\n  }\n\n  loadMigrations() {\n    this.migrations = this.registeredMigrations();\n  }\n\n  registeredMigrations() {\n    // Subclasses should return an array of migrations here.\n    // Migrations should have a unique `name`, `content_type`,\n    // and `handler`, which is a function that accepts an array of matching items to migration.\n  }\n\n  async runPendingMigrations() {\n    var pending = await this.getPendingMigrations();\n\n    // run in pre loop, keeping in mind that a migration may be run twice: when offline then again when signing in.\n    // we need to reset the items to a new array.\n    for(var migration of pending) {\n      migration.items = [];\n    }\n    for(var item of this.modelManager.allItems) {\n      for(var migration of pending) {\n        if(item.content_type == migration.content_type) {\n          migration.items.push(item);\n        }\n      }\n    }\n\n    for(var migration of pending) {\n      if(migration.items && migration.items.length > 0) {\n        this.runMigration(migration, migration.items);\n      } else {\n        this.markMigrationCompleted(migration);\n      }\n    }\n  }\n\n  encode(text) {\n    return window.btoa(text);\n  }\n\n  decode(text) {\n    return window.atob(text);\n  }\n\n  async getCompletedMigrations() {\n    if(!this._completed) {\n      var rawCompleted = await this.storageManager.getItem(\"migrations\");\n      if(rawCompleted) {\n        this._completed = JSON.parse(rawCompleted);\n      } else {\n        this._completed = [];\n      }\n    }\n    return this._completed;\n  }\n\n  async getPendingMigrations() {\n    var completed = await this.getCompletedMigrations();\n    return this.migrations.filter((migration) => {\n      // if the name is not found in completed, then it is pending.\n      return completed.indexOf(this.encode(migration.name)) == -1;\n    })\n  }\n\n  async markMigrationCompleted(migration) {\n    var completed = await this.getCompletedMigrations();\n    completed.push(this.encode(migration.name));\n    this.storageManager.setItem(\"migrations\", JSON.stringify(completed));\n  }\n\n  async runMigration(migration, items) {\n    console.log(\"Running migration:\", migration.name);\n    migration.handler(items);\n    this.markMigrationCompleted(migration);\n  }\n}\n;export class SFModelManager {\n\n  constructor(timeout) {\n    SFModelManager.MappingSourceRemoteRetrieved = \"MappingSourceRemoteRetrieved\";\n    SFModelManager.MappingSourceRemoteSaved = \"MappingSourceRemoteSaved\";\n    SFModelManager.MappingSourceLocalSaved = \"MappingSourceLocalSaved\";\n    SFModelManager.MappingSourceLocalRetrieved = \"MappingSourceLocalRetrieved\";\n    SFModelManager.MappingSourceComponentRetrieved = \"MappingSourceComponentRetrieved\";\n    SFModelManager.MappingSourceDesktopInstalled = \"MappingSourceDesktopInstalled\"; // When a component is installed by the desktop and some of its values change\n    SFModelManager.MappingSourceRemoteActionRetrieved = \"MappingSourceRemoteActionRetrieved\"; /* aciton-based Extensions like note history */\n    SFModelManager.MappingSourceFileImport = \"MappingSourceFileImport\";\n\n    SFModelManager.isMappingSourceRetrieved = (source) => {\n      return [\n        SFModelManager.MappingSourceRemoteRetrieved,\n        SFModelManager.MappingSourceComponentRetrieved,\n        SFModelManager.MappingSourceRemoteActionRetrieved\n      ].includes(source);\n    }\n\n    this.$timeout = timeout || setTimeout.bind(window);\n\n    this.itemSyncObservers = [];\n    this.itemsPendingRemoval = [];\n    this.items = [];\n    this.itemsHash = {};\n    this.missedReferences = {};\n    this.uuidChangeObservers = [];\n  }\n\n  handleSignout() {\n    this.items.length = 0;\n    this.itemsHash = {};\n    this.itemsPendingRemoval.length = 0;\n    this.missedReferences = {};\n  }\n\n  addModelUuidChangeObserver(id, callback) {\n    this.uuidChangeObservers.push({id: id, callback: callback});\n  }\n\n  notifyObserversOfUuidChange(oldItem, newItem) {\n    for(var observer of this.uuidChangeObservers) {\n      observer.callback(oldItem, newItem);\n    }\n  }\n\n  async alternateUUIDForItem(item) {\n    // We need to clone this item and give it a new uuid, then delete item with old uuid from db (you can't modify uuid's in our indexeddb setup)\n    var newItem = this.createItem(item);\n    newItem.uuid = await SFJS.crypto.generateUUID();\n\n    // Update uuids of relationships\n    newItem.informReferencesOfUUIDChange(item.uuid, newItem.uuid);\n    this.informModelsOfUUIDChangeForItem(newItem, item.uuid, newItem.uuid);\n\n    console.log(item.uuid, \"-->\", newItem.uuid);\n\n    // Set to deleted, then run through mapping function so that observers can be notified\n    item.deleted = true;\n    item.content.references = [];\n    // Don't set dirty, because we don't need to sync old item. alternating uuid only occurs in two cases:\n    // signing in and merging offline data, or when a uuid-conflict occurs. In both cases, the original item never\n    // saves to a server, so doesn't need to be synced.\n    // informModelsOfUUIDChangeForItem may set this object to dirty, but we want to undo that here, so that the item gets deleted\n    // right away through the mapping function.\n    item.setDirty(false);\n    this.mapResponseItemsToLocalModels([item], SFModelManager.MappingSourceLocalSaved);\n\n    // add new item\n    this.addItem(newItem);\n    newItem.setDirty(true);\n    this.resolveReferencesForItem(newItem);\n\n    this.notifyObserversOfUuidChange(item, newItem);\n\n    return newItem;\n  }\n\n  informModelsOfUUIDChangeForItem(newItem, oldUUID, newUUID) {\n    // some models that only have one-way relationships might be interested to hear that an item has changed its uuid\n    // for example, editors have a one way relationship with notes. When a note changes its UUID, it has no way to inform the editor\n    // to update its relationships\n\n    for(var model of this.items) {\n      model.potentialItemOfInterestHasChangedItsUUID(newItem, oldUUID, newUUID);\n    }\n  }\n\n  didSyncModelsOffline(items) {\n    this.notifySyncObserversOfModels(items, SFModelManager.MappingSourceLocalSaved);\n  }\n\n  mapResponseItemsToLocalModels(items, source, sourceKey) {\n    return this.mapResponseItemsToLocalModelsOmittingFields(items, null, source, sourceKey);\n  }\n\n  mapResponseItemsToLocalModelsOmittingFields(items, omitFields, source, sourceKey) {\n    var models = [], processedObjects = [], modelsToNotifyObserversOf = [];\n\n    // first loop should add and process items\n    for(var json_obj of items) {\n      if(!json_obj) {\n        continue;\n      }\n      if((!json_obj.content_type || !json_obj.content || !json_obj.uuid) && !json_obj.deleted && !json_obj.errorDecrypting) {\n        // An item that is not deleted should never have empty content\n        console.error(\"Server response item is corrupt:\", json_obj);\n        continue;\n      }\n\n      // Lodash's _.omit, which was previously used, seems to cause unexpected behavior\n      // when json_obj is an ES6 item class. So we instead manually omit each key.\n      if(Array.isArray(omitFields)) {\n        for(var key of omitFields) {\n          delete json_obj[key];\n        }\n      }\n\n      var item = this.findItem(json_obj.uuid);\n\n      if(item) {\n        item.updateFromJSON(json_obj);\n        // If an item goes through mapping, it can no longer be a dummy.\n        item.dummy = false;\n      }\n\n      if(this.itemsPendingRemoval.includes(json_obj.uuid)) {\n        _.pull(this.itemsPendingRemoval, json_obj.uuid);\n        continue;\n      }\n\n      let contentType = json_obj[\"content_type\"] || (item && item.content_type);\n      var unknownContentType = this.acceptableContentTypes && !this.acceptableContentTypes.includes(contentType);\n      if(unknownContentType) {\n        continue;\n      }\n\n      var isDirtyItemPendingDelete = false;\n      if(json_obj.deleted == true) {\n        if(json_obj.dirty) {\n          // Item was marked as deleted but not yet synced\n          // We need to create this item as usual, but just not add it to individual arrays\n          // i.e add to this.items but not this.notes (so that it can be retrieved with getDirtyItems)\n          isDirtyItemPendingDelete = true;\n        } else {\n          if(item) {\n            modelsToNotifyObserversOf.push(item);\n            this.removeItemLocally(item);\n          }\n          continue;\n        }\n      }\n\n      if(!item) {\n        item = this.createItem(json_obj, true);\n      }\n\n      this.addItem(item, isDirtyItemPendingDelete);\n\n      // Observers do not need to handle items that errored while decrypting.\n      if(!item.errorDecrypting) {\n        modelsToNotifyObserversOf.push(item);\n      }\n\n      models.push(item);\n      processedObjects.push(json_obj);\n    }\n\n    // // second loop should process references\n    for(let [index, json_obj] of processedObjects.entries()) {\n      var model = models[index];\n      if(json_obj.content) {\n        this.resolveReferencesForItem(model);\n      }\n\n      var missedRefs = this.popMissedReferenceStructsForObject(json_obj);\n      for(var ref of missedRefs) {\n        this.resolveReferencesForItem(ref.for_item);\n      }\n\n      model.didFinishSyncing();\n    }\n\n    this.notifySyncObserversOfModels(modelsToNotifyObserversOf, source, sourceKey);\n\n    return models;\n  }\n\n  missedReferenceBuildKey(referenceId, objectId) {\n    return `${referenceId}:${objectId}`\n  }\n\n  popMissedReferenceStructsForObject(object) {\n    var results = [];\n    var toDelete = [];\n    for(var candidateKey of Object.keys(this.missedReferences)) {\n      var matches = candidateKey.split(\":\")[0] == object.uuid;\n      if(matches) {\n        results.push(this.missedReferences[candidateKey]);\n        toDelete.push(candidateKey);\n      }\n    }\n\n    // remove from hash\n    for(var key of toDelete) {\n      delete this.missedReferences[key];\n    }\n\n    return results;\n  }\n\n  resolveReferencesForItem(item, markReferencesDirty = false) {\n\n    // console.log(\"resolveReferencesForItem\", item, \"references\", item.contentObject.references);\n\n    var contentObject = item.contentObject;\n\n    // If another client removes an item's references, this client won't pick up the removal unless\n    // we remove everything not present in the current list of references\n    item.updateLocalRelationships();\n\n    if(!contentObject.references) {\n      return;\n    }\n\n    var references = contentObject.references.slice(); // make copy, references will be modified in array\n\n    var referencesIds = references.map((ref) => {return ref.uuid});\n    let includeBlanks = true;\n    var referencesObjectResults = this.findItems(referencesIds, includeBlanks);\n\n    for(let [index, referencedItem] of referencesObjectResults.entries()) {\n      if(referencedItem) {\n        item.addItemAsRelationship(referencedItem);\n        if(markReferencesDirty) {\n          referencedItem.setDirty(true);\n        }\n      } else {\n        var missingRefId = referencesIds[index];\n        // Allows mapper to check when missing reference makes it through the loop,\n        // and then runs resolveReferencesForItem again for the original item.\n        var mappingKey = this.missedReferenceBuildKey(missingRefId, item.uuid);\n        if(!this.missedReferences[mappingKey]) {\n          let missedRef = {reference_uuid: missingRefId, for_item: item};\n          this.missedReferences[mappingKey] = missedRef;\n        }\n      }\n    }\n  }\n\n  /* Note that this function is public, and can also be called manually (desktopManager uses it) */\n  notifySyncObserversOfModels(models, source, sourceKey) {\n    // Make sure `let` is used in the for loops instead of `var`, as we will be using a timeout below.\n    for(let observer of this.itemSyncObservers) {\n      var allRelevantItems = observer.types.includes(\"*\") ? models : models.filter((item) => {return observer.types.includes(item.content_type)});\n      var validItems = [], deletedItems = [];\n      for(let item of allRelevantItems) {\n        if(item.deleted) {\n          deletedItems.push(item);\n        } else {\n          validItems.push(item);\n        }\n      }\n\n      if(allRelevantItems.length > 0) {\n        this._callSyncObserverCallbackWithTimeout(observer, allRelevantItems, validItems, deletedItems, source, sourceKey);\n      }\n    }\n  }\n\n  /*\n    Rather than running this inline in a for loop, which causes problems and requires all variables to be declared with `let`,\n    we'll do it here so it's more explicit and less confusing.\n   */\n  _callSyncObserverCallbackWithTimeout(observer, allRelevantItems, validItems, deletedItems, source, sourceKey) {\n    this.$timeout(() => {\n      observer.callback(allRelevantItems, validItems, deletedItems, source, sourceKey);\n    })\n  }\n\n  createItem(json_obj, dontNotifyObservers) {\n    var itemClass = SFModelManager.ContentTypeClassMapping && SFModelManager.ContentTypeClassMapping[json_obj.content_type];\n    if(!itemClass) {\n      itemClass = SFItem;\n    }\n    var item = new itemClass(json_obj);\n\n    // Some observers would be interested to know when an an item is locally created\n    // If we don't send this out, these observers would have to wait until MappingSourceRemoteSaved\n    // to hear about it, but sometimes, RemoveSaved is explicitly ignored by the observer to avoid\n    // recursive callbacks. See componentManager's syncObserver callback.\n    // dontNotifyObservers is currently only set true by modelManagers mapResponseItemsToLocalModels\n    if(!dontNotifyObservers) {\n      this.notifySyncObserversOfModels([item], SFModelManager.MappingSourceLocalSaved);\n    }\n\n    return item;\n  }\n\n  /*\n    Be sure itemResponse is a generic Javascript object, and not an Item.\n    An Item needs to collapse its properties into its content object before it can be duplicated.\n    Note: the reason we need this function is specificallty for the call to resolveReferencesForItem.\n    This method creates but does not add the item to the global inventory. It's used by syncManager\n    to check if this prospective duplicate item is identical to another item, including the references.\n   */\n  createConflictedItem(itemResponse) {\n    var dup = this.createItem(itemResponse, true);\n    return dup;\n  }\n\n  addConflictedItem(dup, original) {\n    this.addItem(dup);\n    // the duplicate should inherit the original's relationships\n    for(var referencingObject of original.referencingObjects) {\n      referencingObject.addItemAsRelationship(dup);\n      referencingObject.setDirty(true);\n    }\n    this.resolveReferencesForItem(dup);\n    dup.conflict_of = original.uuid;\n    dup.setDirty(true);\n  }\n\n  duplicateItem(item) {\n    var copy = new item.constructor({content: item.content});\n\n    this.addItem(copy);\n\n    // the duplicate should inherit the original's relationships\n    for(var referencingObject of item.referencingObjects) {\n      referencingObject.addItemAsRelationship(copy);\n      referencingObject.setDirty(true);\n    }\n    this.resolveReferencesForItem(copy);\n    copy.setDirty(true);\n\n    return copy;\n  }\n\n  addItem(item, globalOnly = false) {\n    this.addItems([item], globalOnly);\n  }\n\n  addItems(items, globalOnly = false) {\n    items.forEach((item) => {\n      if(!this.itemsHash[item.uuid]) {\n        this.itemsHash[item.uuid] = item;\n        this.items.push(item);\n      }\n    });\n  }\n\n  /* Notifies observers when an item has been synced or mapped from a remote response */\n  addItemSyncObserver(id, types, callback) {\n    if(!Array.isArray(types)) {\n      types = [types];\n    }\n    this.itemSyncObservers.push({id: id, types: types, callback: callback});\n  }\n\n  removeItemSyncObserver(id) {\n    _.remove(this.itemSyncObservers, _.find(this.itemSyncObservers, {id: id}));\n  }\n\n  getDirtyItems() {\n    return this.items.filter((item) => {\n      // An item that has an error decrypting can be synced only if it is being deleted.\n      // Otherwise, we don't want to send corrupt content up to the server.\n      return item.dirty == true && !item.dummy && (!item.errorDecrypting || item.deleted);\n    })\n  }\n\n  clearDirtyItems(items) {\n    for(var item of items) {\n      item.setDirty(false);\n    }\n  }\n\n  setItemToBeDeleted(item) {\n    item.deleted = true;\n\n    if(!item.dummy) { item.setDirty(true); }\n\n    this.removeAndDirtyAllRelationshipsForItem(item);\n  }\n\n  removeAndDirtyAllRelationshipsForItem(item) {\n    // Handle direct relationships\n    for(var reference of item.content.references) {\n      var relationship = this.findItem(reference.uuid);\n      if(relationship) {\n        item.removeItemAsRelationship(relationship);\n        if(relationship.hasRelationshipWithItem(item)) {\n          relationship.removeItemAsRelationship(item);\n          relationship.setDirty(true);\n        }\n      }\n    }\n\n    // Handle indirect relationships\n    for(var object of item.referencingObjects) {\n      object.removeItemAsRelationship(item);\n      object.setDirty(true);\n    }\n\n    item.referencingObjects = [];\n  }\n\n  /* Used when changing encryption key */\n  setAllItemsDirty(dontUpdateClientDates = true) {\n    var relevantItems = this.allItems;\n\n    for(var item of relevantItems) {\n      item.setDirty(true, dontUpdateClientDates);\n    }\n  }\n\n  removeItemLocally(item, callback) {\n    _.remove(this.items, {uuid: item.uuid});\n    delete this.itemsHash[item.uuid]\n\n    item.isBeingRemovedLocally();\n\n    this.itemsPendingRemoval.push(item.uuid);\n  }\n\n  /* Searching */\n\n  get allItems() {\n    return this.items.filter(function(item){\n      return !item.dummy;\n    })\n  }\n\n  allItemsMatchingTypes(contentTypes) {\n    return this.allItems.filter(function(item){\n      return (_.includes(contentTypes, item.content_type) || _.includes(contentTypes, \"*\")) && !item.dummy;\n    })\n  }\n\n  invalidItems() {\n    return this.allItems.filter((item) => {\n      return item.errorDecrypting;\n    });\n  }\n\n  validItemsForContentType(contentType) {\n    return this.allItems.filter((item) => {\n      return item.content_type == contentType && !item.errorDecrypting;\n    });\n  }\n\n  findItem(itemId) {\n    return this.itemsHash[itemId];\n  }\n\n  findItems(ids, includeBlanks = false) {\n    var results = [];\n    for(var id of ids) {\n      var item = this.itemsHash[id];\n      if(item || includeBlanks) {\n        results.push(item);\n      }\n    }\n    return results;\n  }\n\n  itemsMatchingPredicate(predicate) {\n    return this.itemsMatchingPredicates([predicate]);\n  }\n\n  itemsMatchingPredicates(predicates) {\n    return this.filterItemsWithPredicates(this.allItems, predicates);\n  }\n\n  filterItemsWithPredicates(items, predicates) {\n    var results = items.filter((item) => {\n      for(var predicate of predicates)  {\n        if(!item.satisfiesPredicate(predicate)) {\n          return false;\n        }\n      }\n      return true;\n    })\n\n    return results;\n  }\n\n\n  /*\n  Archives\n  */\n\n  importItems(externalItems) {\n    var itemsToBeMapped = [];\n    for(var itemData of externalItems) {\n      var existing = this.findItem(itemData.uuid);\n      if(existing && !existing.errorDecrypting) {\n        // if the item already exists, check to see if it's different from the import data.\n        // If it's the same, do nothing, otherwise, create a copy.\n        itemData.uuid = null;\n        var dup = this.createConflictedItem(itemData);\n        if(!itemData.deleted && !existing.isItemContentEqualWith(dup)) {\n          // Data differs\n          this.addConflictedItem(dup, existing);\n          itemsToBeMapped.push(dup);\n        }\n      } else {\n        // it doesn't exist, push it into items to be mapped\n        itemsToBeMapped.push(itemData);\n        if(existing && existing.errorDecrypting) {\n          existing.errorDecrypting = false;\n        }\n      }\n    }\n\n    var items = this.mapResponseItemsToLocalModels(itemsToBeMapped, SFModelManager.MappingSourceFileImport);\n    for(var item of items) {\n      item.setDirty(true, true);\n      item.deleted = false;\n    }\n\n    return items;\n  }\n\n  async getAllItemsJSONData(keys, authParams, returnNullIfEmpty) {\n    return this.getJSONDataForItems(this.allItems, keys, authParams, returnNullIfEmpty);\n  }\n\n  async getJSONDataForItems(items, keys, authParams, returnNullIfEmpty) {\n    return Promise.all(items.map((item) => {\n      var itemParams = new SFItemParams(item, keys, authParams);\n      return itemParams.paramsForExportFile();\n    })).then((items) => {\n      if(returnNullIfEmpty && items.length == 0) {\n        return null;\n      }\n\n      var data = {items: items}\n\n      if(keys) {\n        // auth params are only needed when encrypted with a standard file key\n        data[\"auth_params\"] = authParams;\n      }\n\n      return JSON.stringify(data, null, 2 /* pretty print */);\n    })\n  }\n}\n;const SessionHistoryPersistKey = \"sessionHistory_persist\";\nconst SessionHistoryRevisionsKey = \"sessionHistory_revisions\";\nconst SessionHistoryAutoOptimizeKey = \"sessionHistory_autoOptimize\";\n\nexport class SFSessionHistoryManager {\n\n  constructor(modelManager, storageManager, keyRequestHandler, contentTypes, timeout) {\n    this.modelManager = modelManager;\n    this.storageManager = storageManager;\n    this.$timeout = timeout || setTimeout.bind(window);\n\n    // Required to persist the encrypted form of SFHistorySession\n    this.keyRequestHandler = keyRequestHandler;\n\n    this.loadFromDisk().then(() => {\n      this.modelManager.addItemSyncObserver(\"session-history\", contentTypes, (allItems, validItems, deletedItems, source, sourceKey) => {\n        for(let item of allItems) {\n          try {\n            this.addHistoryEntryForItem(item);\n          } catch (e) {\n            console.log(\"Caught exception while trying to add item history entry\", e);\n          }\n        }\n      });\n    })\n  }\n\n  async encryptionParams() {\n    // Should return a dictionary: {offline, keys, auth_params}\n    return this.keyRequestHandler();\n  }\n\n  addHistoryEntryForItem(item) {\n    var persistableItemParams = {\n      uuid: item.uuid,\n      content_type: item.content_type,\n      updated_at: item.updated_at,\n      content: item.content\n    }\n\n    let entry = this.historySession.addEntryForItem(persistableItemParams);\n\n    if(this.autoOptimize) {\n      this.historySession.optimizeHistoryForItem(item);\n    }\n\n    if(entry && this.diskEnabled) {\n      // Debounce, clear existing timeout\n      if(this.diskTimeout) {\n        if(this.$timeout.hasOwnProperty(\"cancel\")) {\n          this.$timeout.cancel(this.diskTimeout);\n        } else {\n          clearTimeout(this.diskTimeout);\n        }\n      };\n      this.diskTimeout = this.$timeout(() => {\n        this.saveToDisk();\n      }, 2000)\n    }\n  }\n\n  historyForItem(item) {\n    return this.historySession.historyForItem(item);\n  }\n\n  async clearHistoryForItem(item) {\n    this.historySession.clearItemHistory(item);\n    return this.saveToDisk();\n  }\n\n  async clearAllHistory() {\n    this.historySession.clearAllHistory();\n    return this.storageManager.removeItem(SessionHistoryRevisionsKey);\n  }\n\n  async toggleDiskSaving() {\n    this.diskEnabled = !this.diskEnabled;\n\n    if(this.diskEnabled) {\n      this.storageManager.setItem(SessionHistoryPersistKey, JSON.stringify(true));\n      this.saveToDisk();\n    } else {\n      this.storageManager.setItem(SessionHistoryPersistKey, JSON.stringify(false));\n      return this.storageManager.removeItem(SessionHistoryRevisionsKey);\n    }\n  }\n\n  async saveToDisk() {\n    if(!this.diskEnabled) {\n      return;\n    }\n\n    let encryptionParams = await this.encryptionParams();\n\n    var itemParams = new SFItemParams(this.historySession, encryptionParams.keys, encryptionParams.auth_params);\n    itemParams.paramsForSync().then((syncParams) => {\n      // console.log(\"Saving to disk\", syncParams);\n      this.storageManager.setItem(SessionHistoryRevisionsKey, JSON.stringify(syncParams));\n    })\n  }\n\n  async loadFromDisk() {\n    var diskValue = await this.storageManager.getItem(SessionHistoryPersistKey);\n    if(diskValue) {\n      this.diskEnabled = JSON.parse(diskValue);\n    }\n\n    var historyValue = await this.storageManager.getItem(SessionHistoryRevisionsKey);\n    if(historyValue) {\n      historyValue = JSON.parse(historyValue);\n      let encryptionParams = await this.encryptionParams();\n      await SFJS.itemTransformer.decryptItem(historyValue, encryptionParams.keys);\n      var historySession = new SFHistorySession(historyValue);\n      this.historySession = historySession;\n    } else {\n      this.historySession = new SFHistorySession();\n    }\n\n    var autoOptimizeValue = await this.storageManager.getItem(SessionHistoryAutoOptimizeKey);\n    if(autoOptimizeValue) {\n      this.autoOptimize = JSON.parse(autoOptimizeValue);\n    } else {\n      // default value is true\n      this.autoOptimize = true;\n    }\n  }\n\n  async toggleAutoOptimize() {\n    this.autoOptimize = !this.autoOptimize;\n\n    if(this.autoOptimize) {\n      this.storageManager.setItem(SessionHistoryAutoOptimizeKey, JSON.stringify(true));\n    } else {\n      this.storageManager.setItem(SessionHistoryAutoOptimizeKey, JSON.stringify(false));\n    }\n  }\n}\n;// SFStorageManager should be subclassed, and all the methods below overwritten.\n\nexport class SFStorageManager {\n\n  /* Simple Key/Value Storage */\n\n  async setItem(key, value) {\n\n  }\n\n  async getItem(key) {\n\n  }\n\n  async removeItem(key) {\n\n  }\n\n  async clear() {\n    // clear only simple key/values\n  }\n\n  /*\n  Model Storage\n  */\n\n  async getAllModels() {\n\n  }\n\n  async saveModel(item) {\n    return this.saveModels([item]);\n  }\n\n  async saveModels(items) {\n\n  }\n\n  async deleteModel(item) {\n\n  }\n\n  async clearAllModels() {\n    // clear only models\n  }\n\n  /* General */\n\n  async clearAllData() {\n    return Promise.all([\n      this.clear(),\n      this.clearAllModels()\n    ])\n  }\n}\n;export class SFSyncManager {\n\n  constructor(modelManager, storageManager, httpManager, timeout, interval) {\n\n    SFSyncManager.KeyRequestLoadLocal = \"KeyRequestLoadLocal\";\n    SFSyncManager.KeyRequestSaveLocal = \"KeyRequestSaveLocal\";\n    SFSyncManager.KeyRequestLoadSaveAccount = \"KeyRequestLoadSaveAccount\";\n\n    this.httpManager = httpManager;\n    this.modelManager = modelManager;\n    this.storageManager = storageManager;\n\n    // Allows you to et your own interval/timeout function (i.e if you're using angular and want to use $timeout)\n    this.$interval = interval || setInterval.bind(window);\n    this.$timeout = timeout || setTimeout.bind(window);\n\n    this.syncStatus = {};\n    this.syncStatusObservers = [];\n    this.eventHandlers = [];\n  }\n\n  async getServerURL() {\n    return await this.storageManager.getItem(\"server\") || window._default_sf_server;\n  }\n\n  async getSyncURL() {\n    return await this.getServerURL() + \"/items/sync\";\n  }\n\n  registerSyncStatusObserver(callback) {\n    var observer = {key: new Date(), callback: callback};\n    this.syncStatusObservers.push(observer);\n    return observer;\n  }\n\n  removeSyncStatusObserver(observer) {\n    _.pull(this.syncStatusObservers, observer);\n  }\n\n  syncStatusDidChange() {\n    this.syncStatusObservers.forEach((observer) => {\n      observer.callback(this.syncStatus);\n    })\n  }\n\n  addEventHandler(handler) {\n    /*\n    Possible Events:\n    sync:completed\n    sync:taking-too-long\n    sync:updated_token\n    sync:error\n    major-data-change\n    local-data-loaded\n    sync-session-invalid\n    sync-exception\n     */\n    this.eventHandlers.push(handler);\n    return handler;\n  }\n\n  removeEventHandler(handler) {\n    _.pull(this.eventHandlers, handler);\n  }\n\n  notifyEvent(syncEvent, data) {\n    for(var handler of this.eventHandlers) {\n      handler(syncEvent, data || {});\n    }\n  }\n\n  setKeyRequestHandler(handler) {\n    this.keyRequestHandler = handler;\n  }\n\n  async getActiveKeyInfo(request) {\n    // request can be one of [KeyRequestSaveLocal, KeyRequestLoadLocal, KeyRequestLoadSaveAccount]\n    // keyRequestHandler is set externally by using class. It should return an object of this format:\n    /*\n    {\n      keys: {pw, mk, ak}\n      auth_params,\n      offline: true/false\n    }\n    */\n    return this.keyRequestHandler(request);\n  }\n\n  initialDataLoaded() {\n    return this._initialDataLoaded;\n  }\n\n  async loadLocalItems(incrementalCallback, batchSize = 100) {\n    return this.storageManager.getAllModels().then((items) => {\n      // break it up into chunks to make interface more responsive for large item counts\n      let total = items.length;\n      var current = 0;\n      var processed = [];\n\n      var decryptNext = async () => {\n        var subitems = items.slice(current, current + batchSize);\n        var processedSubitems = await this.handleItemsResponse(subitems, null, SFModelManager.MappingSourceLocalRetrieved, SFSyncManager.KeyRequestLoadLocal);\n        processed.push(processedSubitems);\n\n        current += subitems.length;\n\n        if(current < total) {\n          return new Promise((innerResolve, innerReject) => {\n            this.$timeout(() => {\n              incrementalCallback && incrementalCallback(current, total);\n              decryptNext().then(innerResolve);\n            });\n          });\n        } else {\n          // Completed\n          this.notifyEvent(\"local-data-loaded\");\n          this._initialDataLoaded = true;\n        }\n      }\n\n      return decryptNext();\n    })\n  }\n\n  async writeItemsToLocalStorage(items, offlineOnly) {\n    return new Promise(async (resolve, reject) => {\n      if(items.length == 0) {\n        resolve();\n        return;\n      }\n\n      let info = await this.getActiveKeyInfo(SFSyncManager.KeyRequestSaveLocal);\n\n      Promise.all(items.map(async (item) => {\n        var itemParams = new SFItemParams(item, info.keys, info.auth_params);\n        itemParams = await itemParams.paramsForLocalStorage();\n        if(offlineOnly) {\n          delete itemParams.dirty;\n        }\n        return itemParams;\n      })).then((params) => {\n        this.storageManager.saveModels(params).then(() => {\n          // on success\n          if(this.syncStatus.localError) {\n            this.syncStatus.localError = null;\n            this.syncStatusDidChange();\n          }\n          resolve();\n        }).catch((error) => {\n          // on error\n          console.error(\"Error writing items\", error);\n          this.syncStatus.localError = error;\n          this.syncStatusDidChange();\n          reject();\n        });\n      }).catch((e) => {\n        reject(e);\n      })\n    })\n  }\n\n  async syncOffline(items) {\n    // Update all items updated_at to now\n    for(var item of items) { item.updated_at = new Date(); }\n    return this.writeItemsToLocalStorage(items, true).then((responseItems) => {\n      // delete anything needing to be deleted\n      for(var item of items) {\n        if(item.deleted) { this.modelManager.removeItemLocally(item);}\n      }\n\n      this.notifyEvent(\"sync:completed\");\n      // Required in order for modelManager to notify sync observers\n      this.modelManager.didSyncModelsOffline(items);\n\n      return {saved_items: items};\n    })\n  }\n\n  /*\n    In the case of signing in and merging local data, we alternative UUIDs\n    to avoid overwriting data a user may retrieve that has the same UUID.\n    Alternating here forces us to to create duplicates of the items instead.\n   */\n  async markAllItemsDirtyAndSaveOffline(alternateUUIDs) {\n\n    // use a copy, as alternating uuid will affect array\n    var originalItems = this.modelManager.allItems.filter((item) => {return !item.errorDecrypting}).slice();\n\n    if(alternateUUIDs) {\n      for(var item of originalItems) {\n        // Update: the last params has been removed. Defaults to true.\n        // Old: alternateUUIDForItem last param is a boolean that controls whether the original item\n        // should be removed locally after new item is created. We set this to true, since during sign in,\n        // all item ids are alternated, and we only want one final copy of the entire data set.\n        // Passing false can be desired sometimes, when for example the app has signed out the user,\n        // but for some reason retained their data (This happens in Firefox when using private mode).\n        // In this case, we should pass false so that both copies are kept. However, it's difficult to\n        // detect when the app has entered this state. We will just use true to remove original items for now.\n        await this.modelManager.alternateUUIDForItem(item);\n      }\n    }\n\n    var allItems = this.modelManager.allItems;\n    for(var item of allItems) { item.setDirty(true); }\n    return this.writeItemsToLocalStorage(allItems, false);\n  }\n\n  async setSyncToken(token) {\n    this._syncToken = token;\n    await this.storageManager.setItem(\"syncToken\", token);\n  }\n\n  async getSyncToken() {\n    if(!this._syncToken) {\n      this._syncToken = await this.storageManager.getItem(\"syncToken\");\n    }\n    return this._syncToken;\n  }\n\n  async setCursorToken(token) {\n    this._cursorToken = token;\n    if(token) {\n      await this.storageManager.setItem(\"cursorToken\", token);\n    } else {\n      await this.storageManager.removeItem(\"cursorToken\");\n    }\n  }\n\n  async getCursorToken() {\n    if(!this._cursorToken) {\n      this._cursorToken = await this.storageManager.getItem(\"cursorToken\");\n    }\n    return this._cursorToken;\n  }\n\n  get queuedCallbacks() {\n    if(!this._queuedCallbacks) {\n      this._queuedCallbacks = [];\n    }\n    return this._queuedCallbacks;\n  }\n\n  clearQueuedCallbacks() {\n    this._queuedCallbacks = [];\n  }\n\n  callQueuedCallbacks(response) {\n    var allCallbacks = this.queuedCallbacks;\n    if(allCallbacks.length) {\n      for(var eachCallback of allCallbacks) {\n        eachCallback(response);\n      }\n      this.clearQueuedCallbacks();\n    }\n  }\n\n  beginCheckingIfSyncIsTakingTooLong() {\n    if(this.syncStatus.checker) {\n      this.stopCheckingIfSyncIsTakingTooLong();\n    }\n    this.syncStatus.checker = this.$interval(function(){\n      // check to see if the ongoing sync is taking too long, alert the user\n      var secondsPassed = (new Date() - this.syncStatus.syncStart) / 1000;\n      var warningThreshold = 5.0; // seconds\n      if(secondsPassed > warningThreshold) {\n        this.notifyEvent(\"sync:taking-too-long\");\n        this.stopCheckingIfSyncIsTakingTooLong();\n      }\n    }.bind(this), 500)\n  }\n\n  stopCheckingIfSyncIsTakingTooLong() {\n    if(this.$interval.hasOwnProperty(\"cancel\")) {\n      this.$interval.cancel(this.syncStatus.checker);\n    } else {\n      clearInterval(this.syncStatus.checker);\n    }\n    this.syncStatus.checker = null;\n  }\n\n  lockSyncing() {\n    this.syncLocked = true;\n  }\n\n  unlockSyncing() {\n    this.syncLocked = false;\n  }\n\n  async sync(options = {}) {\n    return new Promise(async (resolve, reject) => {\n\n      if(this.syncLocked) {\n        console.log(\"Sync Locked, Returning;\");\n        resolve();\n        return;\n      }\n\n      if(!options) options = {};\n\n      var allDirtyItems = this.modelManager.getDirtyItems();\n\n      // When a user hits the physical refresh button, we want to force refresh, in case\n      // the sync engine is stuck in some inProgress loop.\n      if(this.syncStatus.syncOpInProgress && !options.force) {\n        this.repeatOnCompletion = true;\n        this.queuedCallbacks.push(resolve);\n\n        // write to local storage nonetheless, since some users may see several second delay in server response.\n        // if they close the browser before the ongoing sync request completes, local changes will be lost if we dont save here\n        this.writeItemsToLocalStorage(allDirtyItems, false);\n\n        console.log(\"Sync op in progress; returning.\");\n        return;\n      }\n\n      let info = await this.getActiveKeyInfo(SFSyncManager.KeyRequestLoadSaveAccount);\n\n      // we want to write all dirty items to disk only if the user is offline, or if the sync op fails\n      // if the sync op succeeds, these items will be written to disk by handling the \"saved_items\" response from the server\n      if(info.offline) {\n        this.syncOffline(allDirtyItems).then((response) => {\n          this.modelManager.clearDirtyItems(allDirtyItems);\n          resolve(response);\n        }).catch((e) => {\n          this.notifyEvent(\"sync-exception\", e);\n        })\n        return;\n      }\n\n      var isContinuationSync = this.syncStatus.needsMoreSync;\n\n      this.syncStatus.syncOpInProgress = true;\n      this.syncStatus.syncStart = new Date();\n      this.beginCheckingIfSyncIsTakingTooLong();\n\n      let submitLimit = 100;\n      var subItems = allDirtyItems.slice(0, submitLimit);\n      if(subItems.length < allDirtyItems.length) {\n        // more items left to be synced, repeat\n        this.syncStatus.needsMoreSync = true;\n      } else {\n        this.syncStatus.needsMoreSync = false;\n      }\n\n      if(!isContinuationSync) {\n        this.syncStatus.total = allDirtyItems.length;\n        this.syncStatus.current = 0;\n      }\n\n      // If items are marked as dirty during a long running sync request, total isn't updated\n      // This happens mostly in the case of large imports and sync conflicts where duplicated items are created\n      if(this.syncStatus.current > this.syncStatus.total) {\n        this.syncStatus.total = this.syncStatus.current;\n      }\n\n      this.syncStatusDidChange();\n\n      // when doing a sync request that returns items greater than the limit, and thus subsequent syncs are required,\n      // we want to keep track of all retreived items, then save to local storage only once all items have been retrieved,\n      // so that relationships remain intact\n      // Update 12/18: I don't think we need to do this anymore, since relationships will now retroactively resolve their relationships,\n      // if an item they were looking for hasn't been pulled in yet.\n      if(!this.allRetreivedItems) {\n        this.allRetreivedItems = [];\n      }\n\n      // We also want to do this for savedItems\n      if(!this.allSavedItems) {\n        this.allSavedItems = [];\n      }\n\n      var params = {};\n      params.limit = 150;\n\n      try {\n        await Promise.all(subItems.map((item) => {\n          var itemParams = new SFItemParams(item, info.keys, info.auth_params);\n          itemParams.additionalFields = options.additionalFields;\n          return itemParams.paramsForSync();\n        })).then((itemsParams) => {\n          params.items = itemsParams;\n        })\n      } catch (e) {\n        this.notifyEvent(\"sync-exception\", e);\n      }\n\n      for(var item of subItems) {\n        // Reset dirty counter to 0, since we're about to sync it.\n        // This means anyone marking the item as dirty after this will cause it so sync again and not be cleared on sync completion.\n        item.dirtyCount = 0;\n      }\n\n      params.sync_token = await this.getSyncToken();\n      params.cursor_token = await this.getCursorToken();\n\n      try {\n        this.httpManager.postAbsolute(await this.getSyncURL(), params, (response) => {\n          this.handleSyncSuccess(subItems, response, options).then(() => {\n            resolve(response);\n          }).catch((e) => {\n            console.log(\"Caught sync success exception:\", e);\n            this.handleSyncError(null, null, allDirtyItems).then((errorResponse) => {\n              resolve(errorResponse);\n            });\n          });\n        }, (response, statusCode) => {\n          this.handleSyncError(response, statusCode, allDirtyItems).then((errorResponse) => {\n            resolve(errorResponse);\n          });\n        });\n      }\n      catch(e) {\n        console.log(\"Sync exception caught:\", e);\n      }\n    });\n  }\n\n  async handleSyncSuccess(syncedItems, response, options) {\n    // Check to make sure any subItem hasn't been marked as dirty again while a sync was ongoing\n    var itemsToClearAsDirty = [];\n    for(var item of syncedItems) {\n      if(item.dirtyCount == 0) {\n        // Safe to clear as dirty\n        itemsToClearAsDirty.push(item);\n      }\n    }\n    this.modelManager.clearDirtyItems(itemsToClearAsDirty);\n    this.syncStatus.error = null;\n\n    // Filter retrieved_items to remove any items that may be in saved_items for this complete sync operation\n    // When signing in, and a user requires many round trips to complete entire retrieval of data, an item may be saved\n    // on the first trip, then on subsequent trips using cursor_token, this same item may be returned, since it's date is\n    // greater than cursor_token. We keep track of all saved items in whole sync operation with this.allSavedItems\n    // We need this because singletonManager looks at retrievedItems as higher precendence than savedItems, but if it comes in both\n    // then that's problematic.\n\n    let allSavedUUIDs = this.allSavedItems.map((item) => {return item.uuid});\n    response.retrieved_items = response.retrieved_items.filter((candidate) => {return !allSavedUUIDs.includes(candidate.uuid)});\n\n    // Map retrieved items to local data\n    // Note that deleted items will not be returned\n    var retrieved = await this.handleItemsResponse(response.retrieved_items, null, SFModelManager.MappingSourceRemoteRetrieved, SFSyncManager.KeyRequestLoadSaveAccount);\n\n    // Append items to master list of retrieved items for this ongoing sync operation\n    this.allRetreivedItems = this.allRetreivedItems.concat(retrieved);\n    this.syncStatus.retrievedCount = this.allRetreivedItems.length;\n\n    // Merge only metadata for saved items\n    // we write saved items to disk now because it clears their dirty status then saves\n    // if we saved items before completion, we had have to save them as dirty and save them again on success as clean\n    var omitFields = [\"content\", \"auth_hash\"];\n\n    // Map saved items to local data\n    var saved = await this.handleItemsResponse(response.saved_items, omitFields, SFModelManager.MappingSourceRemoteSaved, SFSyncManager.KeyRequestLoadSaveAccount);\n\n    // Append items to master list of saved items for this ongoing sync operation\n    this.allSavedItems = this.allSavedItems.concat(saved);\n\n    // Create copies of items or alternate their uuids if neccessary\n    var unsaved = response.unsaved;\n    // don't `await`. This function calls sync, so if you wait, it will call sync without having completed the sync we're in.\n    // On second thought, calling await will only await the local conflict resolution and not await the sync call.\n    // We do need to wait here for sync duplication to finish. If we don't, there seems to be an issue where if you import a large\n    // backup with uuid-conflcits (from another account), you'll see very confused duplication.\n    await this.handleUnsavedItemsResponse(unsaved);\n\n    await this.writeItemsToLocalStorage(saved, false);\n    await this.writeItemsToLocalStorage(retrieved, false);\n\n    this.syncStatus.syncOpInProgress = false;\n    this.syncStatus.current += syncedItems.length;\n\n    this.syncStatusDidChange();\n\n    let isInitialSync = (await this.getSyncToken()) == null;\n\n    // set the sync token at the end, so that if any errors happen above, you can resync\n    this.setSyncToken(response.sync_token);\n    this.setCursorToken(response.cursor_token);\n\n    this.stopCheckingIfSyncIsTakingTooLong();\n\n    // Oct 2018: Why use both this.syncStatus.needsMoreSync and this.repeatOnCompletion?\n    // They seem to do the same thing.\n\n    if(await this.getCursorToken() || this.syncStatus.needsMoreSync) {\n      return new Promise((resolve, reject) => {\n        setTimeout(function () {\n          this.sync(options).then(resolve);\n        }.bind(this), 10); // wait 10ms to allow UI to update\n      })\n    }\n\n    else if(this.repeatOnCompletion) {\n      this.repeatOnCompletion = false;\n      return new Promise((resolve, reject) => {\n        setTimeout(function () {\n          this.sync(options).then(resolve);\n        }.bind(this), 10); // wait 10ms to allow UI to update\n      });\n    }\n\n    else {\n      /*\n      // await this.writeItemsToLocalStorage(this.allRetreivedItems, false);\n        We used to do this, but the problem is, if you're saving 2000 items at the end of a sign in,\n        then refresh or close the page, the items will not be saved, and the sync token will be the lastest.\n        So the data won't be downloaded again. Instead, we'll save retrieved as they come.\n      */\n\n\n      this.syncStatus.retrievedCount = 0;\n      this.syncStatusDidChange();\n\n      // The number of changed items that constitute a major change\n      // This is used by the desktop app to create backups\n      let majorDataChangeThreshold = 10;\n      if(\n        this.allRetreivedItems.length >= majorDataChangeThreshold ||\n        saved.length >= majorDataChangeThreshold ||\n        unsaved.length >= majorDataChangeThreshold\n      ) {\n        this.notifyEvent(\"major-data-change\");\n      }\n\n      this.callQueuedCallbacks(response);\n      this.notifyEvent(\"sync:completed\", {retrievedItems: this.allRetreivedItems, savedItems: this.allSavedItems, unsavedItems: unsaved, initialSync: isInitialSync});\n\n      this.allRetreivedItems = [];\n      this.allSavedItems = [];\n\n      return response;\n    }\n  }\n\n  async handleSyncError(response, statusCode, allDirtyItems) {\n    console.log(\"Sync error\", response);\n    if(statusCode == 401) {\n      this.notifyEvent(\"sync-session-invalid\");\n    }\n\n    console.log(\"Sync error: \", response);\n\n    if(!response) {\n      response = {error: {message: \"Could not connect to server.\"}};\n    }\n\n    this.syncStatus.syncOpInProgress = false;\n    this.syncStatus.error = response.error;\n    this.syncStatusDidChange();\n\n    this.writeItemsToLocalStorage(allDirtyItems, false);\n    this.modelManager.didSyncModelsOffline(allDirtyItems);\n\n    this.stopCheckingIfSyncIsTakingTooLong();\n\n    this.notifyEvent(\"sync:error\", response.error);\n\n    this.callQueuedCallbacks({error: \"Sync error\"});\n\n    return response;\n  }\n\n  async handleItemsResponse(responseItems, omitFields, source, keyRequest) {\n    var keys = (await this.getActiveKeyInfo(keyRequest)).keys;\n    await SFJS.itemTransformer.decryptMultipleItems(responseItems, keys);\n    var items = this.modelManager.mapResponseItemsToLocalModelsOmittingFields(responseItems, omitFields, source);\n\n    // During the decryption process, items may be marked as \"errorDecrypting\". If so, we want to be sure\n    // to persist this new state by writing these items back to local storage. When an item's \"errorDecrypting\"\n    // flag is changed, its \"errorDecryptingValueChanged\" flag will be set, so we can find these items by filtering (then unsetting) below:\n    var itemsWithErrorStatusChange = items.filter((item) => {\n      var valueChanged = item.errorDecryptingValueChanged;\n      // unset after consuming value\n      item.errorDecryptingValueChanged = false;\n      return valueChanged;\n    });\n    if(itemsWithErrorStatusChange.length > 0) {\n      this.writeItemsToLocalStorage(itemsWithErrorStatusChange, false);\n    }\n\n    return items;\n  }\n\n  async refreshErroredItems() {\n    var erroredItems = this.modelManager.allItems.filter((item) => {return item.errorDecrypting == true});\n    if(erroredItems.length > 0) {\n      return this.handleItemsResponse(erroredItems, null, SFModelManager.MappingSourceLocalRetrieved, SFSyncManager.KeyRequestLoadSaveAccount);\n    }\n  }\n\n  async handleUnsavedItemsResponse(unsaved) {\n    if(unsaved.length == 0) {\n      return;\n    }\n\n    console.log(\"Handle Conflicted Items:\", unsaved);\n\n    for(let mapping of unsaved) {\n      var itemResponse = mapping.item;\n      await SFJS.itemTransformer.decryptMultipleItems([itemResponse], (await this.getActiveKeyInfo(SFSyncManager.KeyRequestLoadSaveAccount)).keys);\n      var item = this.modelManager.findItem(itemResponse.uuid);\n\n      // Could be deleted\n      if(!item) { continue; }\n\n      var error = mapping.error;\n\n      if(error.tag === \"uuid_conflict\") {\n        // UUID conflicts can occur if a user attempts to\n        // import an old data archive with uuids from the old account into a new account\n        await this.modelManager.alternateUUIDForItem(item);\n      }\n\n      else if(error.tag === \"sync_conflict\") {\n        // Create a new item with the same contents of this item if the contents differ\n        // We want a new uuid for the new item. Note that this won't neccessarily adjust references.\n        itemResponse.uuid = await SFJS.crypto.generateUUID();\n\n        var dup = this.modelManager.createConflictedItem(itemResponse);\n        if(!itemResponse.deleted && !item.isItemContentEqualWith(dup)) {\n          this.modelManager.addConflictedItem(dup, item);\n        }\n      }\n    }\n\n    // This will immediately result in \"Sync op in progress\" and sync will be queued.\n    // That's ok. You actually want a sync op in progress so that the new items are saved to disk right away.\n    // If you add a timeout here of 100ms, you'll avoid sync op in progress, but it will be a few ms before the items\n    // are saved to disk, meaning that the user may see All changes saved a few ms before changes are saved to disk.\n    // You could also just write to disk manually here, but syncing here is 100% sure to trigger sync op in progress as that's\n    // where it's being called from.\n    this.sync(null, {additionalFields: [\"created_at\", \"updated_at\"]});\n  }\n\n  async handleSignout() {\n    this._syncToken = null;\n    this._cursorToken = null;\n    this._queuedCallbacks = [];\n    this.syncStatus = {};\n  }\n\n  async clearSyncToken() {\n    this._syncToken = null;\n    this._cursorToken = null;\n    return this.storageManager.removeItem(\"syncToken\");\n  }\n}\n;var dateFormatter;\n\nexport class SFItem {\n\n  constructor(json_obj = {}) {\n    this.appData = {};\n    this.content = {};\n    this.referencingObjects = [];\n    this.updateFromJSON(json_obj);\n\n    if(!this.uuid) {\n      // on React Native, this method will not exist. UUID gen will be handled manually via async methods.\n      if(typeof(SFJS) !== \"undefined\" && SFJS.crypto.generateUUIDSync) {\n        this.uuid = SFJS.crypto.generateUUIDSync();\n      }\n    }\n\n    if(!this.content.references) {\n      this.content.references = [];\n    }\n  }\n\n  get contentObject() {\n    if(!this.content) {\n      this.content = {};\n      return this.content;\n    }\n\n    if(this.content !== null && typeof this.content === 'object') {\n      // this is the case when mapping localStorage content, in which case the content is already parsed\n      return this.content;\n    }\n\n    try {\n      let content = JSON.parse(this.content);\n      this.content = content;\n      return this.content;\n    } catch (e) {\n      console.log(\"Error parsing json\", e, this);\n      this.content = {};\n      return this.content;\n    }\n  }\n\n  static deepMerge(a, b) {\n    // By default _.merge will not merge a full array with an empty one.\n    // We want to replace arrays wholesale\n    function mergeCopyArrays(objValue, srcValue) {\n      if (_.isArray(objValue)) {\n        return srcValue;\n      }\n    }\n    _.mergeWith(a, b, mergeCopyArrays);\n    return a;\n  }\n\n  updateFromJSON(json) {\n    // Manually merge top level data instead of wholesale merge\n    this.created_at = json.created_at;\n    this.updated_at = json.updated_at;\n    this.deleted = json.deleted;\n    this.uuid = json.uuid;\n    this.enc_item_key = json.enc_item_key;\n    this.auth_hash = json.auth_hash;\n    this.auth_params = json.auth_params;\n\n    // When updating from server response (as opposed to local json response), these keys will be missing.\n    // So we only want to update these values if they are explicitly present.\n    let clientKeys = [\"errorDecrypting\", \"conflict_of\", \"dirty\", \"dirtyCount\"];\n    for(var key of clientKeys) {\n      if(json[key] !== undefined) {\n        this[key] = json[key];\n      }\n    }\n\n    // Check if object has getter for content_type, and if so, skip\n    if(!this.content_type) {\n      this.content_type = json.content_type;\n    }\n\n    // this.content = json.content will copy it by reference rather than value. So we need to do a deep merge after.\n    // json.content can still be a string here. We copy it to this.content, then do a deep merge to transfer over all values.\n\n    try {\n      let parsedContent = typeof json.content === 'string' ? JSON.parse(json.content) : json.content;\n      SFItem.deepMerge(this.contentObject, parsedContent);\n    } catch (e) {\n      console.log(\"Error while updating item from json\", e);\n    }\n\n    if(this.created_at) {\n      this.created_at = new Date(this.created_at);\n      this.updated_at = new Date(this.updated_at);\n    } else {\n      this.created_at = new Date();\n      this.updated_at = new Date();\n    }\n\n    // Allows the getter to be re-invoked\n    this._client_updated_at = null;\n\n    if(json.content) {\n      this.mapContentToLocalProperties(this.contentObject);\n    } else if(json.deleted == true) {\n      this.handleDeletedContent();\n    }\n  }\n\n  mapContentToLocalProperties(contentObj) {\n    if(contentObj.appData) {\n      this.appData = contentObj.appData;\n    }\n    if(!this.appData) { this.appData = {}; }\n  }\n\n  createContentJSONFromProperties() {\n    return this.structureParams();\n  }\n\n  structureParams() {\n    var params = this.contentObject;\n    params.appData = this.appData;\n    return params;\n  }\n\n  /* Allows the item to handle the case where the item is deleted and the content is null */\n  handleDeletedContent() {\n    // Subclasses can override\n  }\n\n  setDirty(dirty, dontUpdateClientDate) {\n    this.dirty = dirty;\n\n    // Allows the syncManager to check if an item has been marked dirty after a sync has been started\n    // This prevents it from clearing it as a dirty item after sync completion, if someone else has marked it dirty\n    // again after an ongoing sync.\n    if(!this.dirtyCount) { this.dirtyCount = 0; }\n    if(dirty) {\n      this.dirtyCount++;\n    } else {\n      this.dirtyCount = 0;\n    }\n\n    if(dirty && !dontUpdateClientDate) {\n      // Set the client modified date to now if marking the item as dirty\n      this.client_updated_at = new Date();\n    } else if(!this.hasRawClientUpdatedAtValue()) {\n      // copy updated_at\n      this.client_updated_at = new Date(this.updated_at);\n    }\n  }\n\n  updateLocalRelationships() {\n    // optional override\n  }\n\n  addItemAsRelationship(item) {\n    item.setIsBeingReferencedBy(this);\n\n    if(this.hasRelationshipWithItem(item)) {\n      return;\n    }\n\n    var references = this.content.references || [];\n    references.push({\n      uuid: item.uuid,\n      content_type: item.content_type\n    })\n    this.content.references = references;\n  }\n\n  removeItemAsRelationship(item) {\n    item.setIsNoLongerBeingReferencedBy(this);\n    this.removeReferenceWithUuid(item.uuid);\n  }\n\n  // When another object has a relationship with us, we push that object into memory here.\n  // We use this so that when `this` is deleted, we're able to update the references of those other objects.\n  // For example, a Note has a one way relationship with a Tag. If a Tag is deleted, we want to update\n  // the Note's references to remove the tag relationship.\n  setIsBeingReferencedBy(item) {\n    if(!_.find(this.referencingObjects, {uuid: item.uuid})) {\n      this.referencingObjects.push(item);\n    }\n  }\n\n  setIsNoLongerBeingReferencedBy(item) {\n    _.remove(this.referencingObjects, {uuid: item.uuid});\n    // Legacy two-way relationships should be handled here\n    if(this.hasRelationshipWithItem(item)) {\n      this.removeReferenceWithUuid(item.uuid);\n      // We really shouldn't have the authority to set this item as dirty, but it's the only way to save this change.\n      this.setDirty(true);\n    }\n  }\n\n  removeReferenceWithUuid(uuid) {\n    var references = this.content.references || [];\n    references = references.filter((r) => {return r.uuid != uuid});\n    this.content.references = references;\n  }\n\n  hasRelationshipWithItem(item) {\n    let target = this.content.references.find((r) => {\n      return r.uuid == item.uuid;\n    });\n    return target != null;\n  }\n\n  isBeingRemovedLocally() {\n\n  }\n\n  didFinishSyncing() {\n\n  }\n\n  informReferencesOfUUIDChange(oldUUID, newUUID) {\n    // optional override\n  }\n\n  potentialItemOfInterestHasChangedItsUUID(newItem, oldUUID, newUUID) {\n    // optional override\n    for(var reference of this.content.references) {\n      if(reference.uuid == oldUUID) {\n        reference.uuid = newUUID;\n        this.setDirty(true);\n      }\n    }\n  }\n\n  doNotEncrypt() {\n    return false;\n  }\n\n  /*\n  App Data\n  */\n\n  setDomainDataItem(key, value, domain) {\n    if(!domain) {\n      console.error(\"SFItem.AppDomain needs to be set.\");\n      return;\n    }\n    var data = this.appData[domain];\n    if(!data) {\n      data = {}\n    }\n    data[key] = value;\n    this.appData[domain] = data;\n  }\n\n  getDomainDataItem(key, domain) {\n    if(!domain) {\n      console.error(\"SFItem.AppDomain needs to be set.\");\n      return;\n    }\n    var data = this.appData[domain];\n    if(data) {\n      return data[key];\n    } else {\n      return null;\n    }\n  }\n\n  setAppDataItem(key, value) {\n    this.setDomainDataItem(key, value, SFItem.AppDomain);\n  }\n\n  getAppDataItem(key) {\n    return this.getDomainDataItem(key, SFItem.AppDomain);\n  }\n\n  get pinned() {\n    return this.getAppDataItem(\"pinned\");\n  }\n\n  get archived() {\n    return this.getAppDataItem(\"archived\");\n  }\n\n  get locked() {\n    return this.getAppDataItem(\"locked\");\n  }\n\n  // May be used by clients to display the human readable type for this item. Should be overriden by subclasses.\n  get displayName() {\n    return \"Item\";\n  }\n\n  hasRawClientUpdatedAtValue() {\n    return this.getAppDataItem(\"client_updated_at\") != null;\n  }\n\n  get client_updated_at() {\n    if(!this._client_updated_at) {\n      var saved = this.getAppDataItem(\"client_updated_at\");\n      if(saved) {\n        this._client_updated_at = new Date(saved);\n      } else {\n        this._client_updated_at = new Date(this.updated_at);\n      }\n    }\n    return this._client_updated_at;\n  }\n\n  set client_updated_at(date) {\n    this._client_updated_at = date;\n\n    this.setAppDataItem(\"client_updated_at\", date);\n  }\n\n  /*\n    During sync conflicts, when determing whether to create a duplicate for an item, we can omit keys that have no\n    meaningful weight and can be ignored. For example, if one component has active = true and another component has active = false,\n    it would be silly to duplicate them, so instead we ignore this.\n   */\n  keysToIgnoreWhenCheckingContentEquality() {\n    return [];\n  }\n\n  // Same as above, but keys inside appData[Item.AppDomain]\n  appDataKeysToIgnoreWhenCheckingContentEquality() {\n    return [\"client_updated_at\"];\n  }\n\n  isItemContentEqualWith(otherItem) {\n    let omit = (obj, keys) => {\n      if(!obj) { return obj; }\n      for(var key of keys) {\n        delete obj[key];\n      }\n      return obj;\n    }\n\n    var left = this.structureParams();\n    left.appData[SFItem.AppDomain] = omit(left.appData[SFItem.AppDomain], this.appDataKeysToIgnoreWhenCheckingContentEquality());\n    left = omit(left, this.keysToIgnoreWhenCheckingContentEquality());\n\n    var right = otherItem.structureParams();\n    right.appData[SFItem.AppDomain] = omit(right.appData[SFItem.AppDomain], otherItem.appDataKeysToIgnoreWhenCheckingContentEquality());\n    right = omit(right, otherItem.keysToIgnoreWhenCheckingContentEquality());\n\n    return JSON.stringify(left) === JSON.stringify(right);\n  }\n\n  satisfiesPredicate(predicate) {\n    /*\n    Predicate is an SFPredicate having properties:\n    {\n      keypath: String,\n      operator: String,\n      value: object\n    }\n     */\n    return SFPredicate.ItemSatisfiesPredicate(this, predicate);\n  }\n\n  /*\n  Dates\n  */\n\n  createdAtString() {\n    return this.dateToLocalizedString(this.created_at);\n  }\n\n  updatedAtString() {\n    return this.dateToLocalizedString(this.client_updated_at);\n  }\n\n  dateToLocalizedString(date) {\n    if (typeof Intl !== 'undefined' && Intl.DateTimeFormat) {\n      if (!dateFormatter) {\n        var locale = (navigator.languages && navigator.languages.length) ? navigator.languages[0] : navigator.language;\n        dateFormatter = new Intl.DateTimeFormat(locale, {\n          year: 'numeric',\n          month: 'short',\n          day: '2-digit',\n          weekday: 'long',\n          hour: '2-digit',\n          minute: '2-digit',\n        });\n      }\n      return dateFormatter.format(date);\n    } else {\n      // IE < 11, Safari <= 9.0.\n      // In English, this generates the string most similar to\n      // the toLocaleDateString() result above.\n      return date.toDateString() + ' ' + date.toLocaleTimeString();\n    }\n  }\n\n}\n;export class SFItemParams {\n\n  constructor(item, keys, auth_params) {\n    this.item = item;\n    this.keys = keys;\n    this.auth_params = auth_params;\n\n    if(this.keys && !this.auth_params) {\n      throw \"SFItemParams.auth_params must be supplied if supplying keys.\";\n    }\n\n    if(this.auth_params && !this.auth_params.version) {\n      throw \"SFItemParams.auth_params is missing version\";\n    }\n  }\n\n  async paramsForExportFile(includeDeleted) {\n    this.additionalFields = [\"updated_at\"];\n    this.forExportFile = true;\n    if(includeDeleted) {\n      return this.__params();\n    } else {\n      var result = await this.__params();\n      return _.omit(result, [\"deleted\"]);\n    }\n  }\n\n  async paramsForExtension() {\n    return this.paramsForExportFile();\n  }\n\n  async paramsForLocalStorage() {\n    this.additionalFields = [\"updated_at\", \"dirty\", \"errorDecrypting\"];\n    this.forExportFile = true;\n    return this.__params();\n  }\n\n  async paramsForSync() {\n    return this.__params();\n  }\n\n  async __params() {\n\n    var params = {uuid: this.item.uuid, content_type: this.item.content_type, deleted: this.item.deleted, created_at: this.item.created_at};\n    if(!this.item.errorDecrypting) {\n      // Items should always be encrypted for export files. Only respect item.doNotEncrypt for remote sync params.\n      var doNotEncrypt = this.item.doNotEncrypt() && !this.forExportFile;\n      if(this.keys && !doNotEncrypt) {\n        var encryptedParams = await SFJS.itemTransformer.encryptItem(this.item, this.keys, this.auth_params);\n        _.merge(params, encryptedParams);\n\n        if(this.auth_params.version !== \"001\") {\n          params.auth_hash = null;\n        }\n      }\n      else {\n        params.content = this.forExportFile ? this.item.createContentJSONFromProperties() : \"000\" + await SFJS.crypto.base64(JSON.stringify(this.item.createContentJSONFromProperties()));\n        if(!this.forExportFile) {\n          params.enc_item_key = null;\n          params.auth_hash = null;\n        }\n      }\n    } else {\n      // Error decrypting, keep \"content\" and related fields as is (and do not try to encrypt, otherwise that would be undefined behavior)\n      params.content = this.item.content;\n      params.enc_item_key = this.item.enc_item_key;\n      params.auth_hash = this.item.auth_hash;\n    }\n\n    if(this.additionalFields) {\n      _.merge(params, _.pick(this.item, this.additionalFields));\n    }\n\n    return params;\n  }\n\n\n}\n;export class SFPredicate {\n  constructor(keypath, operator, value) {\n    this.keypath = keypath;\n    this.operator = operator;\n    this.value = value;\n  }\n\n  static fromArray(array) {\n    var pred = new SFPredicate();\n    pred.keypath = array[0];\n    pred.operator = array[1];\n    pred.value = array[2];\n    return pred;\n  }\n\n  static ObjectSatisfiesPredicate(object, predicate) {\n    var valueAtKeyPath = predicate.keypath.split('.').reduce((previous, current) => {\n      return previous && previous[current]\n    }, object);\n\n    var predicateValue = predicate.value;\n    if(typeof(predicateValue) == 'string' && predicateValue.includes(\".ago\")) {\n      predicateValue = this.DateFromString(predicateValue);\n    }\n\n    const falseyValues = [false, \"\", null, undefined, NaN];\n\n    if(valueAtKeyPath == undefined) {\n      return falseyValues.includes(predicate.value);\n    }\n\n    if(predicate.operator == \"=\") {\n      // Use array comparison\n      if(Array.isArray(valueAtKeyPath)) {\n        return JSON.stringify(valueAtKeyPath) == JSON.stringify(predicateValue);\n      } else {\n        return valueAtKeyPath == predicateValue;\n      }\n    } else if(predicate.operator == \"<\")  {\n      return valueAtKeyPath < predicateValue;\n    } else if(predicate.operator == \">\")  {\n      return valueAtKeyPath > predicateValue;\n    } else if(predicate.operator == \"<=\")  {\n      return valueAtKeyPath <= predicateValue;\n    } else if(predicate.operator == \">=\")  {\n      return valueAtKeyPath >= predicateValue;\n    } else if(predicate.operator == \"startsWith\")  {\n      return valueAtKeyPath.startsWith(predicateValue);\n    } else if(predicate.operator == \"in\") {\n      return predicateValue.indexOf(valueAtKeyPath) != -1;\n    } else if(predicate.operator == \"includes\") {\n      return this.resolveIncludesPredicate(valueAtKeyPath, predicateValue);\n    } else if(predicate.operator == \"matches\") {\n      var regex = new RegExp(predicateValue);\n      return regex.test(valueAtKeyPath);\n    }\n\n    return false;\n  }\n\n  static resolveIncludesPredicate(valueAtKeyPath, predicateValue) {\n    // includes can be a string  or a predicate (in array form)\n    if(typeof(predicateValue) == 'string') {\n      // if string, simply check if the valueAtKeyPath includes the predicate value\n      return valueAtKeyPath.includes(predicateValue);\n    } else {\n      // is a predicate array or predicate object\n      var innerPredicate;\n      if(Array.isArray(predicateValue)) {\n        innerPredicate = SFPredicate.fromArray(predicateValue);\n      } else {\n        innerPredicate = predicateValue;\n      }\n      for(var obj of valueAtKeyPath) {\n        if(this.ObjectSatisfiesPredicate(obj, innerPredicate)) {\n          return true;\n        }\n      }\n      return false;\n    }\n  }\n\n  static ItemSatisfiesPredicate(item, predicate) {\n    if(Array.isArray(predicate)) {\n      predicate = SFPredicate.fromArray(predicate);\n    }\n    return this.ObjectSatisfiesPredicate(item, predicate);\n  }\n\n  static ItemSatisfiesPredicates(item, predicates) {\n    for(var predicate of predicates) {\n      if(!this.ItemSatisfiesPredicate(item, predicate)) {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  static DateFromString(string) {\n    // x.days.ago, x.hours.ago\n    var comps = string.split(\".\");\n    var unit = comps[1];\n    var date = new Date;\n    var offset = parseInt(comps[0]);\n    if(unit == \"days\") {\n      date.setDate(date.getDate() - offset);\n    } else if(unit == \"hours\") {\n      date.setHours(date.getHours() - offset);\n    }\n    return date;\n  }\n}\n;/*\n  Important: This is the only object in the session history domain that is persistable.\n\n  A history session contains one main content object:\n  the itemUUIDToItemHistoryMapping. This is a dictionary whose keys are item uuids,\n  and each value is an SFItemHistory object.\n\n  Each SFItemHistory object contains an array called `entires` which contain `SFItemHistory` entries (or subclasses, if the\n  `SFItemHistory.HistoryEntryClassMapping` class property value is set.)\n */\n\n// See default class values at bottom of this file, including `SFHistorySession.LargeItemEntryAmountThreshold`.\n\nexport class SFHistorySession extends SFItem {\n  constructor(json_obj) {\n\n    super(json_obj);\n\n    /*\n      Our .content params:\n      {\n        itemUUIDToItemHistoryMapping\n      }\n     */\n\n    if(!this.content.itemUUIDToItemHistoryMapping) {\n      this.content.itemUUIDToItemHistoryMapping = {};\n    }\n\n    // When initializing from a json_obj, we want to deserialize the item history JSON into SFItemHistory objects.\n    var uuids = Object.keys(this.content.itemUUIDToItemHistoryMapping);\n    uuids.forEach((itemUUID) => {\n      var itemHistory = this.content.itemUUIDToItemHistoryMapping[itemUUID];\n      this.content.itemUUIDToItemHistoryMapping[itemUUID] = new SFItemHistory(itemHistory);\n    });\n  }\n\n  addEntryForItem(item) {\n    var itemHistory = this.historyForItem(item);\n    var entry = itemHistory.addHistoryEntryForItem(item);\n    return entry;\n  }\n\n  historyForItem(item) {\n    var history = this.content.itemUUIDToItemHistoryMapping[item.uuid];\n    if(!history) {\n      history = this.content.itemUUIDToItemHistoryMapping[item.uuid] = new SFItemHistory();\n    }\n    return history;\n  }\n\n  clearItemHistory(item) {\n    this.historyForItem(item).clear();\n  }\n\n  clearAllHistory() {\n    this.content.itemUUIDToItemHistoryMapping = {};\n  }\n\n  optimizeHistoryForItem(item) {\n    // Clean up if there are too many revisions. Note SFHistorySession.LargeItemEntryAmountThreshold is the amount of revisions which above, call\n    // for an optimization. An optimization may not remove entries above this threshold. It will determine what it should keep and what it shouldn't.\n    // So, it is possible to have a threshold of 60 but have 600 entries, if the item history deems those worth keeping.\n    var itemHistory = this.historyForItem(item);\n    if(itemHistory.entries.length > SFHistorySession.LargeItemEntryAmountThreshold) {\n      itemHistory.optimize();\n    }\n  }\n}\n\n// See comment in `this.optimizeHistoryForItem`\nSFHistorySession.LargeItemEntryAmountThreshold = 60;\n;// See default class values at bottom of this file, including `SFItemHistory.LargeEntryDeltaThreshold`.\n\nexport class SFItemHistory {\n\n  constructor(params = {}) {\n    if(!this.entries) {\n      this.entries = [];\n    }\n\n    // Deserialize the entries into entry objects.\n    if(params.entries) {\n      for(var entryParams of params.entries) {\n        var entry = this.createEntryForItem(entryParams.item);\n        entry.setPreviousEntry(this.getLastEntry());\n        this.entries.push(entry);\n      }\n    }\n  }\n\n  createEntryForItem(item) {\n    var historyItemClass = SFItemHistory.HistoryEntryClassMapping && SFItemHistory.HistoryEntryClassMapping[item.content_type];\n    if(!historyItemClass) {\n      historyItemClass = SFItemHistoryEntry;\n    }\n    var entry = new historyItemClass(item);\n    return entry;\n  }\n\n  getLastEntry() {\n    return this.entries[this.entries.length - 1]\n  }\n\n  addHistoryEntryForItem(item) {\n    var prospectiveEntry = this.createEntryForItem(item);\n\n    var previousEntry = this.getLastEntry();\n    prospectiveEntry.setPreviousEntry(previousEntry);\n\n    // Don't add first revision if text length is 0, as this means it's a new note.\n    // Actually, nevermind. If we do this, the first character added to a new note\n    // will be displayed as \"1 characters loaded\".\n    // if(!previousRevision && prospectiveRevision.textCharDiffLength == 0) {\n    //   return;\n    // }\n\n    // Don't add if text is the same\n    if(prospectiveEntry.isSameAsEntry(previousEntry)) {\n      return;\n    }\n\n    this.entries.push(prospectiveEntry);\n    return prospectiveEntry;\n  }\n\n  clear() {\n    this.entries.length = 0;\n  }\n\n  optimize() {\n    var keepEntries = [];\n\n    let isEntrySignificant = (entry) => {\n      return entry.deltaSize() > SFItemHistory.LargeEntryDeltaThreshold;\n    }\n\n    let processEntry = (entry, index, keep) => {\n      // Entries may be processed retrospectively, meaning it can be decided to be deleted, then an upcoming processing can change that.\n      if(keep) {\n        keepEntries.push(entry);\n      } else {\n        // Remove if in keep\n        var index = keepEntries.indexOf(entry);\n        if(index !== -1) {\n          keepEntries.splice(index, 1);\n        }\n      }\n\n      if(keep && isEntrySignificant(entry) && entry.operationVector() == -1) {\n        // This is a large negative change. Hang on to the previous entry.\n        var previousEntry = this.entries[index - 1];\n        if(previousEntry) {\n          keepEntries.push(previousEntry);\n        }\n      }\n    }\n\n    this.entries.forEach((entry, index) => {\n      if(index == 0 || index == this.entries.length - 1) {\n        // Keep the first and last\n        processEntry(entry, index, true);\n      } else {\n        var significant = isEntrySignificant(entry);\n        processEntry(entry, index, significant);\n      }\n    })\n\n    this.entries = this.entries.filter((entry, index) => {\n      return keepEntries.indexOf(entry) !== -1;\n    })\n  }\n}\n\n// The amount of characters added or removed that constitute a keepable entry after optimization.\nSFItemHistory.LargeEntryDeltaThreshold = 15;\n;export class SFItemHistoryEntry {\n\n  constructor(item) {\n    // Whatever values `item` has will be persisted, so be sure that the values are picked beforehand.\n    this.item = SFItem.deepMerge({}, item);\n\n    // We'll assume a `text` content value to diff on. If it doesn't exist, no problem.\n    this.defaultContentKeyToDiffOn = \"text\";\n\n    // Default value\n    this.textCharDiffLength = 0;\n\n    if(typeof this.item.updated_at == 'string') {\n      this.item.updated_at = new Date(this.item.updated_at);\n    }\n  }\n\n  setPreviousEntry(previousEntry) {\n    this.hasPreviousEntry = previousEntry != null;\n\n    // we'll try to compute the delta based on an assumed content property of `text`, if it exists.\n    if(this.item.content[this.defaultContentKeyToDiffOn]) {\n      if(previousEntry) {\n        this.textCharDiffLength = this.item.content[this.defaultContentKeyToDiffOn].length - previousEntry.item.content[this.defaultContentKeyToDiffOn].length;\n      } else {\n        this.textCharDiffLength = this.item.content[this.defaultContentKeyToDiffOn].length;\n      }\n    }\n  }\n\n  operationVector() {\n    // We'll try to use the value of `textCharDiffLength` to help determine this, if it's set\n    if(this.textCharDiffLength != undefined) {\n      if(!this.hasPreviousEntry || this.textCharDiffLength == 0) {\n        return 0;\n      } else if(this.textCharDiffLength < 0) {\n        return -1;\n      } else {\n        return 1;\n      }\n    }\n\n    // Otherwise use a default value of 1\n    return 1;\n  }\n\n  deltaSize() {\n    // Up to the subclass to determine how large the delta was, i.e number of characters changed.\n    // But this general class won't be able to determine which property it should diff on, or even its format.\n\n    // We can return the `textCharDiffLength` if it's set, otherwise, just return 1;\n    if(this.textCharDiffLength != undefined) {\n      return Math.abs(this.textCharDiffLength);\n    }\n\n    // Otherwise return 1 here to constitute a basic positive delta.\n    // The value returned should always be positive. override `operationVector` to return the direction of the delta.\n    return 1;\n  }\n\n  isSameAsEntry(entry) {\n    if(!entry) {\n      return false;\n    }\n\n    var lhs = new SFItem(this.item);\n    var rhs = new SFItem(entry.item);\n    return lhs.isItemContentEqualWith(rhs);\n  }\n\n}\n;/* Abstract class. Instantiate an instance of either SFCryptoJS (uses cryptojs) or SFCryptoWeb (uses web crypto) */\n\nvar globalScope = typeof window !== 'undefined' ? window : (typeof global !== 'undefined' ? global : null);\n\nexport class SFAbstractCrypto {\n\n  constructor() {\n    this.DefaultPBKDF2Length = 768;\n  }\n\n  /*\n  Our WebCrypto implementation only offers PBKDf2, so any other encryption\n  and key generation functions must use CryptoJS in this abstract implementation.\n  */\n\n  generateUUIDSync() {\n    var crypto = globalScope.crypto || globalScope.msCrypto;\n    if(crypto) {\n      var buf = new Uint32Array(4);\n      crypto.getRandomValues(buf);\n      var idx = -1;\n      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n          idx++;\n          var r = (buf[idx>>3] >> ((idx%8)*4))&15;\n          var v = c == 'x' ? r : (r&0x3|0x8);\n          return v.toString(16);\n      });\n    } else {\n      var d = new Date().getTime();\n      if(globalScope.performance && typeof globalScope.performance.now === \"function\"){\n        d += performance.now(); //use high-precision timer if available\n      }\n      var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n        var r = (d + Math.random()*16)%16 | 0;\n        d = Math.floor(d/16);\n        return (c=='x' ? r : (r&0x3|0x8)).toString(16);\n      });\n      return uuid;\n    }\n  }\n\n  async generateUUID()  {\n    return this.generateUUIDSync();\n  }\n\n  async decryptText({ciphertextToAuth, contentCiphertext, encryptionKey, iv, authHash, authKey} = {}, requiresAuth) {\n    if(requiresAuth && !authHash) {\n      console.error(\"Auth hash is required.\");\n      return;\n    }\n\n    if(authHash) {\n      var localAuthHash = await this.hmac256(ciphertextToAuth, authKey);\n      if(authHash !== localAuthHash) {\n        console.error(\"Auth hash does not match, returning null.\");\n        return null;\n      }\n    }\n    \n    var keyData = CryptoJS.enc.Hex.parse(encryptionKey);\n    var ivData  = CryptoJS.enc.Hex.parse(iv || \"\");\n    var decrypted = CryptoJS.AES.decrypt(contentCiphertext, keyData, { iv: ivData,  mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });\n    return decrypted.toString(CryptoJS.enc.Utf8);\n  }\n\n  async encryptText(text, key, iv) {\n    var keyData = CryptoJS.enc.Hex.parse(key);\n    var ivData  = CryptoJS.enc.Hex.parse(iv || \"\");\n    var encrypted = CryptoJS.AES.encrypt(text, keyData, { iv: ivData,  mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });\n    return encrypted.toString();\n  }\n\n  async generateRandomKey(bits) {\n    return CryptoJS.lib.WordArray.random(bits/8).toString();\n  }\n\n  async generateItemEncryptionKey() {\n    // Generates a key that will be split in half, each being 256 bits. So total length will need to be 512.\n    let length = 512; let cost = 1;\n    var salt = await this.generateRandomKey(length);\n    var passphrase = await this.generateRandomKey(length);\n    return this.pbkdf2(passphrase, salt, cost, length);\n  }\n\n  async firstHalfOfKey(key) {\n    return key.substring(0, key.length/2);\n  }\n\n  async secondHalfOfKey(key) {\n    return key.substring(key.length/2, key.length);\n  }\n\n  async base64(text) {\n    return globalScope.btoa(encodeURIComponent(text).replace(/%([0-9A-F]{2})/g,\n      function toSolidBytes(match, p1) {\n        return String.fromCharCode('0x' + p1);\n    }));\n  }\n\n  async base64Decode(base64String) {\n    return globalScope.atob(base64String);\n  }\n\n  async sha256(text) {\n    return CryptoJS.SHA256(text).toString();\n  }\n\n  async hmac256(message, key) {\n    var keyData = CryptoJS.enc.Hex.parse(key);\n    var messageData = CryptoJS.enc.Utf8.parse(message);\n    var result = CryptoJS.HmacSHA256(messageData, keyData).toString();\n    return result;\n  }\n\n  async generateSalt(identifier, version, cost, nonce) {\n    var result = await this.sha256([identifier, \"SF\", version, cost, nonce].join(\":\"));\n    return result;\n  }\n\n  /** Generates two deterministic keys based on one input */\n  async generateSymmetricKeyPair({password, pw_salt, pw_cost} = {}) {\n    var output = await this.pbkdf2(password, pw_salt, pw_cost, this.DefaultPBKDF2Length);\n    var outputLength = output.length;\n    var splitLength = outputLength/3;\n    var firstThird = output.slice(0, splitLength);\n    var secondThird = output.slice(splitLength, splitLength * 2);\n    var thirdThird = output.slice(splitLength * 2, splitLength * 3);\n    return [firstThird, secondThird, thirdThird];\n  }\n\n  async computeEncryptionKeysForUser(password, authParams) {\n    var pw_salt;\n\n    if(authParams.version == \"003\") {\n      if(!authParams.identifier) {\n        console.error(\"authParams is missing identifier.\");\n        return;\n      }\n      // Salt is computed from identifier + pw_nonce from server\n      pw_salt = await this.generateSalt(authParams.identifier, authParams.version, authParams.pw_cost, authParams.pw_nonce);\n    } else {\n      // Salt is returned from server\n      pw_salt = authParams.pw_salt;\n    }\n\n    return this.generateSymmetricKeyPair({password: password, pw_salt: pw_salt, pw_cost: authParams.pw_cost})\n    .then((keys) => {\n      let userKeys = {pw: keys[0], mk: keys[1], ak: keys[2]};\n      return userKeys;\n     });\n   }\n\n   // Unlike computeEncryptionKeysForUser, this method always uses the latest SF Version\n  async generateInitialKeysAndAuthParamsForUser(identifier, password) {\n    let version = this.SFJS.version;\n    var pw_cost = this.SFJS.defaultPasswordGenerationCost;\n    var pw_nonce = await this.generateRandomKey(256);\n    var pw_salt = await this.generateSalt(identifier, version, pw_cost, pw_nonce);\n\n    return this.generateSymmetricKeyPair({password: password, pw_salt: pw_salt, pw_cost: pw_cost})\n    .then((keys) => {\n      let authParams = {pw_nonce: pw_nonce, pw_cost: pw_cost, identifier: identifier, version: version};\n      let userKeys = {pw: keys[0], mk: keys[1], ak: keys[2]};\n      return {keys: userKeys, authParams: authParams};\n    });\n  }\n\n}\n;export class SFCryptoJS extends SFAbstractCrypto {\n\n  async pbkdf2(password, pw_salt, pw_cost, length) {\n    var params = {\n      keySize: length/32,\n      hasher: CryptoJS.algo.SHA512,\n      iterations: pw_cost\n    }\n\n    return CryptoJS.PBKDF2(password, pw_salt, params).toString();\n  }\n\n}\n;var globalScope = typeof window !== 'undefined' ? window : (typeof global !== 'undefined' ? global : null);\n\nconst subtleCrypto = globalScope.crypto ? globalScope.crypto.subtle : null;\n\nexport class SFCryptoWeb extends SFAbstractCrypto {\n\n  /**\n  Public\n  */\n\n  async pbkdf2(password, pw_salt, pw_cost, length) {\n    var key = await this.webCryptoImportKey(password, \"PBKDF2\", [\"deriveBits\"]);\n    if(!key) {\n      console.log(\"Key is null, unable to continue\");\n      return null;\n    }\n\n    return this.webCryptoDeriveBits(key, pw_salt, pw_cost, length);\n  }\n\n  async generateRandomKey(bits) {\n    let extractable = true;\n    return subtleCrypto.generateKey({name: \"AES-CBC\", length: bits}, extractable, [\"encrypt\", \"decrypt\"]).then((keyObject) => {\n      return subtleCrypto.exportKey(\"raw\", keyObject).then(async (keyData) => {\n        var key = await this.arrayBufferToHexString(new Uint8Array(keyData));\n        return key;\n      })\n      .catch((err) => {\n        console.error(\"Error exporting key\", err);\n      });\n    })\n    .catch((err) => {\n      console.error(\"Error generating key\", err);\n    });\n  }\n\n  async generateItemEncryptionKey() {\n    // Generates a key that will be split in half, each being 256 bits. So total length will need to be 512.\n    var length = 256;\n    return Promise.all([\n      this.generateRandomKey(length),\n      this.generateRandomKey(length)\n    ]).then((values) => {\n      return values.join(\"\");\n    });\n  }\n\n  /* This is a functioning implementation of WebCrypto's encrypt, however, in basic testing, CrpytoJS performs about 30-40% faster, surprisingly. */\n\n  async encryptText(text, key, iv) {\n    // in 001, iv can be null, so we'll initialize to an empty array buffer instead\n    var ivData = iv ? await this.hexStringToArrayBuffer(iv) : new ArrayBuffer(16);\n    const alg = { name: 'AES-CBC', iv: ivData };\n\n    const keyBuffer = await this.hexStringToArrayBuffer(key);\n    var keyData = await this.webCryptoImportKey(keyBuffer, alg.name, [\"encrypt\"]);\n    var textData = await this.stringToArrayBuffer(text);\n\n    return crypto.subtle.encrypt(alg, keyData, textData).then(async (result) => {\n      let cipher = await this.arrayBufferToBase64(result);\n      return cipher;\n    })\n  }\n\n  async decryptText({ciphertextToAuth, contentCiphertext, encryptionKey, iv, authHash, authKey} = {}, requiresAuth) {\n    if(requiresAuth && !authHash) {\n      console.error(\"Auth hash is required.\");\n      return;\n    }\n\n    if(authHash) {\n      var localAuthHash = await this.hmac256(ciphertextToAuth, authKey);\n      if(authHash !== localAuthHash) {\n        console.error(`Auth hash does not match, returning null. ${authHash} != ${localAuthHash}`);\n        return null;\n      }\n    }\n\n    // in 001, iv can be null, so we'll initialize to an empty array buffer instead\n    var ivData = iv ? await this.hexStringToArrayBuffer(iv) : new ArrayBuffer(16);\n    const alg = { name: 'AES-CBC', iv: ivData };\n\n    const keyBuffer = await this.hexStringToArrayBuffer(encryptionKey);\n    var keyData = await this.webCryptoImportKey(keyBuffer, alg.name, [\"decrypt\"]);\n    var textData = await this.base64ToArrayBuffer(contentCiphertext);\n\n    return crypto.subtle.decrypt(alg, keyData, textData).then(async (result) => {\n      var decoded = await this.arrayBufferToString(result);\n      return decoded;\n    }).catch((error) => {\n      console.error(\"Error decrypting:\", error);\n    })\n  }\n\n  /**\n  Internal\n  */\n\n  async webCryptoImportKey(input, alg, actions, hash) {\n    var text = typeof input === \"string\" ? await this.stringToArrayBuffer(input) : input;\n    return subtleCrypto.importKey(\"raw\", text, { name: alg, hash: hash }, false, actions)\n    .then((key) => {\n      return key;\n    })\n    .catch((err) => {\n      console.error(err);\n      return null;\n    });\n  }\n  //\n  async webCryptoDeriveBits(key, pw_salt, pw_cost, length) {\n    var params = {\n      \"name\": \"PBKDF2\",\n      salt: await this.stringToArrayBuffer(pw_salt),\n      iterations: pw_cost,\n      hash: {name: \"SHA-512\"},\n    }\n\n    return subtleCrypto.deriveBits(params, key, length)\n    .then(async (bits) => {\n      var key = await this.arrayBufferToHexString(new Uint8Array(bits));\n      return key;\n    })\n    .catch((err) => {\n      console.error(err);\n      return null;\n    });\n  }\n\n  async stringToArrayBuffer(string) {\n    // Using FileReader for higher performance amongst larger files\n    return new Promise((resolve, reject) => {\n      var blob = new Blob([string]);\n      var f = new FileReader();\n      f.onload = function(e) {\n        resolve(e.target.result);\n      }\n      f.readAsArrayBuffer(blob);\n    })\n  }\n\n  async arrayBufferToString(arrayBuffer) {\n    // Using FileReader for higher performance amongst larger files\n    return new Promise((resolve, reject) => {\n      var blob = new Blob([arrayBuffer]);\n      var f = new FileReader();\n      f.onload = function(e) {\n        resolve(e.target.result);\n      }\n      f.readAsText(blob);\n    })\n  }\n\n  async arrayBufferToHexString(arrayBuffer) {\n    var byteArray = new Uint8Array(arrayBuffer);\n    var hexString = \"\";\n    var nextHexByte;\n\n    for (var i=0; i<byteArray.byteLength; i++) {\n      nextHexByte = byteArray[i].toString(16);\n      if(nextHexByte.length < 2) {\n        nextHexByte = \"0\" + nextHexByte;\n      }\n      hexString += nextHexByte;\n    }\n    return hexString;\n  }\n\n  async hexStringToArrayBuffer(hex) {\n    for (var bytes = [], c = 0; c < hex.length; c += 2)\n    bytes.push(parseInt(hex.substr(c, 2), 16));\n    return new Uint8Array(bytes);\n  }\n\n  async base64ToArrayBuffer(base64) {\n    var binary_string = await this.base64Decode(base64);\n    var len = binary_string.length;\n    var bytes = new Uint8Array(len);\n    for(var i = 0; i < len; i++)        {\n      bytes[i] = binary_string.charCodeAt(i);\n    }\n    return bytes.buffer;\n  }\n\n  async arrayBufferToBase64(buffer) {\n    return new Promise((resolve, reject) => {\n      var blob = new Blob([buffer],{type:'application/octet-binary'});\n      var reader = new FileReader();\n      reader.onload = function(evt){\n        var dataurl = evt.target.result;\n        resolve(dataurl.substr(dataurl.indexOf(',') + 1));\n      };\n      reader.readAsDataURL(blob);\n    })\n  }\n\n  async hmac256(message, key) {\n    var keyHexData = await this.hexStringToArrayBuffer(key);\n    var keyData = await this.webCryptoImportKey(keyHexData, \"HMAC\", [\"sign\"], {name: \"SHA-256\"});\n    var messageData = await this.stringToArrayBuffer(message);\n    return crypto.subtle.sign({name: \"HMAC\"}, keyData, messageData)\n    .then(async (signature) => {\n      var hash = await this.arrayBufferToHexString(signature);\n      return hash;\n    })\n    .catch(function(err){\n      console.error(\"Error computing hmac\");\n    });\n  }\n\n}\n;export class SFItemTransformer {\n\n  constructor(crypto) {\n    this.crypto = crypto;\n  }\n\n  async _private_encryptString(string, encryptionKey, authKey, uuid, auth_params) {\n    var fullCiphertext, contentCiphertext;\n    if(auth_params.version === \"001\") {\n      contentCiphertext = await this.crypto.encryptText(string, encryptionKey, null);\n      fullCiphertext = auth_params.version + contentCiphertext;\n    } else {\n      var iv = await this.crypto.generateRandomKey(128);\n      contentCiphertext = await this.crypto.encryptText(string, encryptionKey, iv);\n      var ciphertextToAuth = [auth_params.version, uuid, iv, contentCiphertext].join(\":\");\n      var authHash = await this.crypto.hmac256(ciphertextToAuth, authKey);\n      var authParamsString = await this.crypto.base64(JSON.stringify(auth_params));\n      fullCiphertext = [auth_params.version, authHash, uuid, iv, contentCiphertext, authParamsString].join(\":\");\n    }\n\n    return fullCiphertext;\n  }\n\n  async encryptItem(item, keys, auth_params) {\n    var params = {};\n    // encrypt item key\n    var item_key = await this.crypto.generateItemEncryptionKey();\n    if(auth_params.version === \"001\") {\n      // legacy\n      params.enc_item_key = await this.crypto.encryptText(item_key, keys.mk, null);\n    } else {\n      params.enc_item_key = await this._private_encryptString(item_key, keys.mk, keys.ak, item.uuid, auth_params);\n    }\n\n    // encrypt content\n    var ek = await this.crypto.firstHalfOfKey(item_key);\n    var ak = await this.crypto.secondHalfOfKey(item_key);\n    var ciphertext = await this._private_encryptString(JSON.stringify(item.createContentJSONFromProperties()), ek, ak, item.uuid, auth_params);\n    if(auth_params.version === \"001\") {\n      var authHash = await this.crypto.hmac256(ciphertext, ak);\n      params.auth_hash = authHash;\n    }\n\n    params.content = ciphertext;\n    return params;\n  }\n\n  encryptionComponentsFromString(string, encryptionKey, authKey) {\n    var encryptionVersion = string.substring(0, 3);\n    if(encryptionVersion === \"001\") {\n      return {\n        contentCiphertext: string.substring(3, string.length),\n        encryptionVersion: encryptionVersion,\n        ciphertextToAuth: string,\n        iv: null,\n        authHash: null,\n        encryptionKey: encryptionKey,\n        authKey: authKey\n      }\n    } else {\n      let components = string.split(\":\");\n      return {\n        encryptionVersion: components[0],\n        authHash: components[1],\n        uuid: components[2],\n        iv: components[3],\n        contentCiphertext: components[4],\n        authParams: components[5],\n        ciphertextToAuth: [components[0], components[2], components[3], components[4]].join(\":\"),\n        encryptionKey: encryptionKey,\n        authKey: authKey,\n      }\n    }\n  }\n\n  async decryptItem(item, keys) {\n\n    if(typeof item.content != \"string\") {\n      // Content is already an object, can't do anything with it.\n      return;\n    }\n\n    if(item.content.startsWith(\"000\")) {\n      // is base64 encoded\n      try {\n        item.content = JSON.parse(await this.crypto.base64Decode(item.content.substring(3, item.content.length)));\n      } catch (e) {}\n\n      return;\n    }\n\n    if(!item.enc_item_key) {\n      // This needs to be here to continue, return otherwise\n      console.log(\"Missing item encryption key, skipping decryption.\");\n      return;\n    }\n\n    // decrypt encrypted key\n    var encryptedItemKey = item.enc_item_key;\n    var requiresAuth = true;\n    if(!encryptedItemKey.startsWith(\"002\") && !encryptedItemKey.startsWith(\"003\")) {\n      // legacy encryption type, has no prefix\n      encryptedItemKey = \"001\" + encryptedItemKey;\n      requiresAuth = false;\n    }\n    var keyParams = this.encryptionComponentsFromString(encryptedItemKey, keys.mk, keys.ak);\n\n    // return if uuid in auth hash does not match item uuid. Signs of tampering.\n    if(keyParams.uuid && keyParams.uuid !== item.uuid) {\n      console.error(\"Item key params UUID does not match item UUID\");\n      if(!item.errorDecrypting) { item.errorDecryptingValueChanged = true;}\n      item.errorDecrypting = true;\n      return;\n    }\n\n    var item_key = await this.crypto.decryptText(keyParams, requiresAuth);\n\n    if(!item_key) {\n      console.log(\"Error decrypting item\", item);\n      if(!item.errorDecrypting) { item.errorDecryptingValueChanged = true;}\n      item.errorDecrypting = true;\n      return;\n    }\n\n    // decrypt content\n    var ek = await this.crypto.firstHalfOfKey(item_key);\n    var ak = await this.crypto.secondHalfOfKey(item_key);\n    var itemParams = this.encryptionComponentsFromString(item.content, ek, ak);\n\n    try {\n      item.auth_params = JSON.parse(await this.crypto.base64Decode(itemParams.authParams));\n    } catch (e) {}\n\n    // return if uuid in auth hash does not match item uuid. Signs of tampering.\n    if(itemParams.uuid && itemParams.uuid !== item.uuid) {\n      if(!item.errorDecrypting) { item.errorDecryptingValueChanged = true;}\n      item.errorDecrypting = true;\n      return;\n    }\n\n    if(!itemParams.authHash) {\n      // legacy 001\n      itemParams.authHash = item.auth_hash;\n    }\n\n    var content = await this.crypto.decryptText(itemParams, true);\n    if(!content) {\n      if(!item.errorDecrypting) { item.errorDecryptingValueChanged = true;}\n      item.errorDecrypting = true;\n    } else {\n      if(item.errorDecrypting == true) { item.errorDecryptingValueChanged = true;}\n       // Content should only be set if it was successfully decrypted, and should otherwise remain unchanged.\n      item.errorDecrypting = false;\n      item.content = content;\n    }\n  }\n\n  async decryptMultipleItems(items, keys, throws) {\n    let decrypt = async (item) => {\n      if(!item) {\n        return;\n      }\n      // 4/15/18: Adding item.content == null clause. We still want to decrypt deleted items incase\n      // they were marked as dirty but not yet synced. Not yet sure why we had this requirement.\n      if(item.deleted == true && item.content == null) {\n        return;\n      }\n\n      var isString = typeof item.content === 'string' || item.content instanceof String;\n      if(isString) {\n        try {\n          await this.decryptItem(item, keys);\n        } catch (e) {\n          if(!item.errorDecrypting) { item.errorDecryptingValueChanged = true;}\n          item.errorDecrypting = true;\n          if(throws) {\n            throw e;\n          }\n          console.error(\"Error decrypting item\", item, e);\n          return;\n        }\n      }\n    }\n\n    return Promise.all(items.map((item) => {\n      return decrypt(item);\n    }));\n\n  }\n}\n;var globalScope = typeof window !== 'undefined' ? window : (typeof global !== 'undefined' ? global : null);\n\nexport class StandardFile {\n  constructor(cryptoInstance) {\n    // This library runs in native environments as well (react native)\n    if(globalScope) {\n      // detect IE8 and above, and edge.\n      // IE and Edge do not support pbkdf2 in WebCrypto, therefore we need to use CryptoJS\n      var IEOrEdge = (typeof document !== 'undefined' && document.documentMode) || /Edge/.test(navigator.userAgent);\n\n      if(!IEOrEdge && (globalScope.crypto && globalScope.crypto.subtle)) {\n        this.crypto = new SFCryptoWeb();\n      } else {\n        this.crypto = new SFCryptoJS();\n      }\n    }\n\n    // This must be placed outside window check, as it's used in native.\n    if(cryptoInstance) {\n      this.crypto = cryptoInstance;\n    }\n\n    this.itemTransformer = new SFItemTransformer(this.crypto);\n\n    this.crypto.SFJS = {\n      version : this.version(),\n      defaultPasswordGenerationCost : this.defaultPasswordGenerationCost()\n    }\n  }\n\n  version() {\n    return \"003\";\n  }\n\n  supportsPasswordDerivationCost(cost) {\n    // some passwords are created on platforms with stronger pbkdf2 capabilities, like iOS,\n    // which CryptoJS can't handle here (WebCrypto can however).\n    // if user has high password cost and is using browser that doesn't support WebCrypto,\n    // we want to tell them that they can't login with this browser.\n    if(cost > 5000) {\n      return this.crypto instanceof SFCryptoWeb;\n    } else {\n      return true;\n    }\n  }\n\n  // Returns the versions that this library supports technically.\n  supportedVersions() {\n    return [\"001\", \"002\", \"003\"];\n  }\n\n  isVersionNewerThanLibraryVersion(version) {\n    var libraryVersion = this.version();\n    return parseInt(version) > parseInt(libraryVersion);\n  }\n\n  isProtocolVersionOutdated(version) {\n    // YYYY-MM-DD\n    let expirationDates = {\n      \"001\" : Date.parse(\"2018-01-01\"),\n      \"002\" : Date.parse(\"2020-01-01\"),\n    }\n\n    let date = expirationDates[version];\n    if(!date) {\n      // No expiration date, is active version\n      return false;\n    }\n    let expired = new Date() > date;\n    return expired;\n  }\n\n  costMinimumForVersion(version) {\n    return {\n      \"001\" : 3000,\n      \"002\" : 3000,\n      \"003\" : 110000\n    }[version];\n  }\n\n  defaultPasswordGenerationCost() {\n    return this.costMinimumForVersion(this.version());\n  }\n}\n\nif(globalScope) {\n  // window is for some reason defined in React Native, but throws an exception when you try to set to it\n  try {\n    globalScope.StandardFile = StandardFile;\n    globalScope.SFJS = new StandardFile();\n    globalScope.SFCryptoWeb = SFCryptoWeb;\n    globalScope.SFCryptoJS = SFCryptoJS;\n    globalScope.SFItemTransformer = SFItemTransformer;\n    globalScope.SFModelManager = SFModelManager;\n    globalScope.SFItem = SFItem;\n    globalScope.SFItemParams = SFItemParams;\n    globalScope.SFHttpManager = SFHttpManager;\n    globalScope.SFStorageManager = SFStorageManager;\n    globalScope.SFSyncManager = SFSyncManager;\n    globalScope.SFAuthManager = SFAuthManager;\n    globalScope.SFMigrationManager = SFMigrationManager;\n    globalScope.SFAlertManager = SFAlertManager;\n    globalScope.SFPredicate = SFPredicate;\n    globalScope.SFHistorySession = SFHistorySession;\n    globalScope.SFSessionHistoryManager = SFSessionHistoryManager\n    globalScope.SFItemHistory = SFItemHistory;\n    globalScope.SFItemHistoryEntry = SFItemHistoryEntry;\n  } catch (e) {\n    console.log(\"Exception while exporting window variables\", e);\n  }\n}\n"]}