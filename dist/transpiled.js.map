{"version":3,"sources":["lib.js"],"names":["SFModelManager","MappingSourceRemoteRetrieved","MappingSourceRemoteSaved","MappingSourceLocalSaved","MappingSourceLocalRetrieved","MappingSourceComponentRetrieved","MappingSourceDesktopInstalled","MappingSourceRemoteActionRetrieved","MappingSourceFileImport","isMappingSourceRetrieved","source","includes","itemSyncObservers","itemsPendingRemoval","items","missedReferences","length","item","callback","newItem","createItem","uuid","SFJS","crypto","generateUUIDSync","informReferencesOfUUIDChange","informModelsOfUUIDChangeForItem","console","log","deleted","content","references","setDirty","mapResponseItemsToLocalModels","addItem","markAllReferencesDirtyForItem","oldUUID","newUUID","model","potentialItemOfInterestHasChangedItsUUID","contentTypes","allItems","filter","_","content_type","dummy","contentType","errorDecrypting","itemId","find","ids","notifySyncObserversOfModels","sourceKey","mapResponseItemsToLocalModelsOmittingFields","omitFields","models","processedObjects","modelsToNotifyObserversOf","json_obj","error","Array","isArray","key","findItem","updateFromJSON","pull","isDirtyItemPendingDelete","dirty","push","removeItemLocally","index","resolveReferencesForItem","missedRefs","r","reference_uuid","ref","for_item","observer","allRelevantItems","type","validItems","deletedItems","dontNotifyObservers","itemClass","ContentTypeClassMapping","SFItem","itemResponse","dup","globalOnly","addItems","forEach","markReferencesDirty","contentObject","updateLocalRelationships","slice","reference","referencedItem","addItemAsRelationship","missedRef","id","remove","clearDirtyItems","getDirtyItems","removeAndDirtyAllRelationshipsForItem","relationship","removeRelationshipBetweenItems","dontUpdateClientDates","relevantItems","dontUpdateClientDate","map","referencedObjects","findItems","isBeingRemovedLocally","keys","authParams","protocolVersion","returnNullIfEmpty","Promise","all","itemParams","SFItemParams","paramsForExportFile","then","data","JSON","stringify","_extensions","ext","dateFormatter","appData","json","created_at","updated_at","enc_item_key","auth_hash","parsedContent","parse","deepMerge","e","Date","_client_updated_at","mapContentToLocalProperties","handleDeletedContent","contentObj","structureParams","params","dirtyCount","client_updated_at","hasRawClientUpdatedAtValue","hasRelationshipWithItem","target","value","domain","setDomainDataItem","AppDomain","getDomainDataItem","getAppDataItem","otherItem","omit","obj","left","appDataKeysToIgnoreWhenCheckingContentEquality","keysToIgnoreWhenCheckingContentEquality","right","dateToLocalizedString","date","Intl","DateTimeFormat","locale","navigator","languages","language","year","month","day","weekday","hour","minute","format","toDateString","toLocaleTimeString","saved","setAppDataItem","sort","a","b","mergeCopyArrays","objValue","srcValue","mergeWith","version","includeDeleted","additionalFields","forExportFile","__params","result","assert","doNotEncrypt","itemTransformer","encryptItem","encryptedParams","merge","createContentJSONFromProperties","base64","pick","SFAbstractCrypto","DefaultPBKDF2Length","window","msCrypto","buf","Uint32Array","getRandomValues","idx","replace","c","v","toString","d","getTime","performance","now","Math","random","floor","ciphertextToAuth","contentCiphertext","encryptionKey","iv","authHash","authKey","requiresAuth","hmac256","localAuthHash","keyData","CryptoJS","enc","Hex","ivData","decrypted","AES","decrypt","mode","CBC","padding","pad","Pkcs7","Utf8","text","encrypted","encrypt","bits","lib","WordArray","cost","generateRandomKey","salt","passphrase","pbkdf2","substring","btoa","base64String","atob","SHA256","message","messageData","HmacSHA256","identifier","nonce","sha256","join","password","pw_salt","pw_cost","output","outputLength","splitLength","firstThird","secondThird","thirdThird","generateSalt","pw_nonce","generateSymmetricKeyPair","userKeys","pw","mk","ak","defaultPasswordGenerationCost","SFCryptoJS","keySize","hasher","algo","SHA512","iterations","PBKDF2","subtleCrypto","subtle","SFCryptoWeb","webCryptoImportKey","webCryptoDeriveBits","extractable","generateKey","name","keyObject","exportKey","arrayBufferToHexString","Uint8Array","catch","err","values","input","alg","action","stringToArrayBuffer","importKey","hash","deriveBits","string","TextEncoder","encoder","encode","unescape","encodeURIComponent","ArrayBuffer","bufView","i","strLen","charCodeAt","arrayBuffer","byteArray","hexString","nextHexByte","byteLength","hex","bytes","parseInt","substr","buffer","binary","len","String","fromCharCode","SFItemTransformer","encryptText","fullCiphertext","generateItemEncryptionKey","item_key","_private_encryptString","firstHalfOfKey","ek","secondHalfOfKey","ciphertext","encryptionVersion","components","split","startsWith","base64Decode","encryptedItemKey","keyParams","encryptionComponentsFromString","errorDecryptingValueChanged","decryptText","throws","isString","decryptItem","StandardFile","cryptoInstance","document","IEOrEdge","documentMode","test","userAgent","libraryVersion","expirationDates","expired","costMinimumForVersion"],"mappings":"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","file":"transpiled.js","sourcesContent":["export class SFModelManager {\n\n  constructor() {\n    SFModelManager.MappingSourceRemoteRetrieved = \"MappingSourceRemoteRetrieved\";\n    SFModelManager.MappingSourceRemoteSaved = \"MappingSourceRemoteSaved\";\n    SFModelManager.MappingSourceLocalSaved = \"MappingSourceLocalSaved\";\n    SFModelManager.MappingSourceLocalRetrieved = \"MappingSourceLocalRetrieved\";\n    SFModelManager.MappingSourceComponentRetrieved = \"MappingSourceComponentRetrieved\";\n    SFModelManager.MappingSourceDesktopInstalled = \"MappingSourceDesktopInstalled\"; // When a component is installed by the desktop and some of its values change\n    SFModelManager.MappingSourceRemoteActionRetrieved = \"MappingSourceRemoteActionRetrieved\"; /* aciton-based Extensions like note history */\n    SFModelManager.MappingSourceFileImport = \"MappingSourceFileImport\";\n\n    SFModelManager.isMappingSourceRetrieved = (source) => {\n      return [\n        SFModelManager.MappingSourceRemoteRetrieved,\n        SFModelManager.MappingSourceComponentRetrieved,\n        SFModelManager.MappingSourceRemoteActionRetrieved\n      ].includes(source);\n    }\n\n    this.itemSyncObservers = [];\n    this.itemsPendingRemoval = [];\n    this.items = [];\n    this.missedReferences = [];\n  }\n\n  resetLocalMemory() {\n    this.items.length = 0;\n  }\n\n  get allItems() {\n    return this.items.filter(function(item){\n      return !item.dummy;\n    })\n  }\n\n  get extensions() {\n    return this._extensions.filter(function(ext){\n      return !ext.deleted;\n    })\n  }\n\n  alternateUUIDForItem(item, callback) {\n    // We need to clone this item and give it a new uuid, then delete item with old uuid from db (you can't modify uuid's in our indexeddb setup)\n    var newItem = this.createItem(item);\n    newItem.uuid = SFJS.crypto.generateUUIDSync();\n\n    // Update uuids of relationships\n    newItem.informReferencesOfUUIDChange(item.uuid, newItem.uuid);\n    this.informModelsOfUUIDChangeForItem(newItem, item.uuid, newItem.uuid);\n\n    console.log(item.uuid, \"-->\", newItem.uuid);\n\n    // Set to deleted, then run through mapping function so that observers can be notified\n    item.deleted = true;\n    item.content.references = [];\n    item.setDirty(true);\n    this.mapResponseItemsToLocalModels([item], SFModelManager.MappingSourceLocalSaved);\n\n    // add new item\n    this.addItem(newItem);\n    newItem.setDirty(true);\n    this.markAllReferencesDirtyForItem(newItem);\n    callback(newItem);\n  }\n\n  informModelsOfUUIDChangeForItem(newItem, oldUUID, newUUID) {\n    // some models that only have one-way relationships might be interested to hear that an item has changed its uuid\n    // for example, editors have a one way relationship with notes. When a note changes its UUID, it has no way to inform the editor\n    // to update its relationships\n\n    for(var model of this.items) {\n      model.potentialItemOfInterestHasChangedItsUUID(newItem, oldUUID, newUUID);\n    }\n  }\n\n  allItemsMatchingTypes(contentTypes) {\n    return this.allItems.filter(function(item){\n      return (_.includes(contentTypes, item.content_type) || _.includes(contentTypes, \"*\")) && !item.dummy;\n    })\n  }\n\n  validItemsForContentType(contentType) {\n    return this.allItems.filter((item) => {\n      return item.content_type == contentType && !item.errorDecrypting;\n    });\n  }\n\n  findItem(itemId) {\n    return _.find(this.items, {uuid: itemId});\n  }\n\n  findItems(ids) {\n    return this.items.filter((item) => {\n      return ids.includes(item.uuid);\n    })\n  }\n\n  didSyncModelsOffline(items) {\n    this.notifySyncObserversOfModels(items, SFModelManager.MappingSourceLocalSaved);\n  }\n\n  mapResponseItemsToLocalModels(items, source, sourceKey) {\n    return this.mapResponseItemsToLocalModelsOmittingFields(items, null, source, sourceKey);\n  }\n\n  mapResponseItemsToLocalModelsOmittingFields(items, omitFields, source, sourceKey) {\n    var models = [], processedObjects = [], modelsToNotifyObserversOf = [];\n\n    // first loop should add and process items\n    for (var json_obj of items) {\n      if((!json_obj.content_type || !json_obj.content) && !json_obj.deleted && !json_obj.errorDecrypting) {\n        // An item that is not deleted should never have empty content\n        console.error(\"Server response item is corrupt:\", json_obj);\n        continue;\n      }\n\n      // Lodash's _.omit, which was previously used, seems to cause unexpected behavior\n      // when json_obj is an ES6 item class. So we instead manually omit each key.\n      if(Array.isArray(omitFields)) {\n        for(var key of omitFields) {\n          delete json_obj[key];\n        }\n      }\n\n      var item = this.findItem(json_obj.uuid);\n\n      if(item) {\n        item.updateFromJSON(json_obj);\n        // If an item goes through mapping, it can no longer be a dummy.\n        item.dummy = false;\n      }\n\n      if(this.itemsPendingRemoval.includes(json_obj.uuid)) {\n        _.pull(this.itemsPendingRemoval, json_obj.uuid);\n        continue;\n      }\n\n      let contentType = json_obj[\"content_type\"] || (item && item.content_type);\n      var isDirtyItemPendingDelete = false;\n      if(json_obj.deleted == true) {\n        if(json_obj.dirty) {\n          // Item was marked as deleted but not yet synced\n          // We need to create this item as usual, but just not add it to individual arrays\n          // i.e add to this.items but not this.notes (so that it can be retrieved with getDirtyItems)\n          isDirtyItemPendingDelete = true;\n        } else {\n          if(item) {\n            modelsToNotifyObserversOf.push(item);\n            this.removeItemLocally(item);\n          }\n          continue;\n        }\n      }\n\n      if(!item) {\n        item = this.createItem(json_obj, true);\n      }\n\n      this.addItem(item, isDirtyItemPendingDelete);\n\n      // Observers do not need to handle items that errored while decrypting.\n      if(!item.errorDecrypting) {\n        modelsToNotifyObserversOf.push(item);\n      }\n\n      models.push(item);\n      processedObjects.push(json_obj);\n    }\n\n    // // second loop should process references\n    for (var index in processedObjects) {\n      var json_obj = processedObjects[index];\n      if(json_obj.content) {\n        this.resolveReferencesForItem(models[index]);\n      }\n      var missedRefs = this.missedReferences.filter((r) => {return r.reference_uuid == json_obj.uuid});\n      for(var ref of missedRefs) {\n        this.resolveReferencesForItem(ref.for_item);\n      }\n      // remove handled refs\n      this.missedReferences = this.missedReferences.filter((r) => {return r.reference_uuid != json_obj.uuid});\n    }\n\n    this.notifySyncObserversOfModels(modelsToNotifyObserversOf, source, sourceKey);\n\n    return models;\n  }\n\n  /* Note that this function is public, and can also be called manually (desktopManager uses it) */\n  notifySyncObserversOfModels(models, source, sourceKey) {\n    for(var observer of this.itemSyncObservers) {\n      var allRelevantItems = observer.type == \"*\" ? models : models.filter(function(item){return item.content_type == observer.type});\n      var validItems = [], deletedItems = [];\n      for(var item of allRelevantItems) {\n        if(item.deleted) {\n          deletedItems.push(item);\n        } else {\n          validItems.push(item);\n        }\n      }\n\n      if(allRelevantItems.length > 0) {\n        observer.callback(allRelevantItems, validItems, deletedItems, source, sourceKey);\n      }\n    }\n  }\n\n  createItem(json_obj, dontNotifyObservers) {\n    var itemClass = SFModelManager.ContentTypeClassMapping && SFModelManager.ContentTypeClassMapping[json_obj.content_type];\n    if(!itemClass) {\n      itemClass = SFItem;\n    }\n    var item = new itemClass(json_obj);\n\n    // Some observers would be interested to know when an an item is locally created\n    // If we don't send this out, these observers would have to wait until MappingSourceRemoteSaved\n    // to hear about it, but sometimes, RemoveSaved is explicitly ignored by the observer to avoid\n    // recursive callbacks. See componentManager's syncObserver callback.\n    // dontNotifyObservers is currently only set true by modelManagers mapResponseItemsToLocalModels\n    if(!dontNotifyObservers) {\n      this.notifySyncObserversOfModels([item], SFModelManager.MappingSourceLocalSaved);\n    }\n\n    return item;\n  }\n\n  /*\n    Be sure itemResponse is a generic Javascript object, and not an Item.\n    An Item needs to collapse its properties into its content object before it can be duplicated.\n    Note: the reason we need this function is specificallty for the call to resolveReferencesForItem.\n    This method creates but does not add the item to the global inventory. It's used by syncManager\n    to check if this prospective duplicate item is identical to another item, including the references.\n   */\n  createDuplicateItem(itemResponse) {\n    var dup = this.createItem(itemResponse, true);\n    this.resolveReferencesForItem(dup);\n    return dup;\n  }\n\n  addItem(item, globalOnly = false) {\n    this.addItems([item], globalOnly);\n  }\n\n  addItems(items, globalOnly = false) {\n    items.forEach((item) => {\n      if(!_.find(this.items, {uuid: item.uuid})) {\n        this.items.push(item);\n      }\n    });\n  }\n\n  resolveReferencesForItem(item, markReferencesDirty = false) {\n\n    // console.log(\"resolveReferencesForItem\", item, \"references\", item.contentObject.references);\n\n    var contentObject = item.contentObject;\n\n    // If another client removes an item's references, this client won't pick up the removal unless\n    // we remove everything not present in the current list of references\n    item.updateLocalRelationships();\n\n    if(!contentObject.references) {\n      return;\n    }\n\n    var references = contentObject.references.slice(); // make copy, references will be modified in array\n\n    for(var reference of references) {\n      var referencedItem = this.findItem(reference.uuid);\n      if(referencedItem) {\n        item.addItemAsRelationship(referencedItem);\n        if(markReferencesDirty) {\n          referencedItem.setDirty(true);\n        }\n      } else {\n        // Allows mapper to check when missing reference makes it through the loop,\n        // and then runs resolveReferencesForItem again for the original item.\n        let missedRef = {reference_uuid: reference.uuid, for_item: item};\n        if(!_.find(this.missedReferences, missedRef)) {\n          this.missedReferences.push(missedRef);\n        }\n      }\n    }\n  }\n\n  /* Notifies observers when an item has been synced or mapped from a remote response */\n  addItemSyncObserver(id, type, callback) {\n    this.itemSyncObservers.push({id: id, type: type, callback: callback});\n  }\n\n  removeItemSyncObserver(id) {\n    _.remove(this.itemSyncObservers, _.find(this.itemSyncObservers, {id: id}));\n  }\n\n  getDirtyItems() {\n    return this.items.filter((item) => {\n      // An item that has an error decrypting can be synced only if it is being deleted.\n      // Otherwise, we don't want to send corrupt content up to the server.\n      return item.dirty == true && !item.dummy && (!item.errorDecrypting || item.deleted);\n    })\n  }\n\n  clearDirtyItems(items) {\n    for(var item of items) {\n      item.setDirty(false);\n    }\n  }\n\n  clearAllDirtyItems() {\n    this.clearDirtyItems(this.getDirtyItems());\n  }\n\n  setItemToBeDeleted(item) {\n    item.deleted = true;\n    if(!item.dummy) {\n      item.setDirty(true);\n    }\n\n    this.removeAndDirtyAllRelationshipsForItem(item);\n  }\n\n  removeAndDirtyAllRelationshipsForItem(item) {\n    for(var reference of item.content.references) {\n      var relationship = this.findItem(reference.uuid);\n      if(relationship) {\n        this.removeRelationshipBetweenItems(relationship, item);\n      }\n    }\n  }\n\n  /* Used when changing encryption key */\n  setAllItemsDirty(dontUpdateClientDates = true) {\n    var relevantItems = this.allItems;\n\n    for(var item of relevantItems) {\n      item.setDirty(true, dontUpdateClientDates);\n    }\n  }\n\n  markAllReferencesDirtyForItem(item, dontUpdateClientDate) {\n    var ids = item.content.references.map((r) => {return r.uuid});\n    var referencedObjects = this.findItems(ids);\n    referencedObjects.forEach(function(reference){\n      reference.setDirty(true, dontUpdateClientDate);\n    })\n  }\n\n  removeItemLocally(item, callback) {\n    _.remove(this.items, {uuid: item.uuid});\n\n    item.isBeingRemovedLocally();\n\n    this.itemsPendingRemoval.push(item.uuid);\n  }\n\n\n  /*\n  Archives\n  */\n\n  async getAllItemsJSONData(keys, authParams, protocolVersion, returnNullIfEmpty) {\n    return Promise.all(this.allItems.map((item) => {\n      var itemParams = new SFItemParams(item, keys, protocolVersion);\n      return itemParams.paramsForExportFile();\n    })).then((items) => {\n      if(returnNullIfEmpty && items.length == 0) {\n        return null;\n      }\n\n      var data = {items: items}\n\n      if(keys) {\n        // auth params are only needed when encrypted with a standard file key\n        data[\"auth_params\"] = authParams;\n      }\n\n      return JSON.stringify(data, null, 2 /* pretty print */);\n    })\n\n  }\n}\n;var dateFormatter;\n\nexport class SFItem {\n\n  constructor(json_obj = {}) {\n    this.appData = {};\n    this.content = {};\n    this.updateFromJSON(json_obj);\n\n    if(!this.uuid) {\n      this.uuid = SFJS.crypto.generateUUIDSync();\n    }\n\n    if(!this.content.references) {\n      this.content.references = [];\n    }\n  }\n\n  static sortItemsByDate(items) {\n    items.sort(function(a,b){\n      return new Date(b.created_at) - new Date(a.created_at);\n    });\n  }\n\n  get contentObject() {\n    if(!this.content) {\n      this.content = {};\n      return this.content;\n    }\n\n    if(this.content !== null && typeof this.content === 'object') {\n      // this is the case when mapping localStorage content, in which case the content is already parsed\n      return this.content;\n    }\n\n    try {\n      let content = JSON.parse(this.content);\n      this.content = content;\n      return this.content;\n    } catch (e) {\n      console.log(\"Error parsing json\", e, this);\n      this.content = {};\n      return this.content;\n    }\n  }\n\n  static deepMerge(a, b) {\n    // By default _.merge will not merge a full array with an empty one.\n    // We want to replace arrays wholesale\n    function mergeCopyArrays(objValue, srcValue) {\n      if (_.isArray(objValue)) {\n        return srcValue;\n      }\n    }\n    _.mergeWith(a, b, mergeCopyArrays);\n  }\n\n  updateFromJSON(json) {\n    // Manually merge top level data instead of wholesale merge\n    this.created_at = json.created_at;\n    this.updated_at = json.updated_at;\n    this.content_type = json.content_type;\n    this.deleted = json.deleted;\n    this.uuid = json.uuid;\n    this.enc_item_key = json.enc_item_key;\n    this.auth_hash = json.auth_hash;\n\n    // this.content = json.content will copy it by reference rather than value. So we need to do a deep merge after.\n    // json.content can still be a string here. We copy it to this.content, then do a deep merge to transfer over all values.\n\n    try {\n      let parsedContent = typeof json.content === 'string' ? JSON.parse(json.content) : json.content;\n      SFItem.deepMerge(this.contentObject, parsedContent);\n    } catch (e) {\n      console.log(\"Error while updating item from json\", e);\n    }\n\n    if(this.created_at) {\n      this.created_at = new Date(this.created_at);\n      this.updated_at = new Date(this.updated_at);\n    } else {\n      this.created_at = new Date();\n      this.updated_at = new Date();\n    }\n\n    // Allows the getter to be re-invoked\n    this._client_updated_at = null;\n\n    if(json.content) {\n      this.mapContentToLocalProperties(this.contentObject);\n    } else if(json.deleted == true) {\n      this.handleDeletedContent();\n    }\n  }\n\n  mapContentToLocalProperties(contentObj) {\n    if(contentObj.appData) {\n      this.appData = contentObj.appData;\n    }\n    if(!this.appData) { this.appData = {}; }\n  }\n\n  createContentJSONFromProperties() {\n    return this.structureParams();\n  }\n\n  structureParams() {\n    var params = this.contentObject;\n    params.appData = this.appData;\n    return params;\n  }\n\n  /* Allows the item to handle the case where the item is deleted and the content is null */\n  handleDeletedContent() {\n    // Subclasses can override\n  }\n\n  setDirty(dirty, dontUpdateClientDate) {\n    this.dirty = dirty;\n\n    // Allows the syncManager to check if an item has been marked dirty after a sync has been started\n    // This prevents it from clearing it as a dirty item after sync completion, if someone else has marked it dirty\n    // again after an ongoing sync.\n    if(!this.dirtyCount) { this.dirtyCount = 0; }\n    if(dirty) {\n      this.dirtyCount++;\n    } else {\n      this.dirtyCount = 0;\n    }\n\n    if(dirty && !dontUpdateClientDate) {\n      // Set the client modified date to now if marking the item as dirty\n      this.client_updated_at = new Date();\n    } else if(!this.hasRawClientUpdatedAtValue()) {\n      // copy updated_at\n      this.client_updated_at = new Date(this.updated_at);\n    }\n  }\n\n  updateLocalRelationships() {\n    // optional override\n  }\n\n  addItemAsRelationship(item) {\n    if(this.hasRelationshipWithItem(item)) {\n      return;\n    }\n\n    var references = this.content.references || [];\n    references.push({\n      uuid: item.uuid,\n      content_type: item.content_type\n    })\n    this.content.references = references;\n  }\n\n  removeItemAsRelationship(item) {\n    var references = this.content.references || [];\n    references = references.filter((r) => {return r.uuid != item.uuid});\n    this.content.references = references;\n  }\n\n  hasRelationshipWithItem(item) {\n    let target = this.content.references.find((r) => {\n      return r.uuid == item.uuid;\n    });\n    return target != null;\n  }\n\n  isBeingRemovedLocally() {\n\n  }\n\n  informReferencesOfUUIDChange(oldUUID, newUUID) {\n    // optional override\n  }\n\n  potentialItemOfInterestHasChangedItsUUID(newItem, oldUUID, newUUID) {\n    // optional override\n    for(var reference of this.content.references) {\n      if(reference.uuid == oldUUID) {\n        reference.uuid = newUUID;\n      }\n    }\n  }\n\n  doNotEncrypt() {\n    return false;\n  }\n\n  /*\n  App Data\n  */\n\n  setDomainDataItem(key, value, domain) {\n    if(!domain) {\n      console.error(\"SFItem.AppDomain needs to be set.\");\n      return;\n    }\n    var data = this.appData[domain];\n    if(!data) {\n      data = {}\n    }\n    data[key] = value;\n    this.appData[domain] = data;\n  }\n\n  getDomainDataItem(key, domain) {\n    if(!domain) {\n      console.error(\"SFItem.AppDomain needs to be set.\");\n      return;\n    }\n    var data = this.appData[domain];\n    if(data) {\n      return data[key];\n    } else {\n      return null;\n    }\n  }\n\n  setAppDataItem(key, value) {\n    this.setDomainDataItem(key, value, SFItem.AppDomain);\n  }\n\n  getAppDataItem(key) {\n    return this.getDomainDataItem(key, SFItem.AppDomain);\n  }\n\n  get pinned() {\n    return this.getAppDataItem(\"pinned\");\n  }\n\n  get archived() {\n    return this.getAppDataItem(\"archived\");\n  }\n\n  get locked() {\n    return this.getAppDataItem(\"locked\");\n  }\n\n  hasRawClientUpdatedAtValue() {\n    return this.getAppDataItem(\"client_updated_at\") != null;\n  }\n\n  get client_updated_at() {\n    if(!this._client_updated_at) {\n      var saved = this.getAppDataItem(\"client_updated_at\");\n      if(saved) {\n        this._client_updated_at = new Date(saved);\n      } else {\n        this._client_updated_at = new Date(this.updated_at);\n      }\n    }\n    return this._client_updated_at;\n  }\n\n  set client_updated_at(date) {\n    this._client_updated_at = date;\n\n    this.setAppDataItem(\"client_updated_at\", date);\n  }\n\n  /*\n    During sync conflicts, when determing whether to create a duplicate for an item, we can omit keys that have no\n    meaningful weight and can be ignored. For example, if one component has active = true and another component has active = false,\n    it would be silly to duplicate them, so instead we ignore this.\n   */\n  keysToIgnoreWhenCheckingContentEquality() {\n    return [];\n  }\n\n  // Same as above, but keys inside appData[Item.AppDomain]\n  appDataKeysToIgnoreWhenCheckingContentEquality() {\n    return [\"client_updated_at\"];\n  }\n\n  isItemContentEqualWith(otherItem) {\n    let omit = (obj, keys) => {\n      if(!obj) { return obj; }\n      for(var key of keys) {\n        delete obj[key];\n      }\n      return obj;\n    }\n\n    var left = this.structureParams();\n    left.appData[SFItem.AppDomain] = omit(left.appData[SFItem.AppDomain], this.appDataKeysToIgnoreWhenCheckingContentEquality());\n    left = omit(left, this.keysToIgnoreWhenCheckingContentEquality());\n\n    var right = otherItem.structureParams();\n    right.appData[SFItem.AppDomain] = omit(right.appData[SFItem.AppDomain], otherItem.appDataKeysToIgnoreWhenCheckingContentEquality());\n    right = omit(right, otherItem.keysToIgnoreWhenCheckingContentEquality());\n\n    return JSON.stringify(left) === JSON.stringify(right);\n  }\n\n  /*\n  Dates\n  */\n\n  createdAtString() {\n    return this.dateToLocalizedString(this.created_at);\n  }\n\n  updatedAtString() {\n    return this.dateToLocalizedString(this.client_updated_at);\n  }\n\n  dateToLocalizedString(date) {\n    if (typeof Intl !== 'undefined' && Intl.DateTimeFormat) {\n      if (!dateFormatter) {\n        var locale = (navigator.languages && navigator.languages.length) ? navigator.languages[0] : navigator.language;\n        dateFormatter = new Intl.DateTimeFormat(locale, {\n          year: 'numeric',\n          month: 'short',\n          day: '2-digit',\n          weekday: 'long',\n          hour: '2-digit',\n          minute: '2-digit',\n        });\n      }\n      return dateFormatter.format(date);\n    } else {\n      // IE < 11, Safari <= 9.0.\n      // In English, this generates the string most similar to\n      // the toLocaleDateString() result above.\n      return date.toDateString() + ' ' + date.toLocaleTimeString();\n    }\n  }\n\n}\n;export class SFItemParams {\n\n  constructor(item, keys, version) {\n    this.item = item;\n    this.keys = keys;\n    this.version = version || SFJS.version();\n  }\n\n  async paramsForExportFile(includeDeleted) {\n    this.additionalFields = [\"updated_at\"];\n    this.forExportFile = true;\n    if(includeDeleted) {\n      return this.__params();\n    } else {\n      var result = await this.__params();\n      return _.omit(result, [\"deleted\"]);\n    }\n  }\n\n  async paramsForExtension() {\n    return this.paramsForExportFile();\n  }\n\n  async paramsForLocalStorage() {\n    this.additionalFields = [\"updated_at\", \"dirty\", \"errorDecrypting\"];\n    this.forExportFile = true;\n    return this.__params();\n  }\n\n  async paramsForSync() {\n    return this.__params();\n  }\n\n  async __params() {\n\n    console.assert(!this.item.dummy, \"Item is dummy, should not have gotten here.\", this.item.dummy)\n\n    var params = {uuid: this.item.uuid, content_type: this.item.content_type, deleted: this.item.deleted, created_at: this.item.created_at};\n    if(!this.item.errorDecrypting) {\n      // Items should always be encrypted for export files. Only respect item.doNotEncrypt for remote sync params.\n      var doNotEncrypt = this.item.doNotEncrypt() && !this.forExportFile;\n      if(this.keys && !doNotEncrypt) {\n        var encryptedParams = await SFJS.itemTransformer.encryptItem(this.item, this.keys, this.version);\n        _.merge(params, encryptedParams);\n\n        if(this.version !== \"001\") {\n          params.auth_hash = null;\n        }\n      }\n      else {\n        params.content = this.forExportFile ? this.item.createContentJSONFromProperties() : \"000\" + await SFJS.crypto.base64(JSON.stringify(this.item.createContentJSONFromProperties()));\n        if(!this.forExportFile) {\n          params.enc_item_key = null;\n          params.auth_hash = null;\n        }\n      }\n    } else {\n      // Error decrypting, keep \"content\" and related fields as is (and do not try to encrypt, otherwise that would be undefined behavior)\n      params.content = this.item.content;\n      params.enc_item_key = this.item.enc_item_key;\n      params.auth_hash = this.item.auth_hash;\n    }\n\n    if(this.additionalFields) {\n      _.merge(params, _.pick(this.item, this.additionalFields));\n    }\n\n    return params;\n  }\n\n\n}\n;/* Abstract class. Instantiate an instance of either SFCryptoJS (uses cryptojs) or SFCryptoWeb (uses web crypto) */\n\nexport class SFAbstractCrypto {\n\n  constructor() {\n    this.DefaultPBKDF2Length = 768;\n  }\n\n  /*\n  Our WebCrypto implementation only offers PBKDf2, so any other encryption\n  and key generation functions must use CryptoJS in this abstract implementation.\n  */\n\n  generateUUIDSync() {\n    var crypto = window.crypto || window.msCrypto;\n    if(crypto) {\n      var buf = new Uint32Array(4);\n      crypto.getRandomValues(buf);\n      var idx = -1;\n      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n          idx++;\n          var r = (buf[idx>>3] >> ((idx%8)*4))&15;\n          var v = c == 'x' ? r : (r&0x3|0x8);\n          return v.toString(16);\n      });\n    } else {\n      var d = new Date().getTime();\n      if(window.performance && typeof window.performance.now === \"function\"){\n        d += performance.now(); //use high-precision timer if available\n      }\n      var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n        var r = (d + Math.random()*16)%16 | 0;\n        d = Math.floor(d/16);\n        return (c=='x' ? r : (r&0x3|0x8)).toString(16);\n      });\n      return uuid;\n    }\n  }\n\n  async decryptText({ciphertextToAuth, contentCiphertext, encryptionKey, iv, authHash, authKey} = {}, requiresAuth) {\n    if(requiresAuth && !authHash) {\n      console.error(\"Auth hash is required.\");\n      return;\n    }\n\n    if(authHash) {\n      var localAuthHash = await this.hmac256(ciphertextToAuth, authKey);\n      if(authHash !== localAuthHash) {\n        console.error(\"Auth hash does not match, returning null.\");\n        return null;\n      }\n    }\n    var keyData = CryptoJS.enc.Hex.parse(encryptionKey);\n    var ivData  = CryptoJS.enc.Hex.parse(iv || \"\");\n    var decrypted = CryptoJS.AES.decrypt(contentCiphertext, keyData, { iv: ivData,  mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });\n    return decrypted.toString(CryptoJS.enc.Utf8);\n  }\n\n  async encryptText(text, key, iv) {\n    var keyData = CryptoJS.enc.Hex.parse(key);\n    var ivData  = CryptoJS.enc.Hex.parse(iv || \"\");\n    var encrypted = CryptoJS.AES.encrypt(text, keyData, { iv: ivData,  mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });\n    return encrypted.toString();\n  }\n\n  async generateRandomKey(bits) {\n    return CryptoJS.lib.WordArray.random(bits/8).toString();\n  }\n\n  async generateItemEncryptionKey() {\n    // Generates a key that will be split in half, each being 256 bits. So total length will need to be 512.\n    let length = 512; let cost = 1;\n    var salt = await this.generateRandomKey(length);\n    var passphrase = await this.generateRandomKey(length);\n    return this.pbkdf2(passphrase, salt, cost, length);\n  }\n\n  async firstHalfOfKey(key) {\n    return key.substring(0, key.length/2);\n  }\n\n  async secondHalfOfKey(key) {\n    return key.substring(key.length/2, key.length);\n  }\n\n  async base64(text) {\n    return window.btoa(text);\n  }\n\n  async base64Decode(base64String) {\n    return window.atob(base64String);\n  }\n\n  async sha256(text) {\n    return CryptoJS.SHA256(text).toString();\n  }\n\n  async hmac256(message, key) {\n    var keyData = CryptoJS.enc.Hex.parse(key);\n    var messageData = CryptoJS.enc.Utf8.parse(message);\n    var result = CryptoJS.HmacSHA256(messageData, keyData).toString();\n    return result;\n  }\n\n  async generateSalt(identifier, version, cost, nonce) {\n    var result = await this.sha256([identifier, \"SF\", version, cost, nonce].join(\":\"));\n    return result;\n  }\n\n  /** Generates two deterministic keys based on one input */\n  async generateSymmetricKeyPair({password, pw_salt, pw_cost} = {}) {\n    var output = await this.pbkdf2(password, pw_salt, pw_cost, this.DefaultPBKDF2Length);\n    var outputLength = output.length;\n    var splitLength = outputLength/3;\n    var firstThird = output.slice(0, splitLength);\n    var secondThird = output.slice(splitLength, splitLength * 2);\n    var thirdThird = output.slice(splitLength * 2, splitLength * 3);\n    return [firstThird, secondThird, thirdThird];\n  }\n\n  async computeEncryptionKeysForUser(password, authParams) {\n    var pw_salt;\n\n    if(authParams.version == \"003\") {\n      if(!authParams.identifier) {\n        console.error(\"authParams is missing identifier.\");\n        return;\n      }\n      // Salt is computed from identifier + pw_nonce from server\n      pw_salt = await this.generateSalt(authParams.identifier, authParams.version, authParams.pw_cost, authParams.pw_nonce);\n    } else {\n      // Salt is returned from server\n      pw_salt = authParams.pw_salt;\n    }\n\n    return this.generateSymmetricKeyPair({password: password, pw_salt: pw_salt, pw_cost: authParams.pw_cost})\n    .then((keys) => {\n      let userKeys = {pw: keys[0], mk: keys[1], ak: keys[2]};\n      return userKeys;\n     });\n   }\n\n   // Unlike computeEncryptionKeysForUser, this method always uses the latest SF Version\n  async generateInitialKeysAndAuthParamsForUser(identifier, password) {\n    let version = this.SFJS.version;\n    var pw_cost = this.SFJS.defaultPasswordGenerationCost;\n    var pw_nonce = await this.generateRandomKey(256);\n    var pw_salt = await this.generateSalt(identifier, version, pw_cost, pw_nonce);\n\n    return this.generateSymmetricKeyPair({password: password, pw_salt: pw_salt, pw_cost: pw_cost})\n    .then((keys) => {\n      let authParams = {pw_nonce: pw_nonce, pw_cost: pw_cost, identifier: identifier, version: version};\n      let userKeys = {pw: keys[0], mk: keys[1], ak: keys[2]};\n      return {keys: userKeys, authParams: authParams};\n    });\n  }\n\n}\n;export class SFCryptoJS extends SFAbstractCrypto {\n\n  async pbkdf2(password, pw_salt, pw_cost, length) {\n    var params = {\n      keySize: length/32,\n      hasher: CryptoJS.algo.SHA512,\n      iterations: pw_cost\n    }\n\n    return CryptoJS.PBKDF2(password, pw_salt, params).toString();\n  }\n\n}\n;var subtleCrypto = window.crypto ? window.crypto.subtle : null;\n\nexport class SFCryptoWeb extends SFAbstractCrypto {\n\n  /**\n  Public\n  */\n\n  async pbkdf2(password, pw_salt, pw_cost, length) {\n    var key = await this.webCryptoImportKey(password, \"PBKDF2\", \"deriveBits\");\n    if(!key) {\n      console.log(\"Key is null, unable to continue\");\n      return null;\n    }\n\n    return this.webCryptoDeriveBits(key, pw_salt, pw_cost, length);\n  }\n\n  async generateRandomKey(bits) {\n    let extractable = true;\n    return subtleCrypto.generateKey({name: \"AES-CBC\", length: bits}, extractable, [\"encrypt\", \"decrypt\"]).then((keyObject) => {\n      return subtleCrypto.exportKey(\"raw\", keyObject).then((keyData) => {\n        var key = this.arrayBufferToHexString(new Uint8Array(keyData));\n        return key;\n      })\n      .catch((err) => {\n        console.error(\"Error exporting key\", err);\n      });\n    })\n    .catch((err) => {\n      console.error(\"Error generating key\", err);\n    });\n  }\n\n  async generateItemEncryptionKey() {\n    // Generates a key that will be split in half, each being 256 bits. So total length will need to be 512.\n    var length = 256;\n    return Promise.all([\n      this.generateRandomKey(length),\n      this.generateRandomKey(length)\n    ]).then((values) => {\n      return values.join(\"\");\n    });\n  }\n\n  /* This is a functioning implementation of WebCrypto's encrypt, however, in basic testing, CrpytoJS performs about 30-40% faster, surprisingly. */\n  /*\n  async encryptText(text, key, iv) {\n    var ivData  = this.hexStringToArrayBuffer(iv);\n    const alg = { name: 'AES-CBC', iv: ivData };\n\n    const keyBuffer = this.hexStringToArrayBuffer(key);\n    var keyData = await this.webCryptoImportKey(keyBuffer, alg.name, \"encrypt\");\n\n    var textData = this.stringToArrayBuffer(text);\n\n    return crypto.subtle.encrypt(alg, keyData, textData).then((result) => {\n      let cipher = this.arrayBufferToBase64(result);\n      return cipher;\n    })\n  }\n  */\n\n  /**\n  Internal\n  */\n\n  async webCryptoImportKey(input, alg, action) {\n    var text = typeof input === \"string\" ? this.stringToArrayBuffer(input) : input;\n    return subtleCrypto.importKey(\"raw\", text, { name: alg }, false, [action])\n    .then((key) => {\n      return key;\n    })\n    .catch((err) => {\n      console.error(err);\n      return null;\n    });\n  }\n\n  async webCryptoDeriveBits(key, pw_salt, pw_cost, length) {\n    var params = {\n      \"name\": \"PBKDF2\",\n      salt: this.stringToArrayBuffer(pw_salt),\n      iterations: pw_cost,\n      hash: {name: \"SHA-512\"},\n    }\n\n    return subtleCrypto.deriveBits(params, key, length)\n    .then((bits) => {\n      var key = this.arrayBufferToHexString(new Uint8Array(bits));\n      return key;\n    })\n    .catch((err) => {\n      console.error(err);\n      return null;\n    });\n  }\n\n  stringToArrayBuffer(string) {\n    // not available on Edge/IE\n\n    if(window.TextEncoder) {\n      var encoder = new TextEncoder(\"utf-8\");\n      var result = encoder.encode(string);\n      return result;\n    } else {\n      string = unescape(encodeURIComponent(string));\n      var buf = new ArrayBuffer(string.length);\n      var bufView = new Uint8Array(buf);\n      for (var i=0, strLen=string.length; i<strLen; i++) {\n        bufView[i] = string.charCodeAt(i);\n      }\n      return buf;\n    }\n  }\n\n  arrayBufferToHexString(arrayBuffer) {\n    var byteArray = new Uint8Array(arrayBuffer);\n    var hexString = \"\";\n    var nextHexByte;\n\n    for (var i=0; i<byteArray.byteLength; i++) {\n      nextHexByte = byteArray[i].toString(16);\n      if(nextHexByte.length < 2) {\n        nextHexByte = \"0\" + nextHexByte;\n      }\n      hexString += nextHexByte;\n    }\n    return hexString;\n  }\n\n  hexStringToArrayBuffer(hex) {\n    for (var bytes = [], c = 0; c < hex.length; c += 2)\n    bytes.push(parseInt(hex.substr(c, 2), 16));\n    return new Uint8Array(bytes);\n  }\n\n  arrayBufferToBase64( buffer ) {\n    var binary = '';\n    var bytes = new Uint8Array( buffer );\n    var len = bytes.byteLength;\n    for (var i = 0; i < len; i++) {\n        binary += String.fromCharCode( bytes[ i ] );\n    }\n    return window.btoa( binary );\n  }\n\n}\n;export class SFItemTransformer {\n\n  constructor(crypto) {\n    this.crypto = crypto;\n  }\n\n  async _private_encryptString(string, encryptionKey, authKey, uuid, version) {\n    var fullCiphertext, contentCiphertext;\n    if(version === \"001\") {\n      contentCiphertext = await this.crypto.encryptText(string, encryptionKey, null);\n      fullCiphertext = version + contentCiphertext;\n    } else {\n      var iv = await this.crypto.generateRandomKey(128);\n      contentCiphertext = await this.crypto.encryptText(string, encryptionKey, iv);\n      var ciphertextToAuth = [version, uuid, iv, contentCiphertext].join(\":\");\n      var authHash = await this.crypto.hmac256(ciphertextToAuth, authKey);\n      fullCiphertext = [version, authHash, uuid, iv, contentCiphertext].join(\":\");\n    }\n\n    return fullCiphertext;\n  }\n\n  async encryptItem(item, keys, version = \"003\") {\n    var params = {};\n    // encrypt item key\n    var item_key = await this.crypto.generateItemEncryptionKey();\n    if(version === \"001\") {\n      // legacy\n      params.enc_item_key = await this.crypto.encryptText(item_key, keys.mk, null);\n    } else {\n      params.enc_item_key = await this._private_encryptString(item_key, keys.mk, keys.ak, item.uuid, version);\n    }\n\n    // encrypt content\n    var ek = await this.crypto.firstHalfOfKey(item_key);\n    var ak = await this.crypto.secondHalfOfKey(item_key);\n    var ciphertext = await this._private_encryptString(JSON.stringify(item.createContentJSONFromProperties()), ek, ak, item.uuid, version);\n    if(version === \"001\") {\n      var authHash = await this.crypto.hmac256(ciphertext, ak);\n      params.auth_hash = authHash;\n    }\n\n    params.content = ciphertext;\n    return params;\n  }\n\n  encryptionComponentsFromString(string, encryptionKey, authKey) {\n    var encryptionVersion = string.substring(0, 3);\n    if(encryptionVersion === \"001\") {\n      return {\n        contentCiphertext: string.substring(3, string.length),\n        encryptionVersion: encryptionVersion,\n        ciphertextToAuth: string,\n        iv: null,\n        authHash: null,\n        encryptionKey: encryptionKey,\n        authKey: authKey\n      }\n    } else {\n      let components = string.split(\":\");\n      return {\n        encryptionVersion: components[0],\n        authHash: components[1],\n        uuid: components[2],\n        iv: components[3],\n        contentCiphertext: components[4],\n        ciphertextToAuth: [components[0], components[2], components[3], components[4]].join(\":\"),\n        encryptionKey: encryptionKey,\n        authKey: authKey\n      }\n    }\n  }\n\n  async decryptItem(item, keys) {\n\n    if(typeof item.content != \"string\") {\n      // Content is already an object, can't do anything with it.\n      return;\n    }\n\n    if(item.content.startsWith(\"000\")) {\n      // is base64 encoded\n      try {\n        item.content = JSON.parse(await this.crypto.base64Decode(item.content.substring(3, item.content.length)));\n      } catch (e) {}\n\n      return;\n    }\n\n    if(!item.enc_item_key) {\n      // This needs to be here to continue, return otherwise\n      console.log(\"Missing item encryption key, skipping decryption.\");\n      return;\n    }\n\n    // decrypt encrypted key\n    var encryptedItemKey = item.enc_item_key;\n    var requiresAuth = true;\n    if(!encryptedItemKey.startsWith(\"002\") && !encryptedItemKey.startsWith(\"003\")) {\n      // legacy encryption type, has no prefix\n      encryptedItemKey = \"001\" + encryptedItemKey;\n      requiresAuth = false;\n    }\n    var keyParams = this.encryptionComponentsFromString(encryptedItemKey, keys.mk, keys.ak);\n\n    // return if uuid in auth hash does not match item uuid. Signs of tampering.\n    if(keyParams.uuid && keyParams.uuid !== item.uuid) {\n      console.error(\"Item key params UUID does not match item UUID\");\n      if(!item.errorDecrypting) { item.errorDecryptingValueChanged = true;}\n      item.errorDecrypting = true;\n      return;\n    }\n\n    var item_key = await this.crypto.decryptText(keyParams, requiresAuth);\n\n    if(!item_key) {\n      if(!item.errorDecrypting) { item.errorDecryptingValueChanged = true;}\n      item.errorDecrypting = true;\n      return;\n    }\n\n    // decrypt content\n    var ek = await this.crypto.firstHalfOfKey(item_key);\n    var ak = await this.crypto.secondHalfOfKey(item_key);\n    var itemParams = this.encryptionComponentsFromString(item.content, ek, ak);\n\n    // return if uuid in auth hash does not match item uuid. Signs of tampering.\n    if(itemParams.uuid && itemParams.uuid !== item.uuid) {\n      if(!item.errorDecrypting) { item.errorDecryptingValueChanged = true;}\n      item.errorDecrypting = true;\n      return;\n    }\n\n    if(!itemParams.authHash) {\n      // legacy 001\n      itemParams.authHash = item.auth_hash;\n    }\n\n    var content = await this.crypto.decryptText(itemParams, true);\n    if(!content) {\n      if(!item.errorDecrypting) { item.errorDecryptingValueChanged = true;}\n      item.errorDecrypting = true;\n    } else {\n      if(item.errorDecrypting == true) { item.errorDecryptingValueChanged = true;}\n       // Content should only be set if it was successfully decrypted, and should otherwise remain unchanged.\n      item.errorDecrypting = false;\n      item.content = content;\n    }\n  }\n\n  async decryptMultipleItems(items, keys, throws) {\n    let decrypt = async (item) => {\n      // 4/15/18: Adding item.content == null clause. We still want to decrypt deleted items incase\n      // they were marked as dirty but not yet synced. Not yet sure why we had this requirement.\n      if(item.deleted == true && item.content == null) {\n        return;\n      }\n\n      var isString = typeof item.content === 'string' || item.content instanceof String;\n      if(isString) {\n        try {\n          await this.decryptItem(item, keys);\n        } catch (e) {\n          if(!item.errorDecrypting) { item.errorDecryptingValueChanged = true;}\n          item.errorDecrypting = true;\n          if(throws) {\n            throw e;\n          }\n          console.error(\"Error decrypting item\", item, e);\n          return;\n        }\n      }\n    }\n\n    return Promise.all(items.map((item) => {\n      return decrypt(item);\n    }));\n\n  }\n}\n;export class StandardFile {\n  constructor(cryptoInstance) {\n    // This library runs in native environments as well (react native)\n    if(typeof window !== 'undefined' && typeof document !== 'undefined') {\n      // detect IE8 and above, and edge.\n      // IE and Edge do not support pbkdf2 in WebCrypto, therefore we need to use CryptoJS\n      var IEOrEdge = document.documentMode || /Edge/.test(navigator.userAgent);\n\n      if(cryptoInstance) {\n        this.crypto = cryptoInstance;\n      } else if(!IEOrEdge && (window.crypto && window.crypto.subtle)) {\n        this.crypto = new SFCryptoWeb();\n      } else {\n        this.crypto = new SFCryptoJS();\n      }\n    }\n\n    this.itemTransformer = new SFItemTransformer(this.crypto);\n\n    this.crypto.SFJS = {\n      version : this.version(),\n      defaultPasswordGenerationCost : this.defaultPasswordGenerationCost()\n    }\n  }\n\n  version() {\n    return \"003\";\n  }\n\n  supportsPasswordDerivationCost(cost) {\n    // some passwords are created on platforms with stronger pbkdf2 capabilities, like iOS,\n    // which CryptoJS can't handle here (WebCrypto can however).\n    // if user has high password cost and is using browser that doesn't support WebCrypto,\n    // we want to tell them that they can't login with this browser.\n    if(cost > 5000) {\n      return this.crypto instanceof SFCryptoWeb;\n    } else {\n      return true;\n    }\n  }\n\n  // Returns the versions that this library supports technically.\n  supportedVersions() {\n    return [\"001\", \"002\", \"003\"];\n  }\n\n  isVersionNewerThanLibraryVersion(version) {\n    var libraryVersion = this.version();\n    return parseInt(version) > parseInt(libraryVersion);\n  }\n\n  isProtocolVersionOutdated(version) {\n    // YYYY-MM-DD\n    let expirationDates = {\n      \"001\" : Date.parse(\"2018-01-01\"),\n      \"002\" : Date.parse(\"2020-01-01\"),\n    }\n\n    let date = expirationDates[version];\n    if(!date) {\n      // No expiration date, is active version\n      return false;\n    }\n    let expired = new Date() > date;\n    return expired;\n  }\n\n  costMinimumForVersion(version) {\n    return {\n      \"001\" : 3000,\n      \"002\" : 3000,\n      \"003\" : 110000\n    }[version];\n  }\n\n  defaultPasswordGenerationCost() {\n    return this.costMinimumForVersion(this.version());\n  }\n\n}\n\nif(typeof window !== 'undefined' && window !== null) {\n  // window is for some reason defined in React Native, but throws an exception when you try to set to it\n  try {\n    window.StandardFile = StandardFile;\n    window.SFJS = new StandardFile();\n    window.SFCryptoWeb = SFCryptoWeb;\n    window.SFCryptoJS = SFCryptoJS;\n    window.SFItemTransformer = SFItemTransformer;\n    window.SFModelManager = SFModelManager;\n    window.SFItem = SFItem;\n    window.SFItemParams = SFItemParams;\n  } catch (e) {\n    console.log(\"Exception while exporting window variables\", e);\n  }\n}\n"]}